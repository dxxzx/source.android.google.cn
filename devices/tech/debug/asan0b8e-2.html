<!doctype html>
<html  lang="zh_cn">
  
<!-- Mirrored from source.android.google.cn/devices/tech/debug/asan?hl=zh-cn by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 16 Mar 2019 20:39:16 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
          
<title>AddressSanitizer &nbsp;|&nbsp; Android Open Source Project</title>

<meta property="og:title" content="AddressSanitizer &nbsp;|&nbsp; Android Open Source Project">

  <meta property="og:url" content="asan.html">

  <meta property="og:locale" content="zh_cn">


    
    
    
  
        <meta property="og:site_name" content="Android Open Source Project">
    <meta property="og:type" content="website">
    
          <meta name="theme-color" content="#78c257">
    
    <meta charset="utf-8">
    <meta content="IE=Edge" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="../../../_pwa/androidsource/manifest.json">
    <link rel="preconnect" href="http://www.gstatic.com/" crossorigin>
    <link rel="preconnect" href="http://fonts.gstatic.com/" crossorigin>
    <link rel="preconnect" href="http://fonts.googleapis.com/" crossorigin>
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:300,400,400italic,500,500italic,700,700italic|Roboto+Mono:400,500,700|Material+Icons">
    <link rel="stylesheet" href="https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/css/app.css">
    <noscript>
      <link rel="stylesheet" href="https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/css/ce_bundle.css">
    </noscript>
    <link rel="shortcut icon" href="https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/images/favicon.png">
    <link rel="apple-touch-icon" href="https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/images/touchicon-180.png"><link rel="canonical" href="asan.html"></head>
  <body type="article"
        theme="androidsource-theme"
        class=""
        
        layout="docs"
        pending>
    <devsite-progress type="indeterminate" id="app-progress"></devsite-progress>
    <div class="devsite-wrapper"><devsite-header ds-is="header" keep-tabs-visible>
      








<div class="devsite-header--inner">
  <div class="devsite-top-logo-row-wrapper-wrapper">
    <div class="devsite-top-logo-row-wrapper">
      <div class="devsite-top-logo-row">
        <button type="button" id="devsite-hamburger-menu"
          class="devsite-header-icon-button button-flat material-icons gc-analytics-event"
          data-category="Site-Wide Custom Events"
          data-label="Navigation menu button"
          visually-hidden
          aria-label="Close menu">
        </button>
        <div class="devsite-product-name-wrapper">
  <a href="../../../index0b8e.html?hl=zh-cn" class="devsite-site-logo-link gc-analytics-event"
   data-category="Site-Wide Custom Events" data-label="Site logo">
  <img src="https://www.gstatic.cn/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/images/lockup.svg" class="devsite-site-logo" alt="Android Open Source Project">
</a>
            <span class="devsite-product-name">
            <ul class="devsite-breadcrumb-list">
    <li class="devsite-breadcrumb-item">
                              </li>
  </ul>
          </span>
        
</div>        <div class="devsite-top-logo-row-middle">
          <div class="devsite-header-upper-tabs">
                          <devsite-tabs ds-is="tabs" class="upper-tabs">
  <div class="devsite-tabs-wrapper">
                  <tab >
          <a href="../../../setup0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="设置"
           data-category="Site-Wide Custom Events"
        data-label="Tab: 设置"
   >
  设置
</a>

        </tab>
                        <tab >
          <a href="../../../compatibility0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="设计"
           data-category="Site-Wide Custom Events"
        data-label="Tab: 设计"
   >
  设计
</a>

        </tab>
                        <tab active>
          <a href="../../../security0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="安全性"
   aria-label="安全性, selected"         data-category="Site-Wide Custom Events"
        data-label="Tab: 安全性"
   >
  安全性
</a>

        </tab>
                        <tab >
          <a href="../../audio0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="开发"
           data-category="Site-Wide Custom Events"
        data-label="Tab: 开发"
   >
  开发
</a>

        </tab>
                        <tab >
          <a href="../dalvik0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="配置"
           data-category="Site-Wide Custom Events"
        data-label="Tab: 配置"
   >
  配置
</a>

        </tab>
                        <tab >
          <a href="../../../reference0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="参考"
           data-category="Site-Wide Custom Events"
        data-label="Tab: 参考"
   >
  参考
</a>

        </tab>
            </div>
</devsite-tabs>

                       </div>
          <devsite-search ds-is="search"
            enable-suggestions
                  project-path="">
  <form class="devsite-search-form" action="https://source.android.google.cn/s/results/?hl=zh-cn" method="GET">
    <div class="devsite-search-container">
      <div id="searchbox" class="devsite-searchbox">
                <input placeholder="搜索"
          type="text"
          class="devsite-search-field devsite-search-query"
          name="q"
          value=""
          autocomplete="off"
                    aria-label="搜索框">
        <div class="devsite-search-image material-icons"></div>
      </div>
      <button type="button"
              search-open
              class="devsite-search-button devsite-header-icon-button button-flat material-icons"
              aria-label="Open search box"></button>
    </div>
  </form>
  <button type="button"
          search-close
          class="devsite-search-button devsite-header-icon-button button-flat material-icons"
          aria-label="Close search box"></button>
</devsite-search>

        </div>

                <a class="devsite-header-link devsite-top-button button gc-analytics-event"
           href="http://android-review.googlesource.com/"
           data-category="Site-Wide Custom Events"
           data-label="Site header link">
          转到源代码
        </a>
                      </div>    </div>  </div>
  <div class="devsite-collapsible-section
    ">
    <div class="devsite-header-background">
                        <div class="devsite-product-id-row">
            <div class="devsite-product-description-row">
                              <ul class="devsite-breadcrumb-list">
    <li class="devsite-breadcrumb-item">
                    <a href="../../../security0b8e.html?hl=zh-cn"              class="devsite-breadcrumb-link gc-analytics-event"
              data-category="Site-Wide Custom Events"
              data-label="Lower Header"
              data-value="1"
          >
            安全性
      
  </a>
        </li>
  </ul>
                                        </div>
                                                                                    </div>
                                      <div class="devsite-doc-set-nav-row">
                              <devsite-tabs ds-is="tabs" class="lower-tabs">
  <div class="devsite-tabs-wrapper">
                  <tab >
          <a href="../../../security0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="概览"
           data-category="Site-Wide Custom Events"
        data-label="Tab: 概览"
   >
  概览
</a>

        </tab>
                        <tab >
          <a href="../../../security/bulletin0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="公告"
           data-category="Site-Wide Custom Events"
        data-label="Tab: 公告"
   >
  公告
</a>

        </tab>
                        <tab >
          <a href="../../../security/app-sandbox0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="功能"
           data-category="Site-Wide Custom Events"
        data-label="Tab: 功能"
   >
  功能
</a>

        </tab>
                        <tab active>
          <a href="fuzz-sanitize0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="测试"
   aria-label="测试, selected"         data-category="Site-Wide Custom Events"
        data-label="Tab: 测试"
   >
  测试
</a>

        </tab>
                        <tab >
          <a href="../../../security/best-practices0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="最佳做法"
           data-category="Site-Wide Custom Events"
        data-label="Tab: 最佳做法"
   >
  最佳做法
</a>

        </tab>
            </div>
</devsite-tabs>

        </div>
          </div>  </div></div>
  

  </devsite-header>      <devsite-book-nav ds-is="book-nav" scrollbars >
                  

<nav class="devsite-book-nav devsite-nav nocontent">
  <div class="devsite-mobile-header">
    <button type="button"
            id="devsite-close-nav"
            class="devsite-header-icon-button button-flat material-icons gc-analytics-event"
            data-category="Site-Wide Custom Events"
            data-label="Close navigation"
            aria-label="Close navigation">
    </button>
  </div>

  <div class="devsite-book-nav-wrapper">
    <div class="devsite-mobile-nav-top">
              <ul class="devsite-nav-list">
                      <li class="devsite-nav-item">
                                <a href="../../../setup.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 设置">
      <span class="devsite-nav-text" >设置</span>
        </a>
  
                                        </li>
                      <li class="devsite-nav-item">
                                <a href="../../../compatibility.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 设计">
      <span class="devsite-nav-text" >设计</span>
        </a>
  
                                        </li>
                      <li class="devsite-nav-item">
                                <a href="../../../security.html"
          class="devsite-nav-title gc-analytics-event
            devsite-nav-active"
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 安全性">
      <span class="devsite-nav-text" >安全性</span>
        </a>
  
                                            <ul class="devsite-nav-responsive-tabs">
                                                                                                                      <li class="devsite-nav-item">
    <a href="../../../security.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 概览">
      <span class="devsite-nav-text" >概览</span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="../../../security/bulletin.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 公告">
      <span class="devsite-nav-text" >公告</span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="../../../security/app-sandbox.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 功能">
      <span class="devsite-nav-text" >功能</span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="fuzz-sanitize.html"
     id="devsite-nav-forward"     class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 测试">
      <span class="devsite-nav-text" menu="_book">测试</span>
        <span class="devsite-nav-icon material-icons" data-icon="forward"
          menu="_book">
    </span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="../../../security/best-practices.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 最佳做法">
      <span class="devsite-nav-text" >最佳做法</span>
        </a>
  </li>

                                  </ul>
                          </li>
                      <li class="devsite-nav-item">
                                <a href="../../audio.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 开发">
      <span class="devsite-nav-text" >开发</span>
        </a>
  
                                        </li>
                      <li class="devsite-nav-item">
                                <a href="../dalvik.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 配置">
      <span class="devsite-nav-text" >配置</span>
        </a>
  
                                        </li>
                      <li class="devsite-nav-item">
                                <a href="../../../reference.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 参考">
      <span class="devsite-nav-text" >参考</span>
        </a>
  
                                        </li>
                                <li class="devsite-nav-item">
    <a href="http://android-review.googlesource.com/"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 转到源代码">
      <span class="devsite-nav-text" >转到源代码</span>
        </a>
  </li>

                  </ul>
          </div>
          <div class="devsite-mobile-nav-bottom">
                                      <ul class="devsite-nav-list" menu="_book">
                                    <li class="devsite-nav-item"><a href="fuzz-sanitize.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="概览">概览</span></a></li>
                          <li class="devsite-nav-item"><a href="asan.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="AddressSanitizer">AddressSanitizer</span></a></li>
                          <li class="devsite-nav-item"><a href="sanitizers-2.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="LLVM 排错程序">LLVM 排错程序</span></a></li>
                          <li class="devsite-nav-item"><a href="kasan-kcov.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="使用 KASAN + KCOV 编译内核">使用 KASAN + KCOV 编译内核</span></a></li>
                          <li class="devsite-nav-item"><a href="libfuzzer.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="通过 libFuzzer 进行模糊测试">通过 libFuzzer 进行模糊测试</span></a></li>
                          <li class="devsite-nav-item"><a href="cfi.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="控制流完整性 (CFI)">控制流完整性 (CFI)</span></a></li>
                          <li class="devsite-nav-item"><a href="kcfi.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="内核 CFI">内核 CFI</span></a></li>
                          <li class="devsite-nav-item"><a href="intsan.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="整数溢出清理">整数溢出清理</span></a></li>
                      </ul>
                                                                                                                                                                            </div>
      </div>
</nav>
              </devsite-book-nav>
      <div id="gc-wrapper">
        <div class="devsite-main-content"
            has-book-nav            has-toc>
          <devsite-toc ds-is="toc" class="devsite-nav"
            ></devsite-toc>
          <devsite-content ds-is="content">
                          

<article class="devsite-article">
  <article class="devsite-article-inner">    
    <div class="devsite-article-meta">
      <ul class="devsite-breadcrumb-list">
    <li class="devsite-breadcrumb-item">
                    <a href="../../../index0b8e.html?hl=zh-cn"              class="devsite-breadcrumb-link gc-analytics-event"
              data-category="Site-Wide Custom Events"
              data-label="Breadcrumbs"
              data-value="1"
          >
            AOSP
      
  </a>
        </li>
    <li class="devsite-breadcrumb-item">
                <div class="devsite-breadcrumb-guillemet material-icons"></div>
                    <a href="../../../security0b8e.html?hl=zh-cn"              class="devsite-breadcrumb-link gc-analytics-event"
              data-category="Site-Wide Custom Events"
              data-label="Breadcrumbs"
              data-value="2"
          >
            安全性
      
  </a>
        </li>
    <li class="devsite-breadcrumb-item">
                <div class="devsite-breadcrumb-guillemet material-icons"></div>
                    <a href="fuzz-sanitize0b8e.html?hl=zh-cn"              class="devsite-breadcrumb-link gc-analytics-event"
              data-category="Site-Wide Custom Events"
              data-label="Breadcrumbs"
              data-value="3"
          >
            测试
      
  </a>
        </li>
  </ul>
               <devsite-page-rating position="header" selected-rating="0" hover-rating-star="0">
         </devsite-page-rating>
          </div>

              <h1 class="devsite-page-title">AddressSanitizer</h1>
    
    <devsite-toc ds-is="toc" class="devsite-nav" devsite-toc-embedded
                 ></devsite-toc>

    <div class="devsite-article-body clearfix
      ">

              
  <!--
      Copyright 2017 The Android Open Source Project

      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.
  -->

<p>AddressSanitizer (ASan) 是一种基于编译器的快速检测工具，用于检测原生代码中的内存错误。它与 Valgrind（Memcheck 工具）相差不大，但 ASan 具备以下独有特性：</p>

<ul>
  <li>+ 会检测堆栈和全局对象是否有溢出
  </li><li>- 不检测未初始化的读取和内存泄露
  </li><li>+ 速度更快（与 Valgrind 的 20-100x 倍速设置相差 2-3 倍）
  </li><li>+ 内存占用空间较少
</li></ul>

<p>本文档介绍了如何使用 AddressSanitizer 来编译和运行 Android 平台的各个组成部分。如果您希望利用 AddressSanitizer 编译独立的（即 SDK/NDK）应用，请改为参阅 <a href="https://github.com/google/sanitizers/wiki/AddressSanitizerOnAndroid">AddressSanitizerOnAndroid</a> 公共项目网站。</p>

<p>AddressSanitizer 包括一个编译器 (<code>external/clang</code>) 和一个运行时库 (<code>external/compiler-rt/lib/asan</code>)。</p>

<p class="note"><strong>注意</strong>：使用最新的 master 分支即可使用 <a href="#sanitize_target">SANITIZE_TARGET</a> 功能，并能够使用 AddressSanitizer 一次性编译整个 Android 平台。否则，您将只能使用 <code>LOCAL_SANITIZE</code>。</p>

<h2 id="building_with_clang">使用 Clang 编译</h2>

<p>要编译可通过 ASan 进行测试的二进制文件，第一步是要确保您的代码是使用 Clang 编译的。ASan 的 master 分支会默认执行这一步骤，因此您无需执行任何操作。如果您认为自己要测试的模块是使用 GCC 编译的，则可以向编译规则中添加 <code>LOCAL_CLANG:=true</code>，从而切换至 Clang。Clang 也许可以发现 GCC 遗漏的代码错误。</p>

<h2 id="building_executables_with_addresssanitizer">使用 AddressSanitizer 编译可执行文件</h2>

<p>将 <code>LOCAL_SANITIZE:=address</code> 添加到可执行文件的编译规则中。</p>

<pre class="devsite-click-to-copy">
LOCAL_SANITIZE:=address
</pre>

<p>检测到错误时，ASan 会向标准输出和 <code>logcat</code> 发送一份详细报告，然后让相应进程崩溃。</p>

<h2 id="building_shared_libraries_with_addresssanitizer">使用 AddressSanitizer 编译共享库</h2>

<p>根据 ASan 的工作原理，不是通过 ASan 编译的可执行文件将无法使用通过 ASan 编译的库。</p>

<p class="note"><strong>注意</strong>：在运行时，如果将 ASan 库加载到错误的进程中，系统将显示以 <code>_asan</code> 或 <code>_sanitizer</code> 开头的消息，提示您有无法解析的符号。</p>

<p>要对多个可执行文件（并非所有这些可执行文件都是使用 ASan 编译的）使用的共享库进行测试，您需要该库的 2 个副本。为此，建议您针对相应的模块向 <code>Android.mk</code> 中添加以下内容：</p>

<pre class="devsite-click-to-copy">
LOCAL_SANITIZE:=address
LOCAL_MODULE_RELATIVE_PATH := asan
</pre>

<p>这样一来，系统会将库放置到 <code>/system/lib/asan</code>（而非 <code>/system/lib</code>）中。然后，使用以下方法运行您的可执行文件：<code>LD_LIBRARY_PATH=/system/lib/asan</code></p>

<p>对于系统守护程序，将以下内容添加到 <code>/init.rc</code> 或 <code>/init.$device$.rc</code> 的相应部分。</p>

<pre class="devsite-click-to-copy">
setenv LD_LIBRARY_PATH /system/lib/asan
</pre>

<p class="warning"><strong>警告</strong>：<code>LOCAL_MODULE_RELATIVE_PATH</code> 设置会将您的库<strong>移至</strong> <code>/system/lib/asan</code>，这意味着，如果从头开始重写并重新编译，将会导致 <code>/system/lib</code> 中缺少该库，并且生成的映像可能会无法启动。这是当前编译系统存在的一个令人遗憾的限制。请不要重写；而是执行 <code>make -j $N</code> 和 <code>adb
sync</code>。</p>

<p>通过读取 <code>/proc/$PID/maps</code>，验证相应进程使用的库是否来自 <code>/system/lib/asan</code>（如果此库存在）。如果不是，您可能需要停用 SELinux，如下所示：</p>

<pre class="devsite-click-to-copy">
<code class="devsite-terminal">adb root</code>
<code class="devsite-terminal">adb shell setenforce 0</code>
# restart the process with adb shell kill $PID
# if it is a system service, or may be adb shell stop; adb shell start.
</pre>

<h2 id="better_stack_traces">更出色的堆栈跟踪</h2>

<p>AddressSanitizer 使用基于帧指针的快速展开程序 (unwinder)，根据程序中的每个内存分配和取消分配事件来记录堆栈跟踪信息。Android 的大部分组件都未使用帧指针进行编译。因此，您通常仅会获得 1 个或 2 个有意义的帧。要解决此问题，请使用 ASan（推荐）或以下选项重新编译库：</p>

<pre class="devsite-click-to-copy">
LOCAL_CFLAGS:=-fno-omit-frame-pointer
LOCAL_ARM_MODE:=arm
</pre>

<p>或者在进程环境中设置 <code>ASAN_OPTIONS=fast_unwind_on_malloc=0</code>。后者可能对 CPU 要求极高，具体取决于负载。</p>

<h2 id="symbolization">符号化</h2>

<p>最初，ASan 报告中包含对二进制文件和共享库中的偏移量的引用。您可以通过以下两种方法获取源文件和行信息：</p>

<ul>
  <li>确保 <code>/system/bin</code> 中有 llvm-symbolizer 二进制文件。Llvm-symbolizer 根据 <code>third_party/llvm/tools/llvm-symbolizer</code> 中的源文件进行编译 </li><li>通过 <code>external/compiler-rt/lib/asan/scripts/symbolize.py</code> 脚本过滤报告。
</li></ul>

<p>由于可以使用主机上的符号化库，因此第二种方法可以提供更多数据（即 file:line 位置）。</p>

<h2 id="addresssanitizer_in_the_apps">在应用中使用 AddressSanitizer</h2>

<p>AddressSanitizer 无法检查 Java 代码，但可以检测 JNI 库中的错误。为此，您需要使用 ASan 编译可执行文件（在这种情况下是 <code>/system/bin/app_process(<em>32|64</em>)</code>）。这将在设备上的所有应用中同时启用 ASan，因而会给设备带来一些压力，但 2GB RAM 的设备可以从容处理这种情况。</p>

<p>向 <code>LOCAL_SANITIZE:=address</code> 中的 app_process 编译规则添加常规的 <code>frameworks/base/cmds/app_process</code>。暂时忽略同一个文件中的 <code>app_process__asan</code> 目标（如果在您阅读该文件时这个目标仍存在于其中）。在 <code>system/core/rootdir/init.zygote(<em>32|64</em>).rc</code> 中修改 Zygote 记录，以添加以下行：</p>

<pre class="devsite-click-to-copy">
setenv LD_LIBRARY_PATH /system/lib/asan:/system/lib
setenv ASAN_OPTIONS
allow_user_segv_handler=true
</pre>

<p>编译，然后依次执行以下命令：adb sync、fastboot flash boot、reboot。</p>

<h2 id="using_the_wrap_property">使用 wrap 属性</h2>

<p>上一部分中的方法将 AddressSanitizer 放置到了系统的每个应用中（实际上是放置到了 Zygote 进程的每个子项中）。您可以只通过 ASan 运行一个或少数几个应用，从而节省一些内存空间，但是应用启动速度会变慢。</p>

<p>为实现这一目标，您可以通过“wrap.”属性（与在 Valgrind 下运行应用时所用的属性相同）启动应用。下面是在 ASan 下运行 Gmail 应用的示例：</p>

<pre class="devsite-click-to-copy">
<code class="devsite-terminal">adb root</code>
<code class="devsite-terminal">adb shell setenforce 0  # disable SELinux</code>
<code class="devsite-terminal">adb shell setprop wrap.com.google.android.gm "asanwrapper"</code>
</pre>

<p>在此情况下，asanwrapper 会将 <code>/system/bin/app_process</code> 重写至（使用 AddressSanitizer 编译的）<code>/system/bin/asan/app_process</code>。此外，它还会在动态库搜索路径的开头处添加 <code>/system/lib/asan</code>。这样一来，通过 asanwrapper 运行应用时，系统会优先使用 <code>/system/lib/asan</code> 中可通过 ASan 进行测试的库，而非 <code>/system/lib</code> 中的普通库。</p>

<p>同样，如果发现错误，应用会崩溃，且系统会将报告记录到日志中。</p>

<h2 id="sanitize_target">SANITIZE_TARGET</h2>

<p>master 分支支持使用 AddressSanitizer 一次性编译整个 Android 平台。</p>

<p>在同一编译树中运行以下命令。</p>

<pre class="devsite-click-to-copy">
<code class="devsite-terminal">make -j42</code>
<code class="devsite-terminal">SANITIZE_TARGET=address make -j42</code>
</pre>

<p>在此模式下，<code>userdata.img</code> 中包含其他库，必须也刷写到设备上。请使用以下命令行：</p>

<pre class="devsite-terminal devsite-click-to-copy">
fastboot flash userdata &amp;&amp; fastboot flashall
</pre>

<p>写入时，现今的 Nexus 和 Pixel 设备会启动到该模式中的界面。</p>

<p>其工作原理是编译两组共享库：<code>/system/lib</code> 中的常规库（第一次 make 调用），<code>/data/asan/lib</code> 中可通过 ASan 进行测试的库（第二次 make 调用）。第二次编译出的可执行文件会覆盖第一次编译出的可执行文件。通过使用 PT_INTERP 中的“/system/bin/linker_asan”，可通过 ASan 进行测试的可执行文件会获得一个不同的库搜索路径（在该路径中，<code>/data/asan/lib</code> 前面添加了 <code>/system/lib</code>）。</p>

<p><code>$SANITIZE_TARGET</code> 的值变更时，编译系统会重写中间对象目录。这样一来，系统便会强制重新编译所有目标，同时保留 <code>/system/lib</code> 下已安装的二进制文件。</p>

<p>以下目标不能使用 ASan 进行编译：</p>

<ul>
  <li>静态关联的可执行文件。
  </li><li><code>LOCAL_CLANG:=false</code> 目标
  </li><li>不会针对 <code>SANITIZE_TARGET=address</code> 进行 ASan 操作的 <code>LOCAL_SANITIZE:=false</code>
</li></ul>

<p>在 SANITIZE_TARGET 编译中，系统会跳过此类可执行文件，且会将第一次 make 调用中编译的版本留在 <code>/system/bin</code> 中。</p>

<p>此类库只是未使用 ASan 进行编译，但它们仍然可包含来自其依赖的静态库的 ASan 代码。</p>

<h2 id="supporting_documentation">支持文档</h2>

<p><a href="https://github.com/google/sanitizers/wiki/AddressSanitizerOnAndroid">AddressSanitizerOnAndroid</a> 公共项目网站</p>
<p><a href="https://www.chromium.org/developers/testing/addresssanitizer">AddressSanitizer 和 Chromium</a></p>
<p><a href="https://github.com/google/sanitizers">其他 Google 排错程序</a></p>


          </div>

    
                   <devsite-page-rating position="footer" selected-rating="0" hover-rating-star="0">
         </devsite-page-rating>
                   
          </article>
</article>

<devsite-content-footer ds-is="content-footer" class="nocontent">
  <p>Content and code samples on this page are subject to the licenses described in the <a href="../../../license0b8e.html?hl=zh-cn">Content License</a>. Java is a registered trademark of Oracle and/or its affiliates.</p>
</devsite-content-footer>


                      </devsite-content>
        </div>
        <devsite-footer-promos ds-is="footer-promos" class="devsite-footer">
                      
                  </devsite-footer-promos>
        <devsite-footer-linkboxes ds-is="footer-linkboxes" class="devsite-footer">
                      <nav class="devsite-footer-linkboxes nocontent">
  <ul class="devsite-footer-linkboxes-list">
        <li class="devsite-footer-linkbox ">
    <h3 class="devsite-footer-linkbox-heading">构建</h3>      <ul class="devsite-footer-linkbox-list">
                <li class="devsite-footer-linkbox-item">
          <a href="http://android.googlesource.com/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 1)"           >
            Android 代码库
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="../../../setup/build/requirements.html"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 2)"           >
            要求
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="../../../setup/build/downloading.html"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 3)"           >
            下载
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://developers.google.com/android/blobs-preview/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 4)"           >
            预览二进制文件
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://developers.google.com/android/images/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 5)"           >
            出厂映像
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://developers.google.com/android/drivers/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 6)"           >
            驱动程序二进制文件
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://android.github.io/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 7)"           >
            GitHub
          </a>
        </li>
              </ul>
    </li>
        <li class="devsite-footer-linkbox ">
    <h3 class="devsite-footer-linkbox-heading">关注</h3>      <ul class="devsite-footer-linkbox-list">
                <li class="devsite-footer-linkbox-item">
          <a href="http://twitter.com/Android/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 1)"           >
            在 Twitter 上 @Android
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://twitter.com/AndroidDev/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 2)"           >
            在 Twitter 上 @AndroidDev
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://blog.google/products/android/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 3)"           >
            Android 博客
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://security.googleblog.com/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 4)"           >
            Google 安全博客
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://groups.google.com/forum/?fromgroups#!forum/android-platform/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 5)"           >
            Google 网上论坛上的 Android 平台论坛
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://groups.google.com/forum/?fromgroups#!forum/android-building/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 6)"           >
            Google 网上论坛上的 Android 构建论坛
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://groups.google.com/forum/?fromgroups#!forum/android-porting/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 7)"           >
            Google 网上论坛上的 Android 移植论坛
          </a>
        </li>
              </ul>
    </li>
        <li class="devsite-footer-linkbox ">
    <h3 class="devsite-footer-linkbox-heading">获取帮助</h3>      <ul class="devsite-footer-linkbox-list">
                <li class="devsite-footer-linkbox-item">
          <a href="http://support.google.com/android/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 1)"           >
            Android 帮助中心
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://support.google.com/pixelphone/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 2)"           >
            Pixel 帮助中心
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://support.google.com/nexus/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 3)"           >
            Nexus 帮助中心
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://www.android.com/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 4)"           >
            www.android.com
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://www.android.com/gms/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 5)"           >
            Google Mobile Services
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://stackoverflow.com/questions/tagged/android-source/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 6)"           >
            Stack Overflow
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://issuetracker.google.com/issues?q=status:open%20componentid:190923"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 7)"           >
            问题跟踪器
          </a>
        </li>
              </ul>
    </li>
      </ul>
</nav>
                  </devsite-footer-linkboxes>
        <devsite-footer-utility ds-is="footer-utility" class="devsite-footer">
                      <div class="devsite-footer-utility">
  
  <nav class="devsite-nav">
        <ul class="devsite-footer-utility-list">
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="../../../source/index0b8e.html?hl=zh-cn"
           data-category="Site-Wide Custom Events"
           data-label="Footer About Android link">
          关于 Android
        </a>
              </li>
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="../../../source/community0b8e.html?hl=zh-cn"
           data-category="Site-Wide Custom Events"
           data-label="Footer Community link">
          社区
        </a>
              </li>
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="../../../legal0b8e.html?hl=zh-cn"
           data-category="Site-Wide Custom Events"
           data-label="Footer Legal link">
          法律条款
        </a>
              </li>
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="../../../license0b8e.html?hl=zh-cn"
           data-category="Site-Wide Custom Events"
           data-label="Footer License link">
          许可
        </a>
              </li>
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="http://policies.google.cn/privacy?hl=zh-cn"
           data-category="Site-Wide Custom Events"
           data-label="Footer Privacy link">
          隐私权政策
        </a>
              </li>
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="http://issuetracker.google.com/issues/new?component=191476&amp;hl=zh-cn"
           data-category="Site-Wide Custom Events"
           data-label="Footer Site feedback link">
          网站反馈
        </a>
              </li>
          </ul>
    
        <form class="devsite-footer-utility-language">
      <select class="devsite-footer-utility-language-select"
              name="language"
              track-name="click"
              track-type="languageSelector">
                  <option value="en"
                  track-metadata-original-language="zh_cn"
                  track-metadata-selected-language="en"
                  track-name="changed"
                  track-type="languageSelector"
                  >
            English
          </option>
                  <option value="zh_cn"
                  track-metadata-original-language="zh_cn"
                  track-metadata-selected-language="zh_cn"
                  track-name="changed"
                  track-type="languageSelector"
                  selected="selected">
            简体中文
          </option>
              </select>
    </form>
      </nav>
</div>
                  </devsite-footer-utility>
      </div></div>
    <devsite-sitemask ds-is="site-mask"></devsite-sitemask>
    <devsite-snackbar ds-is="snackbar"                       ></devsite-snackbar>    <devsite-tooltip ds-is="tooltip"
                     blocked-link></devsite-tooltip>
    <devsite-analytics ds-is="analytics">
              <script type="application/json" analytics>[{"metrics": {"ratings_value": "metric1", "ratings_count": "metric2"}, "dimensions": {}, "gaid": "UA-45455297-4"}]</script>
<script type="application/json" gtm>[]</script>
          </devsite-analytics>
    <script>
    (function(d,e,v,E,l,o,p,r,s,_,__){d['GoogleDevelopersObject']=[!0,l,o,p,r,s];
    _=e.createElement(v);_.async=1;_.src=E;__=e.getElementsByTagName(v)[0];
    __.parentNode.insertBefore(_,__);})(window, document, 'script',
      'https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/js/app_loader.js',
      'zh_cn',
      'https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/js/devsite_app.js',
      'https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource',
      !1,
      ['/_pwa/androidsource/manifest.json',
       'https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/images/video-placeholder.svg',
       'https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/images/favicon.png','https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/images/lockup.svg','https://fonts.googleapis.com/css?family=Roboto:300,400,400italic,500,500italic,700,700italic|Roboto+Mono:400,500,700|Material+Icons'],
       'https://androidsource-dot-google-developers.gonglchuangl.net/')
   </script>  </body>

<!-- Mirrored from source.android.google.cn/devices/tech/debug/asan?hl=zh-cn by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 16 Mar 2019 20:39:16 GMT -->
</html>