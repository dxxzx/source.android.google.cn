<!doctype html>
<html  lang="en">
  
<!-- Mirrored from source.android.google.cn/devices/tech/debug/sanitizers by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 16 Mar 2019 14:28:37 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
          
<title>LLVM Sanitizers &nbsp;|&nbsp; Android Open Source Project</title>

<meta property="og:title" content="LLVM Sanitizers &nbsp;|&nbsp; Android Open Source Project">

  <meta property="og:url" content="sanitizers-2.html">

  <meta property="og:locale" content="en">


    
    
    
  
        <meta property="og:site_name" content="Android Open Source Project">
    <meta property="og:type" content="website">
    
          <meta name="theme-color" content="#78c257">
    
    <meta charset="utf-8">
    <meta content="IE=Edge" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="../../../_pwa/androidsource/manifest.json">
    <link rel="preconnect" href="http://www.gstatic.com/" crossorigin>
    <link rel="preconnect" href="http://fonts.gstatic.com/" crossorigin>
    <link rel="preconnect" href="http://fonts.googleapis.com/" crossorigin>
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:300,400,400italic,500,500italic,700,700italic|Roboto+Mono:400,500,700|Material+Icons">
    <link rel="stylesheet" href="https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/css/app.css">
    <noscript>
      <link rel="stylesheet" href="https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/css/ce_bundle.css">
    </noscript>
    <link rel="shortcut icon" href="https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/images/favicon.png">
    <link rel="apple-touch-icon" href="https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/images/touchicon-180.png"><link rel="canonical" href="sanitizers-2.html"></head>
  <body type="article"
        theme="androidsource-theme"
        class=""
        
        layout="docs"
        pending>
    <devsite-progress type="indeterminate" id="app-progress"></devsite-progress>
    <div class="devsite-wrapper"><devsite-header ds-is="header" keep-tabs-visible>
      








<div class="devsite-header--inner">
  <div class="devsite-top-logo-row-wrapper-wrapper">
    <div class="devsite-top-logo-row-wrapper">
      <div class="devsite-top-logo-row">
        <button type="button" id="devsite-hamburger-menu"
          class="devsite-header-icon-button button-flat material-icons gc-analytics-event"
          data-category="Site-Wide Custom Events"
          data-label="Navigation menu button"
          visually-hidden
          aria-label="Close menu">
        </button>
        <div class="devsite-product-name-wrapper">
  <a href="../../../index.html" class="devsite-site-logo-link gc-analytics-event"
   data-category="Site-Wide Custom Events" data-label="Site logo">
  <img src="https://www.gstatic.cn/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/images/lockup.svg" class="devsite-site-logo" alt="Android Open Source Project">
</a>
            <span class="devsite-product-name">
            <ul class="devsite-breadcrumb-list">
    <li class="devsite-breadcrumb-item">
                              </li>
  </ul>
          </span>
        
</div>        <div class="devsite-top-logo-row-middle">
          <div class="devsite-header-upper-tabs">
                          <devsite-tabs ds-is="tabs" class="upper-tabs">
  <div class="devsite-tabs-wrapper">
                  <tab >
          <a href="../../../setup.html"
   class="gc-analytics-event"
   title="Set up"
           data-category="Site-Wide Custom Events"
        data-label="Tab: Set up"
   >
  Set up
</a>

        </tab>
                        <tab >
          <a href="../../../compatibility.html"
   class="gc-analytics-event"
   title="Design"
           data-category="Site-Wide Custom Events"
        data-label="Tab: Design"
   >
  Design
</a>

        </tab>
                        <tab active>
          <a href="../../../security.html"
   class="gc-analytics-event"
   title="Secure"
   aria-label="Secure, selected"         data-category="Site-Wide Custom Events"
        data-label="Tab: Secure"
   >
  Secure
</a>

        </tab>
                        <tab >
          <a href="../../audio.html"
   class="gc-analytics-event"
   title="Develop"
           data-category="Site-Wide Custom Events"
        data-label="Tab: Develop"
   >
  Develop
</a>

        </tab>
                        <tab >
          <a href="../dalvik.html"
   class="gc-analytics-event"
   title="Configure"
           data-category="Site-Wide Custom Events"
        data-label="Tab: Configure"
   >
  Configure
</a>

        </tab>
                        <tab >
          <a href="../../../reference.html"
   class="gc-analytics-event"
   title="Reference"
           data-category="Site-Wide Custom Events"
        data-label="Tab: Reference"
   >
  Reference
</a>

        </tab>
            </div>
</devsite-tabs>

                       </div>
          <devsite-search ds-is="search"
            enable-suggestions
                  project-path="">
  <form class="devsite-search-form" action="https://source.android.google.cn/s/results/" method="GET">
    <div class="devsite-search-container">
      <div id="searchbox" class="devsite-searchbox">
                <input placeholder="Search"
          type="text"
          class="devsite-search-field devsite-search-query"
          name="q"
          value=""
          autocomplete="off"
                    aria-label="Search box">
        <div class="devsite-search-image material-icons"></div>
      </div>
      <button type="button"
              search-open
              class="devsite-search-button devsite-header-icon-button button-flat material-icons"
              aria-label="Open search box"></button>
    </div>
  </form>
  <button type="button"
          search-close
          class="devsite-search-button devsite-header-icon-button button-flat material-icons"
          aria-label="Close search box"></button>
</devsite-search>

        </div>

                <a class="devsite-header-link devsite-top-button button gc-analytics-event"
           href="http://android-review.googlesource.com/"
           data-category="Site-Wide Custom Events"
           data-label="Site header link">
          Go to code
        </a>
                      </div>    </div>  </div>
  <div class="devsite-collapsible-section
    ">
    <div class="devsite-header-background">
                        <div class="devsite-product-id-row">
            <div class="devsite-product-description-row">
                              <ul class="devsite-breadcrumb-list">
    <li class="devsite-breadcrumb-item">
                    <a href="../../../security.html"              class="devsite-breadcrumb-link gc-analytics-event"
              data-category="Site-Wide Custom Events"
              data-label="Lower Header"
              data-value="1"
          >
            Secure
      
  </a>
        </li>
  </ul>
                                        </div>
                                                                                    </div>
                                      <div class="devsite-doc-set-nav-row">
                              <devsite-tabs ds-is="tabs" class="lower-tabs">
  <div class="devsite-tabs-wrapper">
                  <tab >
          <a href="../../../security.html"
   class="gc-analytics-event"
   title="Overview"
           data-category="Site-Wide Custom Events"
        data-label="Tab: Overview"
   >
  Overview
</a>

        </tab>
                        <tab >
          <a href="../../../security/bulletin.html"
   class="gc-analytics-event"
   title="Bulletins"
           data-category="Site-Wide Custom Events"
        data-label="Tab: Bulletins"
   >
  Bulletins
</a>

        </tab>
                        <tab >
          <a href="../../../security/app-sandbox.html"
   class="gc-analytics-event"
   title="Features"
           data-category="Site-Wide Custom Events"
        data-label="Tab: Features"
   >
  Features
</a>

        </tab>
                        <tab active>
          <a href="fuzz-sanitize.html"
   class="gc-analytics-event"
   title="Testing"
   aria-label="Testing, selected"         data-category="Site-Wide Custom Events"
        data-label="Tab: Testing"
   >
  Testing
</a>

        </tab>
                        <tab >
          <a href="../../../security/best-practices.html"
   class="gc-analytics-event"
   title="Best Practices"
           data-category="Site-Wide Custom Events"
        data-label="Tab: Best Practices"
   >
  Best Practices
</a>

        </tab>
            </div>
</devsite-tabs>

        </div>
          </div>  </div></div>
  

  </devsite-header>      <devsite-book-nav ds-is="book-nav" scrollbars >
                  

<nav class="devsite-book-nav devsite-nav nocontent">
  <div class="devsite-mobile-header">
    <button type="button"
            id="devsite-close-nav"
            class="devsite-header-icon-button button-flat material-icons gc-analytics-event"
            data-category="Site-Wide Custom Events"
            data-label="Close navigation"
            aria-label="Close navigation">
    </button>
  </div>

  <div class="devsite-book-nav-wrapper">
    <div class="devsite-mobile-nav-top">
              <ul class="devsite-nav-list">
                      <li class="devsite-nav-item">
                                <a href="../../../setup.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Set up">
      <span class="devsite-nav-text" >Set up</span>
        </a>
  
                                        </li>
                      <li class="devsite-nav-item">
                                <a href="../../../compatibility.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Design">
      <span class="devsite-nav-text" >Design</span>
        </a>
  
                                        </li>
                      <li class="devsite-nav-item">
                                <a href="../../../security.html"
          class="devsite-nav-title gc-analytics-event
            devsite-nav-active"
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Secure">
      <span class="devsite-nav-text" >Secure</span>
        </a>
  
                                            <ul class="devsite-nav-responsive-tabs">
                                                                                                                      <li class="devsite-nav-item">
    <a href="../../../security.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Overview">
      <span class="devsite-nav-text" >Overview</span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="../../../security/bulletin.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Bulletins">
      <span class="devsite-nav-text" >Bulletins</span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="../../../security/app-sandbox.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Features">
      <span class="devsite-nav-text" >Features</span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="fuzz-sanitize.html"
     id="devsite-nav-forward"     class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Testing">
      <span class="devsite-nav-text" menu="_book">Testing</span>
        <span class="devsite-nav-icon material-icons" data-icon="forward"
          menu="_book">
    </span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="../../../security/best-practices.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Best Practices">
      <span class="devsite-nav-text" >Best Practices</span>
        </a>
  </li>

                                  </ul>
                          </li>
                      <li class="devsite-nav-item">
                                <a href="../../audio.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Develop">
      <span class="devsite-nav-text" >Develop</span>
        </a>
  
                                        </li>
                      <li class="devsite-nav-item">
                                <a href="../dalvik.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Configure">
      <span class="devsite-nav-text" >Configure</span>
        </a>
  
                                        </li>
                      <li class="devsite-nav-item">
                                <a href="../../../reference.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Reference">
      <span class="devsite-nav-text" >Reference</span>
        </a>
  
                                        </li>
                                <li class="devsite-nav-item">
    <a href="http://android-review.googlesource.com/"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Go to code">
      <span class="devsite-nav-text" >Go to code</span>
        </a>
  </li>

                  </ul>
          </div>
          <div class="devsite-mobile-nav-bottom">
                                      <ul class="devsite-nav-list" menu="_book">
                                    <li class="devsite-nav-item"><a href="fuzz-sanitize.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Overview">Overview</span></a></li>
                          <li class="devsite-nav-item"><a href="asan.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="AddressSanitizer">AddressSanitizer</span></a></li>
                          <li class="devsite-nav-item"><a href="sanitizers-2.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="LLVM Sanitizers">LLVM Sanitizers</span></a></li>
                          <li class="devsite-nav-item"><a href="kasan-kcov.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Build Kernel with KASAN+KCOV">Build Kernel with KASAN+KCOV</span></a></li>
                          <li class="devsite-nav-item"><a href="libfuzzer.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Fuzzing with libFuzzer">Fuzzing with libFuzzer</span></a></li>
                          <li class="devsite-nav-item"><a href="cfi.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Control Flow Integrity (CFI)">Control Flow Integrity (CFI)</span></a></li>
                          <li class="devsite-nav-item"><a href="kcfi.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Kernel CFI">Kernel CFI</span></a></li>
                          <li class="devsite-nav-item"><a href="intsan.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Integer Overflow Sanitization">Integer Overflow Sanitization</span></a></li>
                      </ul>
                                                                                                                                                                            </div>
      </div>
</nav>
              </devsite-book-nav>
      <div id="gc-wrapper">
        <div class="devsite-main-content"
            has-book-nav            has-toc>
          <devsite-toc ds-is="toc" class="devsite-nav"
            ></devsite-toc>
          <devsite-content ds-is="content">
                          

<article class="devsite-article">
  <article class="devsite-article-inner">    
    <div class="devsite-article-meta">
      <ul class="devsite-breadcrumb-list">
    <li class="devsite-breadcrumb-item">
                    <a href="../../../index.html"              class="devsite-breadcrumb-link gc-analytics-event"
              data-category="Site-Wide Custom Events"
              data-label="Breadcrumbs"
              data-value="1"
          >
            AOSP
      
  </a>
        </li>
    <li class="devsite-breadcrumb-item">
                <div class="devsite-breadcrumb-guillemet material-icons"></div>
                    <a href="../../../security.html"              class="devsite-breadcrumb-link gc-analytics-event"
              data-category="Site-Wide Custom Events"
              data-label="Breadcrumbs"
              data-value="2"
          >
            Secure
      
  </a>
        </li>
    <li class="devsite-breadcrumb-item">
                <div class="devsite-breadcrumb-guillemet material-icons"></div>
                    <a href="fuzz-sanitize.html"              class="devsite-breadcrumb-link gc-analytics-event"
              data-category="Site-Wide Custom Events"
              data-label="Breadcrumbs"
              data-value="3"
          >
            Testing
      
  </a>
        </li>
  </ul>
               <devsite-page-rating position="header" selected-rating="0" hover-rating-star="0">
         </devsite-page-rating>
          </div>

              <h1 class="devsite-page-title">LLVM Sanitizers</h1>
    
    <devsite-toc ds-is="toc" class="devsite-nav" devsite-toc-embedded
                 ></devsite-toc>

    <div class="devsite-article-body clearfix
      ">

              
  <!--
      Copyright 2017 The Android Open Source Project

      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.
  -->

<p>
LLVM, the compiler infrastructure used to build Android, contains multiple
components that perform static and dynamic analysis. Of these components, the
sanitizers—specifically AddressSanitizer and UndefinedBehaviorSanitizer—can be
used extensively to analyze Android. Sanitizers are compiler-based
instrumentation components contained in external/compiler-rt that can be used
during development and testing to push out bugs and make Android better.
Android's current set of sanitizers can discover and diagnose many memory misuse
bugs and potentially dangerous undefined behavior.
</p>
<p>
It's best practice for Android builds to boot and run with sanitizers
enabled, such as AddressSanitizer and UndefinedBehaviorSanitizer. This page
introduces AddressSanitizer, UndefinedBehaviorSanitizer, and
KernelAddressSanitizer, shows how they can be used within the Android build
system, and gives example Android.mk and Android.bp files that build native
components with these sanitizers enabled.
</p>

<h2 id="addresssanitizer">AddressSanitizer</h2>
<p>
<a href="https://clang.llvm.org/docs/AddressSanitizer.html">AddressSanitizer</a>
(ASan) is a compiler-based instrumentation capability that detects many types of
memory errors in C/C++ code at runtime. ASan can detect many classes of memory
errors, including:
</p>
<ul>
  <li>Out-of-bounds memory access</li>
  <li>Double free</li>
  <li>Use-after-free</li>
</ul>
<p>
Android allows for
<a href="asan.html">ASan
instrumentation</a> at the full-build level and the <a
href="asan.html#addresssanitizer_in_the_apps">app
level</a> with asanwrapper.
</p>
<p>
AddressSanitizer combines instrumentation of all memory-related function
calls—including alloca, malloc, and free—and padding all variables and allocated
memory regions with memory that triggers an ASan callback when it is read or
written to.
</p>
<p>
The instrumentation lets ASan detect invalid memory usage bugs, including
double-free, and use-after scope, return, and free, while the memory-region
padding detects out-of-bounds read or writes. If a read or write to this padding
region occurs, ASan catches it and outputs information to help diagnosing the
memory violation, including the call stack, shadow memory map, the type of
memory violation, what was read or written, the instruction that caused the
violation, and the memory contents.
</p>


<pre class="devsite-click-to-copy">
pixel-xl:/ # sanitizer-status                                                                                            
=================================================================
==14164==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x0032000054b0 at pc 0x005df16ffc3c bp 0x007fc236fdf0 sp 0x007fc236fdd0
WRITE of size 1 at 0x0032000054b0 thread T0
    #0 0x5df16ffc3b in test_crash_malloc sanitizer-status/sanitizer-status.c:36:13
    #1 0x5df17004e3 in main sanitizer-status/sanitizer-status.c:76:7
    #2 0x794cf665f3 in __libc_init (/system/lib64/libc.so+0x1b5f3)
    #3 0x5df16ffa53 in do_arm64_start (/system/bin/sanitizer-status+0xa53)

0x0032000054b0 is located 0 bytes to the right of 32-byte region [0x003200005490,0x0032000054b0)
allocated by thread T0 here:
    #0 0x794d0bdc67 in malloc (/system/lib64/libclang_rt.asan-aarch64-android.so+0x74c67)
    #1 0x5df16ffb47 in test_crash_malloc sanitizer-status/sanitizer-status.c:34:25
    #2 0x5df17004e3 in main sanitizer-status/sanitizer-status.c:76:7
    #3 0x794cf665f3 in __libc_init (/system/lib64/libc.so+0x1b5f3)
    #4 0x5df16ffa53 in do_arm64_start (/system/bin/sanitizer-status+0xa53)
    #5 0x794df78893  (&lt;unknown module&gt;)

SUMMARY: AddressSanitizer: heap-buffer-overflow sanitizer-status/sanitizer-status.c:36:13 in test_crash_malloc
</pre>

<p>
Sometimes, the bug discovery process can appear to be non-deterministic,
especially for bugs that require special setup or more advanced techniques, such
as heap priming or race condition exploitation. Many of these bugs are not
immediately apparent, and could surface thousands of instructions away from the
memory violation that was the actual root cause. ASan instruments all
memory-related functions and pads data with areas that cannot be accessed
without triggering an ASan callback. This means that memory violations are
caught the instant they occur, instead of waiting for a crash-inducing
corruption. This is extremely useful in bug discovery and root cause diagnosis.
</p>
<p>
To verify that ASAN is functional on a target device, Android has included the
asan_test executable. The asan_test executable tests and validates the ASAN
functionality on a target device, giving diagnostics messages with the status of
each test. When using an ASAN Android build, it is located in
<code>/data/nativetest/asan_test/asan_test</code> or
<code>/data/nativetest64/asan_test/asan_test</code> by default.
</p>

<h2 id="undefinedbehaviorsanitizer">UndefinedBehaviorSanitizer</h2>
<p>
UndefinedBehaviorSanitizer (UBSan) performs compile-time instrumentation to
check for various types of undefined behavior. While UBSan is capable of
detecting
<a href="https://clang.llvm.org/docs/UndefinedBehaviorSanitizer.html">many
undefined behaviors</a>, Android supports alignment, bool, bounds, enum,
float-cast-overflow, float-divide-by-zero, integer-divide-by-zero,
nonnull-attribute, null, return, returns-nonnull-attribute, shift-base,
shift-exponent, signed-integer-overflow, unreachable, unsigned-integer-overflow,
and vla-bound. unsigned-integer-overflow, while not technically an undefined
behavior, is included in the sanitizer and used in many Android modules,
including the mediaserver components, to eliminate any latent integer-overflow
vulnerabilities.
</p>

<h3 id="ubsan-implementation">Implementation</h3>
<p>
In the Android build system, you can enable UBSan globally or locally. To enable
UBSan globally, set SANITIZE_TARGET in Android.mk. To enable UBSan at a
per-module level, set LOCAL_SANITIZE and specify the undefined behaviors that
you want to look for in Android.mk. For example:
</p>

<pre class="devsite-click-to-copy">LOCAL_PATH:= $(call my-dir)
include $(CLEAR_VARS)

LOCAL_CFLAGS := -std=c11 -Wall -Werror -O0

LOCAL_SRC_FILES:= sanitizer-status.c

LOCAL_MODULE:= sanitizer-status

LOCAL_SANITIZE := alignment bounds null unreachable integer
LOCAL_SANITIZE_DIAG := alignment bounds null unreachable integer

include $(BUILD_EXECUTABLE)
</pre>

<p>
The Android build system does not yet support as detailed diagnostics in
blueprint files as it does makefiles. Here is the closest equivalent written as
a blueprint (Android.bp):
</p>


<pre class="devsite-click-to-copy">cc_binary {

    cflags: [
        "-std=c11",
        "-Wall",
        "-Werror",
        "-O0",
    ],

    srcs: ["sanitizer-status.c"],

    name: "sanitizer-status",

    sanitize: {
        misc_undefined: [
            "alignment",
            "bounds",
            "null",
            "unreachable",
            "integer",
        ],
        diag: {
            undefined : true
        },
    },

}
</pre>

<h3 id="ubsan-shortcuts">UBSan shortcuts</h3>
<p>
Android also has two shortcuts, <code>integer</code> and
<code>default-ub</code>, to enable a set of sanitizers at the same time. integer
enables<code> integer-divide-by-zero</code>,
<code>signed-integer-overflow</code> and <code>unsigned-integer-overflow</code>.
<code>default-ub</code> enables the checks that have minimal compiler
performance issues: bool, integer-divide-by-zero, return,
returns-nonnull-attribute, shift-exponent, unreachable and vla-bound. The
integer sanitizer class can be used with SANITIZE_TARGET and LOCAL_SANITIZE,
while default-ub can only be used with SANITIZE_TARGET.
</p>

<h3 id="better-error-reporting">Better error reporting</h3>
<p>
Android's default UBSan implementation invokes a specified function when
undefined behavior is encountered. By default, this function is abort. However,
starting in October 2016, UBSan on Android has an optional runtime library that
gives more detailed error reporting, including type of undefined behavior
encountered, file and source code line information. To enable this error
reporting with integer checks add the following to an Android.mk file:
</p>


<pre class="devsite-click-to-copy">LOCAL_SANITIZE:=integer
LOCAL_SANITIZE_DIAG:=integer
</pre>

<p>
The LOCAL_SANITIZE value enables the sanitizer during the build.
LOCAL_SANITIZE_DIAG turns on diagnostic mode for the specified sanitizer. It is
possible to set LOCAL_SANITIZE and LOCAL_SANITIZE_DIAG to different values, but
only those checks in LOCAL_SANITIZE are enabled. If a check is not specified in
LOCAL_SANITIZE, but is specified in LOCAL_SANITIZE_DIAG, the check isn't enabled
and diagnostic messages aren't given.
</p>
<p>
Here is an example of the information provided by the UBSan runtime library:
</p>

<pre class="devsite-click-to-copy">pixel-xl:/ # sanitizer-status ubsan
sanitizer-status/sanitizer-status.c:53:6: runtime error: unsigned integer overflow: 18446744073709551615 + 1 cannot be represented in type 'size_t' (aka 'unsigned long')
</pre>

<h2 id="kernel-address-sanitizer">Kernel Address Sanitizer</h2>
<p>
Similar to the LLVM-based sanitizers for userspace components, Android includes
the Kernel Address Sanitizer (KASAN). KASAN is a combination of kernel and
compile time modifications that result in an instrumented system that allows for
simpler bug discovery and root cause analysis.
</p>
<p>
KASAN can detect many types of memory violations in the kernel. It can also
detect out-of-bound reads and writes on stack, heap and global variables, and
can detect use-after-free and double frees.
</p>
<p>
Similar to ASAN, KASAN uses a combination of memory-function instrumentation at
compile time and shadow memory to track memory accesses at runtime. In KASAN, an
eighth of the kernel memory space is dedicated to shadow memory, which
determines if a memory access is valid or not.
</p>
<p>
KASAN is supported on x86_64 and arm64 architectures. It has been part of the
upstream kernel since 4.0, and has been backported to Android 3.18-based
kernels. KASAN has been tested on Android kernels compiled with gcc based on
4.9.2.
</p>
<p>
In addition to KASAN, kcov is another kernel modification that is useful for
testing. kcov was developed to allow for coverage-guided fuzz testing in the
kernel. It measures coverage in terms of syscall inputs and is useful with
fuzzing systems, such as <a
href="https://github.com/google/syzkaller">syzkaller</a>.
</p>

<h3 id="kasan-implementation">Implementation</h3>
<p>
To compile a kernel with KASAN and kcov enabled, add the following build flags
to your kernel build configuration:
</p>
<pre class="devsite-click-to-copy">
CONFIG_KASAN 
CONFIG_KASAN_INLINE 
CONFIG_TEST_KASAN 
CONFIG_KCOV 
CONFIG_SLUB 
CONFIG_SLUB_DEBUG 
CONFIG_CC_OPTIMIZE_FOR_SIZE
</pre>

<p>
And removing the following:
</p>
<pre class="devsite-click-to-copy">
CONFIG_SLUB_DEBUG_ON 
CONFIG_SLUB_DEBUG_PANIC_ON 
CONFIG_KASAN_OUTLINE 
CONFIG_KERNEL_LZ4
</pre>
<p>
Then build and flash your kernel as usual. The KASAN kernel is considerably
larger than the original. If applicable, modify any boot parameters and
bootloader settings to take this into consideration.
</p>
<p>
After flashing the kernel, check the kernel boot logs to see if KASAN is enabled
and running. The kernel will start up with memory map information for KASAN,
such as:
</p>

<pre class="devsite-click-to-copy">
...
[    0.000000] c0      0 Virtual kernel memory layout:
[    0.000000] c0      0     kasan   : 0xffffff8000000000 - 0xffffff9000000000   (    64 GB)
[    0.000000] c0      0     vmalloc : 0xffffff9000010000 - 0xffffffbdbfff0000   (   182 GB)
[    0.000000] c0      0     vmemmap : 0xffffffbdc0000000 - 0xffffffbfc0000000   (     8 GB maximum)
[    0.000000] c0      0               0xffffffbdc0000000 - 0xffffffbdc3f95400   (    63 MB actual)
[    0.000000] c0      0     PCI I/O : 0xffffffbffa000000 - 0xffffffbffb000000   (    16 MB)
[    0.000000] c0      0     fixed   : 0xffffffbffbdfd000 - 0xffffffbffbdff000   (     8 KB)
[    0.000000] c0      0     modules : 0xffffffbffc000000 - 0xffffffc000000000   (    64 MB)
[    0.000000] c0      0     memory  : 0xffffffc000000000 - 0xffffffc0fe550000   (  4069 MB)
[    0.000000] c0      0       .init : 0xffffffc001d33000 - 0xffffffc001dce000   (   620 KB)
[    0.000000] c0      0       .text : 0xffffffc000080000 - 0xffffffc001d32284   ( 29385 KB)
...
</pre>

<p>
And this is how a bug will look:
</p>

<pre class="devsite-click-to-copy">
[   18.539668] c3      1 ==================================================================
[   18.547662] c3      1 BUG: KASAN: null-ptr-deref on address 0000000000000008
[   18.554689] c3      1 Read of size 8 by task swapper/0/1
[   18.559988] c3      1 CPU: 3 PID: 1 Comm: swapper/0 Tainted: G        W      3.18.24-xxx #1
[   18.569275] c3      1 Hardware name: Android Device
[   18.577433] c3      1 Call trace:
[   18.580739] c3      1 [&lt;ffffffc00008b32c&gt;] dump_backtrace+0x0/0x2c4
[   18.586985] c3      1 [&lt;ffffffc00008b600&gt;] show_stack+0x10/0x1c
[   18.592889] c3      1 [&lt;ffffffc001481194&gt;] dump_stack+0x74/0xc8
[   18.598792] c3      1 [&lt;ffffffc000202ee0&gt;] kasan_report+0x11c/0x4d0
[   18.605038] c3      1 [&lt;ffffffc00020286c&gt;] __asan_load8+0x20/0x80
[   18.611115] c3      1 [&lt;ffffffc000bdefe8&gt;] android_verity_ctr+0x8cc/0x1024
[   18.617976] c3      1 [&lt;ffffffc000bcaa2c&gt;] dm_table_add_target+0x3dc/0x50c
[   18.624832] c3      1 [&lt;ffffffc001bdbe60&gt;] dm_run_setup+0x50c/0x678
[   18.631082] c3      1 [&lt;ffffffc001bda8c0&gt;] prepare_namespace+0x44/0x1ac
[   18.637676] c3      1 [&lt;ffffffc001bda170&gt;] kernel_init_freeable+0x328/0x364
[   18.644625] c3      1 [&lt;ffffffc001478e20&gt;] kernel_init+0x10/0xd8
[   18.650613] c3      1 ==================================================================
</pre>

<p>
In addition, if modules are enabled in your kernel, you can load the test_kasan
kernel module for further testing. The module attempts out-of-bounds memory
accesses and use-after-free and is useful in testing KASAN on a target device.
</p>

          </div>

    
                   <devsite-page-rating position="footer" selected-rating="0" hover-rating-star="0">
         </devsite-page-rating>
                   
          </article>
</article>

<devsite-content-footer ds-is="content-footer" class="nocontent">
  <p>Content and code samples on this page are subject to the licenses described in the <a href="../../../license.html">Content License</a>. Java is a registered trademark of Oracle and/or its affiliates.</p>
</devsite-content-footer>


                      </devsite-content>
        </div>
        <devsite-footer-promos ds-is="footer-promos" class="devsite-footer">
                      
                  </devsite-footer-promos>
        <devsite-footer-linkboxes ds-is="footer-linkboxes" class="devsite-footer">
                      <nav class="devsite-footer-linkboxes nocontent">
  <ul class="devsite-footer-linkboxes-list">
        <li class="devsite-footer-linkbox ">
    <h3 class="devsite-footer-linkbox-heading">Build</h3>      <ul class="devsite-footer-linkbox-list">
                <li class="devsite-footer-linkbox-item">
          <a href="http://android.googlesource.com/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 1)"           >
            Android repository
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="../../../setup/build/requirements.html"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 2)"           >
            Requirements
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="../../../setup/build/downloading.html"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 3)"           >
            Downloading
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://developers.google.com/android/blobs-preview/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 4)"           >
            Preview binaries
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://developers.google.com/android/images/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 5)"           >
            Factory images
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://developers.google.com/android/drivers/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 6)"           >
            Driver binaries
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://android.github.io/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 7)"           >
            GitHub
          </a>
        </li>
              </ul>
    </li>
        <li class="devsite-footer-linkbox ">
    <h3 class="devsite-footer-linkbox-heading">Connect</h3>      <ul class="devsite-footer-linkbox-list">
                <li class="devsite-footer-linkbox-item">
          <a href="http://twitter.com/Android/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 1)"           >
            @Android on Twitter
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://twitter.com/AndroidDev/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 2)"           >
            @AndroidDev on Twitter
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://blog.google/products/android/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 3)"           >
            Android Blog
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://security.googleblog.com/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 4)"           >
            Google Security Blog
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://groups.google.com/forum/?fromgroups#!forum/android-platform/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 5)"           >
            Platform on Google Groups
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://groups.google.com/forum/?fromgroups#!forum/android-building/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 6)"           >
            Building on Google Groups
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://groups.google.com/forum/?fromgroups#!forum/android-porting/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 7)"           >
            Porting on Google Groups
          </a>
        </li>
              </ul>
    </li>
        <li class="devsite-footer-linkbox ">
    <h3 class="devsite-footer-linkbox-heading">Get help</h3>      <ul class="devsite-footer-linkbox-list">
                <li class="devsite-footer-linkbox-item">
          <a href="http://support.google.com/android/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 1)"           >
            Android Help Center
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://support.google.com/pixelphone/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 2)"           >
            Pixel Help Center
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://support.google.com/nexus/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 3)"           >
            Nexus Help Center
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://www.android.com/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 4)"           >
            www.android.com
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://www.android.com/gms/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 5)"           >
            Google Mobile Services
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://stackoverflow.com/questions/tagged/android-source/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 6)"           >
            Stack Overflow
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://issuetracker.google.com/issues?q=status:open%20componentid:190923"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 7)"           >
            Issue Tracker
          </a>
        </li>
              </ul>
    </li>
      </ul>
</nav>
                  </devsite-footer-linkboxes>
        <devsite-footer-utility ds-is="footer-utility" class="devsite-footer">
                      <div class="devsite-footer-utility">
  
  <nav class="devsite-nav">
        <ul class="devsite-footer-utility-list">
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="../../../source/index.html"
           data-category="Site-Wide Custom Events"
           data-label="Footer About Android link">
          About Android
        </a>
              </li>
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="../../../setup/community.html"
           data-category="Site-Wide Custom Events"
           data-label="Footer Community link">
          Community
        </a>
              </li>
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="../../../legal.html"
           data-category="Site-Wide Custom Events"
           data-label="Footer Legal link">
          Legal
        </a>
              </li>
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="../../../license.html"
           data-category="Site-Wide Custom Events"
           data-label="Footer License link">
          License
        </a>
              </li>
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="http://policies.google.cn/privacy"
           data-category="Site-Wide Custom Events"
           data-label="Footer Privacy link">
          Privacy
        </a>
              </li>
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="http://issuetracker.google.com/issues/new?component=191476"
           data-category="Site-Wide Custom Events"
           data-label="Footer Site feedback link">
          Site feedback
        </a>
              </li>
          </ul>
    
        <form class="devsite-footer-utility-language">
      <select class="devsite-footer-utility-language-select"
              name="language"
              track-name="click"
              track-type="languageSelector">
                  <option value="en"
                  track-metadata-original-language="en"
                  track-metadata-selected-language="en"
                  track-name="changed"
                  track-type="languageSelector"
                  selected="selected">
            English
          </option>
                  <option value="zh_cn"
                  track-metadata-original-language="en"
                  track-metadata-selected-language="zh_cn"
                  track-name="changed"
                  track-type="languageSelector"
                  >
            简体中文
          </option>
              </select>
    </form>
      </nav>
</div>
                  </devsite-footer-utility>
      </div></div>
    <devsite-sitemask ds-is="site-mask"></devsite-sitemask>
    <devsite-snackbar ds-is="snackbar"                       ></devsite-snackbar>    <devsite-tooltip ds-is="tooltip"
                     blocked-link></devsite-tooltip>
    <devsite-analytics ds-is="analytics">
              <script type="application/json" analytics>[{"metrics": {"ratings_value": "metric1", "ratings_count": "metric2"}, "dimensions": {}, "gaid": "UA-45455297-4"}]</script>
<script type="application/json" gtm>[]</script>
          </devsite-analytics>
    <script>
    (function(d,e,v,E,l,o,p,r,s,_,__){d['GoogleDevelopersObject']=[!0,l,o,p,r,s];
    _=e.createElement(v);_.async=1;_.src=E;__=e.getElementsByTagName(v)[0];
    __.parentNode.insertBefore(_,__);})(window, document, 'script',
      'https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/js/app_loader.js',
      'en',
      'https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/js/devsite_app.js',
      'https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource',
      !1,
      ['/_pwa/androidsource/manifest.json',
       'https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/images/video-placeholder.svg',
       'https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/images/favicon.png','https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/images/lockup.svg','https://fonts.googleapis.com/css?family=Roboto:300,400,400italic,500,500italic,700,700italic|Roboto+Mono:400,500,700|Material+Icons'],
       'https://androidsource-dot-google-developers.gonglchuangl.net/')
   </script>  </body>

<!-- Mirrored from source.android.google.cn/devices/tech/debug/sanitizers by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 16 Mar 2019 14:28:37 GMT -->
</html>