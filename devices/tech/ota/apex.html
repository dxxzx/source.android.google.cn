<!doctype html>
<html       lang="en"      dir="ltr">
  
<!-- Mirrored from source.android.google.cn/devices/tech/ota/apex by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 09 Sep 2019 14:58:16 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta property="og:site_name" content="Android Open Source Project">
    <meta property="og:type" content="website">
    
          <meta name="theme-color" content="#78c257">
    
    <meta charset="utf-8">
    <meta content="IE=Edge" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="../../../_pwa/androidsource/manifest.json"
          crossorigin="use-credentials">
    <link rel="preconnect" href="http://www.gstatic.com/" crossorigin>
    <link rel="preconnect" href="http://fonts.gstatic.com/" crossorigin>
    <link rel="preconnect" href="http://fonts.googleapis.com/" crossorigin>
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:300,400,400italic,500,500italic,700,700italic|Roboto+Mono:400,500,700|Material+Icons">
        <link rel="stylesheet" href="https://www.gstatic.com/devrel-devsite/vbb62cc5a3e8f17e37bae4792b437f28f787df3f9cf9732cbfcc99b4f4ff41a54/androidsource/css/rebrand-app.css">
    <noscript>
      <link rel="stylesheet" href="https://www.gstatic.com/devrel-devsite/vbb62cc5a3e8f17e37bae4792b437f28f787df3f9cf9732cbfcc99b4f4ff41a54/androidsource/css/ce_bundle.css">
    </noscript>
    <link rel="shortcut icon" href="https://www.gstatic.com/devrel-devsite/vbb62cc5a3e8f17e37bae4792b437f28f787df3f9cf9732cbfcc99b4f4ff41a54/androidsource/images/rebrand/favicon.png">
    <link rel="apple-touch-icon" href="https://www.gstatic.com/devrel-devsite/vbb62cc5a3e8f17e37bae4792b437f28f787df3f9cf9732cbfcc99b4f4ff41a54/androidsource/images/rebrand/touchicon-180.png"><link rel="canonical" href="apex.html">      
<title>APEX File Format &nbsp;|&nbsp; Android Open Source Project</title>

<meta property="og:title" content="APEX File Format &nbsp;|&nbsp; Android Open Source Project">


  <meta property="og:url" content="apex.html">

  <meta property="og:locale" content="en">





  

  

    </head>
  <body type="article"
        theme="androidsource-theme"
        class=""
        
        layout="docs"
        block-apix        pending>
    <devsite-progress type="indeterminate" id="app-progress"></devsite-progress>
    <div class="devsite-wrapper"><devsite-header keep-tabs-visible>
      









<div class="devsite-header--inner">
  <div class="devsite-top-logo-row-wrapper-wrapper">
    <div class="devsite-top-logo-row-wrapper">
      <div class="devsite-top-logo-row">
        <button type="button" id="devsite-hamburger-menu"
          class="devsite-header-icon-button button-flat material-icons gc-analytics-event"
          data-category="Site-Wide Custom Events"
          data-label="Navigation menu button"
          visually-hidden
          aria-label="Close menu">
        </button>
        <div class="devsite-product-name-wrapper">
  <a href="../../../index.html" class="devsite-site-logo-link gc-analytics-event"
   data-category="Site-Wide Custom Events" data-label="Site logo">
  <img src="https://www.gstatic.cn/devrel-devsite/vbb62cc5a3e8f17e37bae4792b437f28f787df3f9cf9732cbfcc99b4f4ff41a54/androidsource/images/rebrand/lockup.svg" class="devsite-site-logo" alt="Android Open Source Project">
</a>
            <span class="devsite-product-name">
            <ul class="devsite-breadcrumb-list">
    <li class="devsite-breadcrumb-item
             ">
                              </li>
  </ul>
          </span>
        
</div>        <div class="devsite-top-logo-row-middle">
          <div class="devsite-header-upper-tabs">
                          <devsite-tabs class="upper-tabs">
  <div class="devsite-tabs-wrapper">
                  <tab >
          <a href="../../../setup.html"
   class="gc-analytics-event"
   title="Set up"
           data-category="Site-Wide Custom Events"
        data-label="Tab: Set up"
   >
  Set up
</a>

        </tab>
                        <tab >
          <a href="../../../compatibility.html"
   class="gc-analytics-event"
   title="Design"
           data-category="Site-Wide Custom Events"
        data-label="Tab: Design"
   >
  Design
</a>

        </tab>
                        <tab >
          <a href="../../../security.html"
   class="gc-analytics-event"
   title="Secure"
           data-category="Site-Wide Custom Events"
        data-label="Tab: Secure"
   >
  Secure
</a>

        </tab>
                        <tab >
          <a href="../../../devices.html"
   class="gc-analytics-event"
   title="Develop"
           data-category="Site-Wide Custom Events"
        data-label="Tab: Develop"
   >
  Develop
</a>

        </tab>
                        <tab active>
          <a href="../../tech.html"
   class="gc-analytics-event"
   title="Configure"
   aria-label="Configure, selected"         data-category="Site-Wide Custom Events"
        data-label="Tab: Configure"
   >
  Configure
</a>

        </tab>
                        <tab >
          <a href="../../../reference.html"
   class="gc-analytics-event"
   title="Reference"
           data-category="Site-Wide Custom Events"
        data-label="Tab: Reference"
   >
  Reference
</a>

        </tab>
            </div>
</devsite-tabs>

                       </div>
          <devsite-search
            enable-suggestions
              family-name="Android Open Source Project"    tenant-name="Android Open Source Project"            >
  <form class="devsite-search-form" action="https://source.android.google.cn/s/results" method="GET">
    <div class="devsite-search-container">
      <div class="devsite-searchbox">
                <input placeholder="Search"
          type="text"
          class="devsite-search-field devsite-search-query"
          name="q"
          value=""
          autocomplete="off"
                    aria-label="Search box">
        <div class="devsite-search-image material-icons" aria-hidden="true"></div>
      </div>
      <button type="button"
              search-open
              class="devsite-search-button devsite-header-icon-button button-flat material-icons"
              aria-label="Open search box"></button>
    </div>
  </form>
  <button type="button"
          search-close
          class="devsite-search-button devsite-header-icon-button button-flat material-icons"
          aria-label="Close search box"></button>
</devsite-search>

        </div>

        <devsite-language-selector>
  <devsite-select class="devsite-language-selector-menu">
    <select class="devsite-language-selector-select"
            name="language"
            track-name="click"
            track-type="languageSelector">
                <option>Language</option>
              <option value="en"
              track-metadata-original-language="en"
              track-metadata-selected-language="en"
              track-name="changed"
              track-type="languageSelector"
            >
        English
      </option>
          <option value="zh_cn"
              track-metadata-original-language="en"
              track-metadata-selected-language="zh_cn"
              track-name="changed"
              track-type="languageSelector"
            >
        中文 – 简体
      </option>
        </select>
  </devsite-select>
</devsite-language-selector>


                  <a class="devsite-header-link devsite-top-button button gc-analytics-event"
   href="http://android-review.googlesource.com/"
   data-category="Site-Wide Custom Events"
   data-label="Site header link">
  Go to code
</a>
        
              </div>    </div>  </div>
  <div class="devsite-collapsible-section
    ">
    <div class="devsite-header-background">
                        <div class="devsite-product-id-row">
            <div class="devsite-product-description-row">
                              <ul class="devsite-breadcrumb-list">
    <li class="devsite-breadcrumb-item
             ">
                    <a href="../../tech.html"              class="devsite-breadcrumb-link gc-analytics-event"
              data-category="Site-Wide Custom Events"
              data-label="Lower Header"
              data-value="1"
          >
            Configure
      
  </a>
        </li>
  </ul>
                                        </div>
                                                                                    </div>
                                      <div class="devsite-doc-set-nav-row">
                              <devsite-tabs class="lower-tabs">
  <div class="devsite-tabs-wrapper">
                  <tab >
          <a href="../../tech.html"
   class="gc-analytics-event"
   title="Overview"
           data-category="Site-Wide Custom Events"
        data-label="Tab: Overview"
   >
  Overview
</a>

        </tab>
                        <tab >
          <a href="../datausage.html"
   class="gc-analytics-event"
   title="Data"
           data-category="Site-Wide Custom Events"
        data-label="Tab: Data"
   >
  Data
</a>

        </tab>
                        <tab >
          <a href="../admin.html"
   class="gc-analytics-event"
   title="Enterprise"
           data-category="Site-Wide Custom Events"
        data-label="Tab: Enterprise"
   >
  Enterprise
</a>

        </tab>
                        <tab >
          <a href="../perf.html"
   class="gc-analytics-event"
   title="Performance"
           data-category="Site-Wide Custom Events"
        data-label="Tab: Performance"
   >
  Performance
</a>

        </tab>
                        <tab >
          <a href="../config.html"
   class="gc-analytics-event"
   title="Permissions"
           data-category="Site-Wide Custom Events"
        data-label="Tab: Permissions"
   >
  Permissions
</a>

        </tab>
                        <tab >
          <a href="../power.html"
   class="gc-analytics-event"
   title="Power"
           data-category="Site-Wide Custom Events"
        data-label="Tab: Power"
   >
  Power
</a>

        </tab>
                        <tab >
          <a href="../dalvik.html"
   class="gc-analytics-event"
   title="Runtime"
           data-category="Site-Wide Custom Events"
        data-label="Tab: Runtime"
   >
  Runtime
</a>

        </tab>
                        <tab active>
          <a href="../ota.html"
   class="gc-analytics-event"
   title="Updates"
   aria-label="Updates, selected"         data-category="Site-Wide Custom Events"
        data-label="Tab: Updates"
   >
  Updates
</a>

        </tab>
            </div>
</devsite-tabs>

        </div>
          </div>  </div></div>
  

  </devsite-header>      <devsite-book-nav scrollbars >
                  




<nav class="devsite-book-nav devsite-nav nocontent">
  <div class="devsite-mobile-header">
    <button type="button"
            id="devsite-close-nav"
            class="devsite-header-icon-button button-flat material-icons gc-analytics-event"
            data-category="Site-Wide Custom Events"
            data-label="Close navigation"
            aria-label="Close navigation">
    </button>
    <div class="devsite-product-name-wrapper">
  <a href="../../../index.html" class="devsite-site-logo-link gc-analytics-event"
   data-category="Site-Wide Custom Events" data-label="Site logo">
  <img src="https://www.gstatic.com/devrel-devsite/vbb62cc5a3e8f17e37bae4792b437f28f787df3f9cf9732cbfcc99b4f4ff41a54/androidsource/images/rebrand/lockup.svg" class="devsite-site-logo" alt="Android Open Source Project">
</a>
        <span class="devsite-product-name">
        <ul class="devsite-breadcrumb-list">
    <li class="devsite-breadcrumb-item
             ">
                              </li>
  </ul>
      </span>
    
</div>  </div>

  <div class="devsite-book-nav-wrapper">
    <div class="devsite-mobile-nav-top">
              <ul class="devsite-nav-list">
                      <li class="devsite-nav-item">
                                <a href="../../../setup.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Set up">
      <span class="devsite-nav-text" >Set up</span>
        </a>
  
                                        </li>
                      <li class="devsite-nav-item">
                                <a href="../../../compatibility.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Design">
      <span class="devsite-nav-text" >Design</span>
        </a>
  
                                        </li>
                      <li class="devsite-nav-item">
                                <a href="../../../security.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Secure">
      <span class="devsite-nav-text" >Secure</span>
        </a>
  
                                        </li>
                      <li class="devsite-nav-item">
                                <a href="../../../devices.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Develop">
      <span class="devsite-nav-text" >Develop</span>
        </a>
  
                                        </li>
                      <li class="devsite-nav-item">
                                <a href="../../tech.html"
          class="devsite-nav-title gc-analytics-event
            devsite-nav-active"
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Configure">
      <span class="devsite-nav-text" >Configure</span>
        </a>
  
                                            <ul class="devsite-nav-responsive-tabs">
                                                                                                                      <li class="devsite-nav-item">
    <a href="../../tech.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Overview">
      <span class="devsite-nav-text" >Overview</span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="../datausage.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Data">
      <span class="devsite-nav-text" >Data</span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="../admin.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Enterprise">
      <span class="devsite-nav-text" >Enterprise</span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="../perf.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Performance">
      <span class="devsite-nav-text" >Performance</span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="../config.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Permissions">
      <span class="devsite-nav-text" >Permissions</span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="../power.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Power">
      <span class="devsite-nav-text" >Power</span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="../dalvik.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Runtime">
      <span class="devsite-nav-text" >Runtime</span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="../ota.html"
     id="devsite-nav-forward"     class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Updates">
      <span class="devsite-nav-text" menu="_book">Updates</span>
        <span class="devsite-nav-icon material-icons" data-icon="forward" aria-hidden="true"
          menu="_book">
    </span>
        </a>
  </li>

                                  </ul>
                          </li>
                      <li class="devsite-nav-item">
                                <a href="../../../reference.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Reference">
      <span class="devsite-nav-text" >Reference</span>
        </a>
  
                                        </li>
                                <li class="devsite-nav-item">
    <a href="http://android-review.googlesource.com/"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Go to code">
      <span class="devsite-nav-text" >Go to code</span>
        </a>
  </li>

                  </ul>
          </div>
          <div class="devsite-mobile-nav-bottom">
                            <ul class="devsite-nav-list" menu="_book">
            <li class="devsite-nav-item"><a href="../ota.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Overview">Overview</span></a></li>
  <li class="devsite-nav-item"><a href="apex.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="APEX File Format">APEX File Format</span></a></li>
  <li class="devsite-nav-item"><a href="tools.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="OTA Tools">OTA Tools</span></a></li>
  <li class="devsite-nav-item"><a href="sign_builds.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Signing Builds for Release">Signing Builds for Release</span></a></li>
  <li class="devsite-nav-item"><a href="reduce_size.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Reducing OTA Size">Reducing OTA Size</span></a></li>
  <li class="devsite-nav-item           devsite-nav-expandable"><devsite-expandable-nav collapsed>
    <a class="devsite-nav-toggle" aria-hidden="true"></a><div class="devsite-nav-title devsite-nav-title-no-path" tabindex="0"><span class="devsite-nav-text" title="A/B System Updates">A/B System Updates</span></div><ul class="devsite-nav-section"><li class="devsite-nav-item"><a href="ab.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Overview">Overview</span></a></li><li class="devsite-nav-item"><a href="ab/ab_implement.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Implementing A/B Updates">Implementing A/B Updates</span></a></li><li class="devsite-nav-item"><a href="ab/ab_faqs.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Frequently Asked Questions">Frequently Asked Questions</span></a></li></ul></devsite-expandable-nav></li>
  <li class="devsite-nav-item           devsite-nav-expandable"><devsite-expandable-nav collapsed>
    <a class="devsite-nav-toggle" aria-hidden="true"></a><div class="devsite-nav-title devsite-nav-title-no-path" tabindex="0"><span class="devsite-nav-text" title="Non-A/B System Updates">Non-A/B System Updates</span></div><ul class="devsite-nav-section"><li class="devsite-nav-item"><a href="nonab.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Overview">Overview</span></a></li><li class="devsite-nav-item"><a href="nonab/block.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Block-Based OTA">Block-Based OTA</span></a></li><li class="devsite-nav-item"><a href="nonab/inside_packages.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Inside OTA Packages">Inside OTA Packages</span></a></li><li class="devsite-nav-item"><a href="nonab/device_code.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Device-Specific Code">Device-Specific Code</span></a></li></ul></devsite-expandable-nav></li>
  <li class="devsite-nav-item           devsite-nav-expandable"><devsite-expandable-nav collapsed>
    <a class="devsite-nav-toggle" aria-hidden="true"></a><div class="devsite-nav-title devsite-nav-title-no-path" tabindex="0"><span class="devsite-nav-text" title="Dynamic Partitions">Dynamic Partitions</span></div><ul class="devsite-nav-section"><li class="devsite-nav-item"><a href="dynamic_partitions.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Overview">Overview</span></a></li><li class="devsite-nav-item"><a href="dynamic_partitions/implement.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Implementing Dynamic Partitions">Implementing Dynamic Partitions</span></a></li><li class="devsite-nav-item"><a href="dynamic_partitions/ab_launch.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="OTA for A/B Devices">OTA for A/B Devices</span></a></li><li class="devsite-nav-item"><a href="dynamic_partitions/ab_legacy.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="OTA for Legacy A/B Devices">OTA for Legacy A/B Devices</span></a></li><li class="devsite-nav-item"><a href="dynamic_partitions/nonab.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="OTA for non-A/B Devices">OTA for non-A/B Devices</span></a></li></ul></devsite-expandable-nav></li>
  <li class="devsite-nav-item"><a href="../config/timezone-rules.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Time Zone Rules">Time Zone Rules</span></a></li>
  <li class="devsite-nav-item"><a href="user-data-checkpoint.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="User Data Checkpoint">User Data Checkpoint</span></a></li>
  <li class="devsite-nav-item"><a href="dynamic-system-updates.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Dynamic System Updates">Dynamic System Updates</span></a></li>
          </ul>
                                                                                                                                                                            </div>
      </div>
</nav>
              </devsite-book-nav>
      <div id="gc-wrapper">
        <div class="devsite-main-content"
            has-book-nav            has-toc>
          <devsite-toc class="devsite-nav"
            ></devsite-toc>
          <devsite-content>
                          

<article class="devsite-article">
  <article class="devsite-article-inner">        
    <div class="devsite-article-meta">
      <ul class="devsite-breadcrumb-list">
    <li class="devsite-breadcrumb-item
             ">
                    <a href="../../../index.html"              class="devsite-breadcrumb-link gc-analytics-event"
              data-category="Site-Wide Custom Events"
              data-label="Breadcrumbs"
              data-value="1"
          >
            AOSP
      
  </a>
        </li>
    <li class="devsite-breadcrumb-item
             ">
                <div class="devsite-breadcrumb-guillemet material-icons" aria-hidden="true"></div>
                    <a href="../../tech.html"              class="devsite-breadcrumb-link gc-analytics-event"
              data-category="Site-Wide Custom Events"
              data-label="Breadcrumbs"
              data-value="2"
          >
            Configure
      
  </a>
        </li>
    <li class="devsite-breadcrumb-item
             ">
                <div class="devsite-breadcrumb-guillemet material-icons" aria-hidden="true"></div>
                    <a href="../ota.html"              class="devsite-breadcrumb-link gc-analytics-event"
              data-category="Site-Wide Custom Events"
              data-label="Breadcrumbs"
              data-value="3"
          >
            Updates
      
  </a>
        </li>
  </ul>
               <devsite-page-rating position="header" selected-rating="0" hover-rating-star="0">
         </devsite-page-rating>
          </div>

              <h1 class="devsite-page-title">APEX File Format</h1>
    
    <devsite-toc class="devsite-nav" devsite-toc-embedded >
    </devsite-toc>

    <div class="devsite-article-body clearfix
      ">

              





























<!--
  Copyright 2019 The Android Open Source Project

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->



<p>Android Pony EXpress (APEX) is a container format introduced in Android
10
that is used in the install flow for lower-level system
modules. This format facilitates the updates of system components that don&#39;t fit
into the standard Android application model. Some example components are native
services and libraries, hardware abstraction layers
(<a href="../../architecture/hal-types.html">HALs</a>), runtime
(<a href="../dalvik.html">ART</a>), and class libraries.</p>

<p>The term &quot;APEX&quot; can also refer to an APEX file.</p>

<h2 id="background">Background</h2>

<p>Although Android supports updates of modules that fit within the standard app
model (for example, services, activities) via package installer apps (such as
the Google Play Store app), using a similar model for lower-level OS components
has the following drawbacks:</p>

<ul>
<li>APK-based modules can&#39;t be used early in the boot sequence. The package
manager is the central repository of information about apps and can only be
started from the activity manager, which becomes ready in a later stage of
the boot procedure.</li>
<li>The APK format (particularly the manifest) is designed for Android apps and
system modules aren&#39;t always a good fit.</li>
</ul>

<h2 id="design">Design</h2>

<p>This section describes the high-level design of the APEX file format and the
APEX manager, which is a service that manages APEX files.</p>

<p>For more information on why this design for APEX was selected, see
<a href="#alternatives_considered_when_developing_apex">Alternatives considered when developing APEX</a>.</p>

<h3 id="apex_format">APEX format</h3>

<p>This is the format of an APEX file.</p>

<p><img src="images/apex-format.png" alt="APEX file format"></p>

<p><strong>Figure 1.</strong> APEX file format</p>

<p>At the top level, an APEX file is a zip file in which files are stored
uncompressed and located at 4&nbsp;KB boundaries.</p>

<p>The four files in an APEX file are:</p>

<ul>
<li><code translate="no" dir="ltr">apex_manifest.json</code></li>
<li><code translate="no" dir="ltr">AndroidManifest.xml</code></li>
<li><code translate="no" dir="ltr">apex_payload.img</code></li>
<li><code translate="no" dir="ltr">apex_pubkey</code></li>
</ul>

<p>The <code translate="no" dir="ltr">apex_manifest.json</code> file contains the package name and version, which
identify an APEX file.</p>

<p>The <code translate="no" dir="ltr">AndroidManifest.xml</code> file allows the APEX file to use APK-related tools and
infrastructure such as ADB, PackageManager, and package installer apps (such as
Play Store). For example, the APEX file can use an existing tool such as <code translate="no" dir="ltr">aapt</code>
to inspect basic metadata from the file. The file contains package name and
version information. This information is generally also available in
<code translate="no" dir="ltr">apex_manifest.json</code>.</p>

<p><code translate="no" dir="ltr">apex_manifest.json</code> is recommended over <code translate="no" dir="ltr">AndroidManifest.xml</code> for new code and
systems that deal with APEX. <code translate="no" dir="ltr">AndroidManifest.xml</code> might contain additional
targeting information that can be used by the existing app publishing tools.</p>

<p><code translate="no" dir="ltr">apex_payload.img</code> is an ext4 file system image backed by dm-verity. The image
is mounted at runtime via a loopback device. Specifically, the hash tree and
metadata block are created using libavb. The file system payload isn&#39;t parsed
(because the image should be mountable in place). Regular files are included
inside the <code translate="no" dir="ltr">apex_payload.img</code> file.</p>

<p><code translate="no" dir="ltr">apex_pubkey</code> is the public key used to sign the file system image. At runtime,
this key ensures that the downloaded APEX is signed with the same entity
that signs the same APEX in the built-in partitions.</p>

<h3 id="apex_manager">APEX manager</h3>

<p>The APEX manager (or <code translate="no" dir="ltr">apexd</code>) is a standalone native process responsible for
verifying, installing, and uninstalling APEX files. This process is launched and
is ready early in the boot sequence. APEX files are normally pre-installed on
the device under <code translate="no" dir="ltr">/system/apex</code>. The APEX manager defaults to using these
packages if no updates are available.</p>

<p>The update sequence of an APEX uses the
<a href="https://developer.android.google.cn/reference/android/content/pm/PackageManager" class="external">PackageManager class</a> 
and is as follows.</p>

<ol>
<li>An APEX file is downloaded via a package installer app, ADB, or other
source.</li>
<li>The package manager starts the installation procedure. Upon recognizing that
the file is an APEX, the package manager transfers control to the APEX
manager.</li>
<li>The APEX manager verifies the APEX file.</li>
<li>If the APEX file is verified, the internal database of the APEX manager is
updated to reflect that the APEX file will be activated at next boot.</li>
<li>The requestor of the install receives a broadcast upon successful
verification of the package.</li>
<li>To continue the installation, the system automatically reboots the device.</li>
<li><p>At reboot, the APEX manager starts, reads the internal database, and does
the following for each APEX file listed:</p>

<ol>
<li>Verifies the APEX file.</li>
<li>Creates a loopback device from the APEX file.</li>
<li>Creates a device mapper block device on top of the loopback device.</li>
<li>Mounts the device mapper block device onto a unique path (for example,
<code translate="no" dir="ltr">/apex/<var>name</var>@<var>ver</var></code>).</li>
</ol></li>
</ol>

<p>When all APEX files listed in the internal database are mounted, the APEX
manager provides a binder service for other system components to query
information about the installed APEX files. For example, the other system
components can query the list of APEX files installed in the device or query the
exact path where a specific APEX is mounted, so the files can be accessed.</p>

<h3 id="apex_files_are_apk_files">APEX files are APK files</h3>

<p>APEX files are valid APK files because they are signed zip archives (using the
APK signature scheme) containing an <code translate="no" dir="ltr">AndroidManifest.xml</code> file. This allows APEX
files to use the infrastructure for APK files, such as a package installer app,
the signing utility, and the package manager.</p>

<p>The <code translate="no" dir="ltr">AndroidManifest.xml</code> file inside an APEX file is minimal, consisting of the
package <code translate="no" dir="ltr">name</code>, <code translate="no" dir="ltr">versionCode</code>, and optional <code translate="no" dir="ltr">targetSdkVersion</code>, <code translate="no" dir="ltr">minSdkVersion</code>,
and <code translate="no" dir="ltr">maxSdkVersion</code> for fine-grained targeting. This information allows APEX
files to be delivered via existing channels such as package installer apps and
ADB.</p>

<h3 id="file_types_supported">File types supported</h3>

<p>The APEX format supports these file types:</p>

<ul>
<li>Native shared libs</li>
<li>Native executables</li>
<li>JAR files</li>
<li>Data files</li>
<li>Config files</li>
</ul>

<p>This does not mean that APEX can update all of these file types. Whether a file
type can be updated depends on the platform and how stable the interfaces for
the files types are defined.</p>

<h3 id="signing">Signing</h3>

<p>APEX files are signed in two ways. First, the <code translate="no" dir="ltr">apex_payload.img</code> (specifically,
the vbmeta descriptor appended to <code translate="no" dir="ltr">apex_payload.img</code>) file is signed with a key.
Then, the entire APEX is signed using the
<a href="../../../security/apksigning/v3.html">APK signature scheme v3</a>. Two different keys are used
in this process.</p>

<p>On the device side, a public key corresponding to the private key used to sign
the vbmeta descriptor is installed. The APEX manager uses the public key to
verify APEXs that are requested to be installed. Each APEX must be signed with
different keys and is enforced both at build time and runtime.</p>

<h3 id="apex_in_built-in_partitions">APEX in built-in partitions</h3>

<p>APEX files can be located in built-in partitions such as <code translate="no" dir="ltr">/system</code>. The
partition is
already over dm-verity, so the APEX files are mounted directly over the loopback
device.</p>

<p>If an APEX is present in a built-in partition, the APEX can be updated by
providing an APEX package with the same package name and a higher version code.
The new APEX is stored in <code translate="no" dir="ltr">/data</code> and, similar to APKs, the newer version
shadows the version already present in the built-in partition. But unlike APKs,
the newer version of the APEX is only activated after reboot.</p>

<h2 id="kernel_requirements">Kernel requirements</h2>

<p>To support APEX mainline modules on an Android device, the following Linux
kernel features are required: the loopback driver and dm-verity. The loopback
driver mounts the file system image in an APEX module and dm-verity verifies the
APEX module.</p>

<p>The performance of the loopback driver and dm-verity is important in achieving
good system performance when using APEX modules.</p>

<h3 id="supported_kernel_versions">Supported kernel versions</h3>

<p>APEX mainline modules are supported on devices using kernel versions 4.4 or
higher. New devices launching with Android 10 or higher
must use kernel version 4.9 or higher to support APEX modules.</p>

<h3 id="required_kernel_patches">Required kernel patches</h3>

<p>The required kernel patches for supporting APEX modules are included in the
Android common tree. To get the patches to support APEX, use the latest version
of the Android common tree.</p>

<h4 id="kernel_version_44">Kernel version 4.4</h4>

<p>This version is only supported for devices that are upgraded from Android 9 to
Android 10 and want to support APEX modules. To get the
required patches, a down-merge from the <code translate="no" dir="ltr">android-4.4</code> branch is strongly
recommended. The following is a list of the required individual patches
for kernel version 4.4.</p>

<ul>
<li>UPSTREAM: loop: add ioctl for changing logical block size
(<a href="https://android-review.googlesource.com/c/kernel/common/+/777013" class="external">4.4</a>)</li>
<li>BACKPORT: block/loop: set hw_sectors
(<a href="https://android-review.googlesource.com/c/kernel/common/+/777014/7" class="external">4.4</a>)</li>
<li>UPSTREAM: loop: Add LOOP_SET_BLOCK_SIZE in compat ioctl
(<a href="https://android-review.googlesource.com/c/kernel/common/+/777015/7" class="external">4.4</a>)</li>
<li>ANDROID: mnt: Fix next_descendent
(<a href="https://android-review.googlesource.com/c/kernel/common/+/405314" class="external">4.4</a>)</li>
<li>ANDROID: mnt: remount should propagate to slaves of slaves
(<a href="https://android-review.googlesource.com/c/kernel/common/+/320406" class="external">4.4</a>)</li>
<li>ANDROID: mnt: Propagate remount correctly
(<a href="https://android-review.googlesource.com/c/kernel/common/+/928253" class="external">4.4</a>)</li>
<li>Revert &quot;ANDROID: dm verity: add minimum prefetch size&quot;
(<a href="https://android-review.googlesource.com/c/kernel/common/+/867875" class="external">4.4</a>)</li>
<li>UPSTREAM: loop: drop caches if offset or block_size are changed
(<a href="https://android-review.googlesource.com/c/kernel/common/+/854265" class="external">4.4</a>)</li>
</ul>

<h4 id="kernel_versions_49414419">Kernel versions 4.9/4.14/4.19</h4>

<p>To get the required patches for kernel versions 4.9/4.14/4.19, down-merge from
the <code translate="no" dir="ltr">android-common</code> branch.</p>

<h3 id="required_kernel_configuration_options">Required kernel configuration options</h3>

<p>The following list shows the base configuration requirements for supporting
APEX modules that were introduced in Android 10. The
items with an asterisk (*) are existing requirements from Android 9 and lower.</p>
<pre class="prettyprint" translate="no" dir="ltr"><code translate="no" dir="ltr">(*) CONFIG_AIO=Y # AIO support (for direct I/O on loop devices)
CONFIG_BLK_DEV_LOOP=Y # for loop device support
CONFIG_BLK_DEV_LOOP_MIN_COUNT=16 # pre-create 16 loop devices
(*) CONFIG_CRYPTO_SHA1=Y # SHA1 hash for DM-verity
(*) CONFIG_CRYPTO_SHA256=Y # SHA256 hash for DM-verity
CONFIG_DM_VERITY=Y # DM-verity support
</code></pre>
<h3 id="kernel_command_line_parameter_requirements">Kernel command line parameter requirements</h3>

<p>To support APEX, make sure the kernel command line parameters meet the following
requirements.</p>

<ul>
<li><code translate="no" dir="ltr">loop.max_loop</code> must NOT be set</li>
<li><code translate="no" dir="ltr">loop.max_part</code> must be &lt;= 8</li>
</ul>

<h2 id="building_an_apex">Building an APEX</h2>

<p>This section describes how to build an APEX using the Android build system.
The following is an example of <code translate="no" dir="ltr">Android.bp</code> for an APEX named <code translate="no" dir="ltr">apex.test</code>.</p>
<pre class="prettyprint" translate="no" dir="ltr"><code translate="no" dir="ltr">apex {
    name: &#34;apex.test&#34;,
    manifest: &#34;apex_manifest.json&#34;,
    file_contexts: &#34;file_contexts&#34;,
    // libc.so and libcutils.so are included in the apex
    native_shared_libs: [&#34;libc&#34;, &#34;libcutils&#34;],
    binaries: [&#34;vold&#34;],
    java_libs: [&#34;core-all&#34;],
    prebuilts: [&#34;my_prebuilt&#34;],
    compile_multilib: &#34;both&#34;,
    key: &#34;apex.test.key&#34;,
    certificate: &#34;platform&#34;,
}
</code></pre>
<p><code translate="no" dir="ltr">apex_manifest.json</code> example:</p>
<pre class="prettyprint" translate="no" dir="ltr"><code translate="no" dir="ltr">{
  &#34;name&#34;: &#34;com.android.example.apex&#34;,
  &#34;version&#34;: 1
}
</code></pre>
<p><code translate="no" dir="ltr">file_contexts</code> example:</p>
<pre class="prettyprint" translate="no" dir="ltr"><code translate="no" dir="ltr">(/.*)?           u:object_r:system_file:s0
/sub(/.*)?       u:object_r:sub_file:s0
/sub/file3       u:object_r:file3_file:s0
</code></pre>
<h4 id="file_types_and_locations_in_apex">File types and locations in APEX</h4>

<table>
<tbody>
<tr>
<th>File type</th>
<th>Location in APEX</th>
</tr>
<tr>
<td>Shared libraries</td>
<td><code translate="no" dir="ltr">/lib</code> and <code translate="no" dir="ltr">/lib64</code> (<code translate="no" dir="ltr">/lib/arm</code> for
translated arm in x86)</td>
</tr>
<tr>
<td>Executables</td>
<td><code translate="no" dir="ltr">/bin</code></td>
</tr>
<tr>
<td>Java libraries</td>
<td><code translate="no" dir="ltr">/javalib</code></td>
</tr>
<tr>
<td>Prebuilts</td>
<td><code translate="no" dir="ltr">/etc</code></td>
</tr>
</tbody>
</table>

<h3 id="transitive_dependencies">Transitive dependencies</h3>

<p>APEX files automatically include transitive dependencies of native shared libs
or executables. For example, if <code translate="no" dir="ltr">libFoo</code> depends on <code translate="no" dir="ltr">libBar</code>, the two libs are
included when only <code translate="no" dir="ltr">libFoo</code> is listed in the <code translate="no" dir="ltr">native_shared_libs</code> property.</p>

<h3 id="handling_multiple_abis">Handling multiple ABIs</h3>

<p>Install the <code translate="no" dir="ltr">native_shared_libs</code> property for both primary and secondary
application binary interfaces (ABIs) of the device. If an APEX targets devices
with a single ABI (that is, 32 bit only or 64 bit only), only libraries with the
corresponding ABI are installed.</p>

<p>Install the <code translate="no" dir="ltr">binaries</code> property only for the primary ABI of the device as
described below:</p>

<ul>
<li>If the device is 32 bit only, only the 32-bit variant of the binary is
installed.</li>
<li>If the device supports both 32/64 ABIs, but with
<code translate="no" dir="ltr">TARGET_PREFER_32_BIT_EXECUTABLES=true</code>, then only the 32-bit variant of the
binary is installed.</li>
<li>If the device is 64 bit only, then only the 64-bit variant of the binary is
installed.</li>
<li>If the device supports both 32/64 ABIs, but without
TARGET_PREFER_32_BIT_EXECUTABLES<code translate="no" dir="ltr">=true</code>, then only the 64-bit variant of the
binary is installed.</li>
</ul>

<p>To add fine-grained control over the ABIs of the native libraries and binaries,
use the
<code translate="no" dir="ltr">multilib.[first|lib32|lib64|prefer32|both].[native_shared_libs|binaries]</code>
properties.</p>

<ul>
<li><code translate="no" dir="ltr">first</code>: Matches the primary ABI of the device. This is the default for
binaries.</li>
<li><code translate="no" dir="ltr">lib32</code>: Matches the 32-bit ABI of the device, if supported.</li>
<li><code translate="no" dir="ltr">lib64</code>: Matches the 64-bit ABI of the device, it supported.</li>
<li><code translate="no" dir="ltr">prefer32</code>: Matches the 32-bit ABI of the device, if supported. If the
32-bit ABI isn&#39;t supported, matches the 64-bit ABI.</li>
<li><code translate="no" dir="ltr">both</code>: Matches both ABIs. This is the default for
<code translate="no" dir="ltr">native_shared_libraries</code>.</li>
</ul>

<p>The <code translate="no" dir="ltr">java</code>, <code translate="no" dir="ltr">libraries</code>, and <code translate="no" dir="ltr">prebuilts</code> properties are ABI-agnostic.</p>

<p>This example is for a device that supports 32/64 and doesn&#39;t prefer 32:</p>
<pre class="prettyprint" translate="no" dir="ltr"><code translate="no" dir="ltr">apex {
    // other properties are omitted
    native_shared_libs: [&#34;libFoo&#34;], // installed for 32 and 64
    binaries: [&#34;exec1&#34;], // installed for 64, but not for 32
    multilib: {
        first: {
            native_shared_libs: [&#34;libBar&#34;], // installed for 64, but not for 32
            binaries: [&#34;exec2&#34;], // same as binaries without multilib.first
        },
        both: {
            native_shared_libs: [&#34;libBaz&#34;], // same as native_shared_libs without multilib
            binaries: [&#34;exec3&#34;], // installed for 32 and 64
        },
        prefer32: {
            native_shared_libs: [&#34;libX&#34;], // installed for 32, but not for 64
        },
        lib64: {
            native_shared_libs: [&#34;libY&#34;], // installed for 64, but not for 32
        },
    },
}
</code></pre>
<h3 id="vbmeta_signing">vbmeta signing</h3>

<p>Sign each APEX with different keys. When a new key is required, create a
public-private key pair and make an <code translate="no" dir="ltr">apex_key</code> module. Use the <code translate="no" dir="ltr">key</code> property to
sign the APEX using the key. The public key is automatically included in the
APEX with the name <code translate="no" dir="ltr">avb_pubkey</code>.</p>

<pre class="prettyprint" translate="no" dir="ltr">
# create an rsa key pair
<code class="devsite-terminal" translate="no" dir="ltr">openssl genrsa -out foo.pem 4096</code>

# extract the public key from the key pair
<code class="devsite-terminal" translate="no" dir="ltr">avbtool extract_public_key --key foo.pem --output foo.avbpubkey</code>

# in Android.bp
<code translate="no" dir="ltr">apex_key {
    name: "apex.test.key",
    public_key: "foo.avbpubkey",
    private_key: "foo.pem",
}</code>
</pre>

<p>In the above example, the name of the public key (<code translate="no" dir="ltr">foo</code>) becomes the ID of the
key. The ID of the key used to sign an APEX is written in the APEX. At runtime,
<code translate="no" dir="ltr">apexd</code> verifies the APEX using a public key with the same ID in the device.</p>

<h3 id="zip_signing">ZIP signing</h3>

<p>Sign APEXs in the same way as APKs. Sign APEXs twice, once for the mini file
system (<code translate="no" dir="ltr">apex_payload.img</code> file) and once for the entire file.</p>

<p>To sign an APEX at the file-level, set the <code translate="no" dir="ltr">certificate</code> property in one of
these three ways:</p>

<ul>
<li>Not set: If no value is set, the APEX is signed with the certificate located
at <code translate="no" dir="ltr">PRODUCT_DEFAULT_DEV_CERTIFICATE</code>. If no flag is set, the path defaults
to <code translate="no" dir="ltr">build/target/product/security/testkey</code>.</li>
<li><code translate="no" dir="ltr">&lt;name&gt;</code>: The APEX is signed with the <code translate="no" dir="ltr">&lt;name&gt;</code> certificate in the same
directory as <code translate="no" dir="ltr">PRODUCT_DEFAULT_DEV_CERTIFICATE</code>.</li>
<li><code translate="no" dir="ltr">:&lt;name&gt;</code>: The APEX is signed with the certificate that is defined by the
Soong module named <code translate="no" dir="ltr">&lt;name&gt;</code>. The certificate module can be defined as
follows.</li>
</ul>
<pre class="prettyprint" translate="no" dir="ltr"><code translate="no" dir="ltr">android_app_certificate {
    name: &#34;my_key_name&#34;,
    certificate: &#34;dir/cert&#34;,
    // this will use dir/cert.x509.pem (the cert) and dir/cert.pk8 (the private key)
}
</code></pre><aside class="note"><strong>Note:</strong><span> The <code translate="no" dir="ltr">key</code> and <code translate="no" dir="ltr">certificate</code> values do NOT need to be derived from the same
public/private key pairs. APK signing (specified by <code translate="no" dir="ltr">certificate</code>) is required
because an APEX is an APK.</span></aside>
<h2 id="installing_an_apex">Installing an APEX</h2>

<p>To install an APEX, use ADB.</p>

<pre class="prettyprint" translate="no" dir="ltr">
<code class="devsite-terminal" translate="no" dir="ltr">adb install <var>apex_file_name</var></code>
<code class="devsite-terminal" translate="no" dir="ltr">adb reboot</code>
</pre>

<h2 id="using_an_apex">Using an APEX</h2>

<p>After reboot, the APEX is mounted at the <code translate="no" dir="ltr">/apex/&lt;apex_name&gt;@&lt;version&gt;</code>
directory. Multiple versions of the same APEX can be mounted at the same time.
Among the mount paths, the one that corresponds to the latest version is
bind-mounted at <code translate="no" dir="ltr">/apex/&lt;apex_name&gt;</code>.</p>

<p>Clients can use the bind-mounted path to read or execute files from APEX.</p>

<p>APEXs are typically used as follows:</p>

<ol>
<li>An OEM or ODM preloads an APEX under <code translate="no" dir="ltr">/system/apex</code> when the device is
shipped.</li>
<li>Files in the APEX are accessed via the <code translate="no" dir="ltr">/apex/&lt;apex_name&gt;/</code> path.</li>
<li>When an updated version of the APEX is installed in <code translate="no" dir="ltr">/data/apex</code>, the path
points to the new APEX after reboot.</li>
</ol>

<h3 id="updating_a_service_with_an_apex">Updating a service with an APEX</h3>

<p>To update a service using an APEX:</p>

<ol>
<li><p>Mark the service in the system partition as updatable. Add the option
<code translate="no" dir="ltr">updatable</code> to the service definition.</p>
<pre class="prettyprint" translate="no" dir="ltr"><code translate="no" dir="ltr">/system/etc/init/myservice.rc:

service myservice /system/bin/myservice
    class core
    user system
    ...
    updatable
</code></pre></li>
<li><p>Create a new <code translate="no" dir="ltr">.rc</code> file for the updated service. Use the <code translate="no" dir="ltr">override</code> option
to redefine the existing service.</p>
<pre class="prettyprint" translate="no" dir="ltr"><code translate="no" dir="ltr">/apex/my.apex@1/etc/init.rc:

service myservice /apex/my.apex@1/bin/myservice
    class core
    user system
    ...
    override
</code></pre></li>
</ol>

<p>Service definitions can only be defined in the <code translate="no" dir="ltr">.rc</code> file of an APEX. Action
triggers aren&#39;t supported in APEXs.</p>

<p>If a service marked as updatable starts before the APEXs are activated, the
start is delayed until the activation of the APEXs is complete.</p>

<h2 id="configuring_system_to_support_apex_updates">Configuring system to support APEX updates</h2>

<p>Set the following system property to <code translate="no" dir="ltr">true</code> to support APEX file updates.</p>
<pre class="prettyprint" translate="no" dir="ltr"><code translate="no" dir="ltr">&lt;device.mk&gt;:

PRODUCT_PROPERTY_OVERRIDES += ro.apex.updatable=true

BoardConfig.mk:
TARGET_FLATTEN_APEX := false
</code></pre>
<p>or just</p>
<pre class="prettyprint" translate="no" dir="ltr"><code translate="no" dir="ltr">&lt;device.mk&gt;:

$(call inherit-product, $(SRC_TARGET_DIR)/product/updatable_apex.mk)
</code></pre>
<h2 id="flattened_apex">Flattened APEX</h2>

<p>For legacy devices, it is sometimes impossible or infeasible to update the old
kernel to fully support APEX. For example, the kernel might have been built
without <code translate="no" dir="ltr">CONFIG_BLK_DEV_LOOP=Y</code>, which is crucial for mounting the file system
image inside an APEX.</p>

<p>Flattened APEX is a specially built APEX that can be activated on devices with
a legacy kernel. Files in a flattened APEX are directly installed to a directory
under the built-in partition. For example, <code translate="no" dir="ltr">lib/libFoo.so</code> in a flattend APEX
<code translate="no" dir="ltr">my.apex</code> is installed to <code translate="no" dir="ltr">/system/apex/my.apex/lib/libFoo.so</code>.</p>

<p>Activating a flattened APEX doesn&#39;t involve the loop device. The entire
directory <code translate="no" dir="ltr">/system/apex/my.apex</code> is directly bind-mounted to <code translate="no" dir="ltr">/apex/name@ver</code>.</p>

<p>Flattened APEXs can&#39;t be updated by downloading updated versions
of the APEXs from network because the downloaded APEXs can&#39;t be flattened.
Flattened APEXs can be updated only via a regular OTA.</p>

<p>Flattened APEX is the default configuration. This means that all
APEXs are by default flattened unless you explicitly configure your device
to build non-flattened APEXs to support APEX updates (as explained above).</p>

<p>Mixing flattened and non-flattened APEXs in a device is NOT
supported. APEXs in a device must either be all non-flattened or all flattened.
This is especially important when shipping pre-signed APEX prebuilts for
projects such as Mainline. APEXs that are not pre-signed (that is, built from
the source) should also be non-flattened and signed with proper keys. The
device should inherit from <code translate="no" dir="ltr">updatable_apex.mk</code> as explained in
<a href="#updating_a_service_with_an_apex">Updating a service with an APEX</a>.</p>

<h2 id="alternatives_considered_when_developing_apex">Alternatives considered when developing APEX</h2>

<p>Here are some options that we considered when designing the APEX file
format, and why we included or excluded them.</p>

<h3 id="regular_package_management_systems">Regular package management systems</h3>

<p>Linux distributions have package management systems like <code translate="no" dir="ltr">dpkg</code> and <code translate="no" dir="ltr">rpm</code>,
which are powerful, mature, robust. However, they weren&#39;t
adopted for APEX because they can&#39;t protect the packages after
installation. Verification is done only when packages are being installed.
Attackers can break the integrity of the installed packages unnoticed. This is
a regression for Android where all system components were stored in read-only
file systems whose integrity is protected by dm-verity for every I/O. Any
tampering to system components must be prohibited, or be detectable so that
the device can refuse to boot if compromised.</p>

<h3 id="dm-crypt_for_integrity">dm-crypt for integrity</h3>

<p>The files in an APEX container are from built-in partitions (for example, the
<code translate="no" dir="ltr">/system</code> partition) that are protected by dm-verity, where any modification to
the files are prohibited even after the partitions are mounted. To provide the
same level of security to the files, all files in an APEX are stored in a file
system image that is paired with a hash tree and a vbmeta descriptor. Without
dm-verity, an APEX in the <code translate="no" dir="ltr">/data</code> partition is vulnerable to unintended
modifications made after it&#39;s verified and installed.</p>

<p>In fact, the <code translate="no" dir="ltr">/data</code> partition is also protected by encryption layers such as
dm-crypt. Although this provides some level of protection against tampering, its
primary purpose is privacy, not integrity. When an attacker gains access to the
<code translate="no" dir="ltr">/data</code> partition, there can be no further protection, and this again is a
regression compared to every system component being in the <code translate="no" dir="ltr">/system</code> partition.
The hash tree inside an APEX file together with dm-verity provides the same
level of content protection.</p>

<h3 id="redirecting_paths_from_system_to_apex">Redirecting paths from <code translate="no" dir="ltr">/system</code> to <code translate="no" dir="ltr">/apex</code></h3>

<p>System component files packaged in an APEX are accessible via new paths like
<code translate="no" dir="ltr">/apex/&lt;name&gt;/lib/libfoo.so</code>. When the files were part of the <code translate="no" dir="ltr">/system</code>
partition, they were accessible via paths such as <code translate="no" dir="ltr">/system/lib/libfoo.so</code>. A
client of an APEX file (other APEX files or the platform) should use the new
paths. This change in paths might require updates to the existing code.</p>

<p>One way to avoid the path change is to overlay the file contents in an APEX
file over the <code translate="no" dir="ltr">/system</code> partition. However, we decided not to overlay files over
the <code translate="no" dir="ltr">/system</code> partition because we believed this would negatively affect
performance as the number of files being overlayed (possibly even stacked one
after another) increases.</p>

<p>Another option was to hijack file access functions such as <code translate="no" dir="ltr">open</code>, <code translate="no" dir="ltr">stat</code>, and
<code translate="no" dir="ltr">readlink</code>, so that paths that start with <code translate="no" dir="ltr">/system</code> are redirected to their
corresponding paths under <code translate="no" dir="ltr">/apex</code>. We discarded this option because it&#39;s
practically infeasible to change all functions that accept paths. For
example, some apps statically link Bionic, which implements the functions. In
that case, the redirection won&#39;t happen for the app.</p>

          </div>

    
                   <devsite-page-rating position="footer" selected-rating="0" hover-rating-star="0">
         </devsite-page-rating>
                   
          </article>
</article>

<devsite-content-footer class="nocontent">
  <p>Content and code samples on this page are subject to the licenses described in the <a href="../../../license.html">Content License</a>. Java is a registered trademark of Oracle and/or its affiliates.</p>
</devsite-content-footer>


                      </devsite-content>
        </div>
        <devsite-footer-promos class="devsite-footer">
                      
                  </devsite-footer-promos>
        <devsite-footer-linkboxes class="devsite-footer">
                      <nav class="devsite-footer-linkboxes nocontent">
  <ul class="devsite-footer-linkboxes-list">
        <li class="devsite-footer-linkbox ">
    <h3 class="devsite-footer-linkbox-heading">Build</h3>      <ul class="devsite-footer-linkbox-list">
                <li class="devsite-footer-linkbox-item">
          <a href="http://android.googlesource.com/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 1)"           >
            Android repository
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="../../../setup/build/requirements.html"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 2)"           >
            Requirements
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="../../../setup/build/downloading.html"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 3)"           >
            Downloading
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://developers.google.com/android/blobs-preview/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 4)"           >
            Preview binaries
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://developers.google.com/android/images/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 5)"           >
            Factory images
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://developers.google.com/android/drivers/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 6)"           >
            Driver binaries
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://android.github.io/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 7)"           >
            GitHub
          </a>
        </li>
              </ul>
    </li>
        <li class="devsite-footer-linkbox ">
    <h3 class="devsite-footer-linkbox-heading">Connect</h3>      <ul class="devsite-footer-linkbox-list">
                <li class="devsite-footer-linkbox-item">
          <a href="http://twitter.com/Android/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 1)"           >
            @Android on Twitter
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://twitter.com/AndroidDev/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 2)"           >
            @AndroidDev on Twitter
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://blog.google/products/android/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 3)"           >
            Android Blog
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://security.googleblog.com/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 4)"           >
            Google Security Blog
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://groups.google.com/forum/?fromgroups#!forum/android-platform/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 5)"           >
            Platform on Google Groups
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://groups.google.com/forum/?fromgroups#!forum/android-building/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 6)"           >
            Building on Google Groups
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://groups.google.com/forum/?fromgroups#!forum/android-porting/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 7)"           >
            Porting on Google Groups
          </a>
        </li>
              </ul>
    </li>
        <li class="devsite-footer-linkbox ">
    <h3 class="devsite-footer-linkbox-heading">Get help</h3>      <ul class="devsite-footer-linkbox-list">
                <li class="devsite-footer-linkbox-item">
          <a href="http://support.google.com/android/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 1)"           >
            Android Help Center
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://support.google.com/pixelphone/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 2)"           >
            Pixel Help Center
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://support.google.com/nexus/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 3)"           >
            Nexus Help Center
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://www.android.com/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 4)"           >
            www.android.com
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://www.android.com/gms/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 5)"           >
            Google Mobile Services
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://stackoverflow.com/questions/tagged/android-source/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 6)"           >
            Stack Overflow
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://issuetracker.google.com/issues?q=status:open%20componentid:190923"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 7)"           >
            Issue Tracker
          </a>
        </li>
              </ul>
    </li>
      </ul>
</nav>
                  </devsite-footer-linkboxes>
        <devsite-footer-utility class="devsite-footer">
                      
<div class="devsite-footer-utility">
  
  <nav class="devsite-nav">
        <ul class="devsite-footer-utility-list">
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="../../../source/index.html"
           data-category="Site-Wide Custom Events"
           data-label="Footer About Android link">
          About Android
        </a>
              </li>
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="../../../setup/community.html"
           data-category="Site-Wide Custom Events"
           data-label="Footer Community link">
          Community
        </a>
              </li>
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="../../../legal.html"
           data-category="Site-Wide Custom Events"
           data-label="Footer Legal link">
          Legal
        </a>
              </li>
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="../../../license.html"
           data-category="Site-Wide Custom Events"
           data-label="Footer License link">
          License
        </a>
              </li>
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="http://policies.google.cn/privacy"
           data-category="Site-Wide Custom Events"
           data-label="Footer Privacy link">
          Privacy
        </a>
              </li>
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="http://issuetracker.google.com/issues/new?component=191476"
           data-category="Site-Wide Custom Events"
           data-label="Footer Site feedback link">
          Site feedback
        </a>
              </li>
          </ul>
    
    <devsite-language-selector>
  <devsite-select class="devsite-language-selector-menu">
    <select class="devsite-language-selector-select"
            name="language"
            track-name="click"
            track-type="languageSelector">
                <option>Language</option>
              <option value="en"
              track-metadata-original-language="en"
              track-metadata-selected-language="en"
              track-name="changed"
              track-type="languageSelector"
            >
        English
      </option>
          <option value="zh_cn"
              track-metadata-original-language="en"
              track-metadata-selected-language="zh_cn"
              track-name="changed"
              track-type="languageSelector"
            >
        中文 – 简体
      </option>
        </select>
  </devsite-select>
</devsite-language-selector>

  </nav>
</div>
                  </devsite-footer-utility>
      </div></div>
    <devsite-sitemask></devsite-sitemask>
    <devsite-snackbar                   ></devsite-snackbar>    <devsite-tooltip blocked-link></devsite-tooltip>
    <devsite-analytics>
              <script type="application/json" analytics>[{"metrics": {"ratings_value": "metric1", "ratings_count": "metric2"}, "dimensions": {}, "gaid": "UA-45455297-4"}]</script>
<script type="application/json" gtm>[]</script>
          </devsite-analytics>
        <script>
    (function(d,e,v,s,i,t,E){d['GoogleDevelopersObject']=i;
    t=e.createElement(v);t.async=1;t.src=s;E=e.getElementsByTagName(v)[0];
    E.parentNode.insertBefore(t,E);})(window, document, 'script',
    'https://www.gstatic.com/devrel-devsite/vbb62cc5a3e8f17e37bae4792b437f28f787df3f9cf9732cbfcc99b4f4ff41a54/js/app_loader.js', '[7,"en",null,"../../../js/devsite_app.html","https://www.gstatic.com/devrel-devsite/vbb62cc5a3e8f17e37bae4792b437f28f787df3f9cf9732cbfcc99b4f4ff41a54","https://www.gstatic.com/devrel-devsite/vbb62cc5a3e8f17e37bae4792b437f28f787df3f9cf9732cbfcc99b4f4ff41a54/androidsource","https://androidsource-dot-google-developers.gonglchuangl.net/",null,null,["/_pwa/androidsource/manifest.json","https://www.gstatic.com/devrel-devsite/vbb62cc5a3e8f17e37bae4792b437f28f787df3f9cf9732cbfcc99b4f4ff41a54/images/video-placeholder.svg","https://www.gstatic.com/devrel-devsite/vbb62cc5a3e8f17e37bae4792b437f28f787df3f9cf9732cbfcc99b4f4ff41a54/androidsource/images/rebrand/favicon.png","https://www.gstatic.com/devrel-devsite/vbb62cc5a3e8f17e37bae4792b437f28f787df3f9cf9732cbfcc99b4f4ff41a54/androidsource/images/rebrand/lockup.svg","https://fonts.googleapis.com/css?family=Roboto:300,400,400italic,500,500italic,700,700italic|Roboto+Mono:400,500,700|Material+Icons"]]')
  </script>  </body>

<!-- Mirrored from source.android.google.cn/devices/tech/ota/apex by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 09 Sep 2019 14:58:17 GMT -->
</html>