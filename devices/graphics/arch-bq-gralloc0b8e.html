<!doctype html>
<html  lang="zh_cn">
  
<!-- Mirrored from source.android.google.cn/devices/graphics/arch-bq-gralloc.html?hl=zh-cn by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 16 Mar 2019 20:41:15 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
          
<title>BufferQueue 和 gralloc &nbsp;|&nbsp; Android Open Source Project</title>

<meta property="og:title" content="BufferQueue 和 gralloc &nbsp;|&nbsp; Android Open Source Project">

  <meta property="og:url" content="arch-bq-gralloc.html">

  <meta property="og:locale" content="zh_cn">


    
    
    
  
        <meta property="og:site_name" content="Android Open Source Project">
    <meta property="og:type" content="website">
    
          <meta name="theme-color" content="#78c257">
    
    <meta charset="utf-8">
    <meta content="IE=Edge" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="../../_pwa/androidsource/manifest.json">
    <link rel="preconnect" href="http://www.gstatic.com/" crossorigin>
    <link rel="preconnect" href="http://fonts.gstatic.com/" crossorigin>
    <link rel="preconnect" href="http://fonts.googleapis.com/" crossorigin>
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:300,400,400italic,500,500italic,700,700italic|Roboto+Mono:400,500,700|Material+Icons">
    <link rel="stylesheet" href="https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/css/app.css">
    <noscript>
      <link rel="stylesheet" href="https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/css/ce_bundle.css">
    </noscript>
    <link rel="shortcut icon" href="https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/images/favicon.png">
    <link rel="apple-touch-icon" href="https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/images/touchicon-180.png"><link rel="canonical" href="arch-bq-gralloc.html"></head>
  <body type="article"
        theme="androidsource-theme"
        class=""
        
        layout="docs"
        pending>
    <devsite-progress type="indeterminate" id="app-progress"></devsite-progress>
    <div class="devsite-wrapper"><devsite-header ds-is="header" keep-tabs-visible>
      








<div class="devsite-header--inner">
  <div class="devsite-top-logo-row-wrapper-wrapper">
    <div class="devsite-top-logo-row-wrapper">
      <div class="devsite-top-logo-row">
        <button type="button" id="devsite-hamburger-menu"
          class="devsite-header-icon-button button-flat material-icons gc-analytics-event"
          data-category="Site-Wide Custom Events"
          data-label="Navigation menu button"
          visually-hidden
          aria-label="Close menu">
        </button>
        <div class="devsite-product-name-wrapper">
  <a href="../../index0b8e.html?hl=zh-cn" class="devsite-site-logo-link gc-analytics-event"
   data-category="Site-Wide Custom Events" data-label="Site logo">
  <img src="https://www.gstatic.cn/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/images/lockup.svg" class="devsite-site-logo" alt="Android Open Source Project">
</a>
            <span class="devsite-product-name">
            <ul class="devsite-breadcrumb-list">
    <li class="devsite-breadcrumb-item">
                              </li>
  </ul>
          </span>
        
</div>        <div class="devsite-top-logo-row-middle">
          <div class="devsite-header-upper-tabs">
                          <devsite-tabs ds-is="tabs" class="upper-tabs">
  <div class="devsite-tabs-wrapper">
                  <tab >
          <a href="../../setup0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="设置"
           data-category="Site-Wide Custom Events"
        data-label="Tab: 设置"
   >
  设置
</a>

        </tab>
                        <tab >
          <a href="../../compatibility0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="设计"
           data-category="Site-Wide Custom Events"
        data-label="Tab: 设计"
   >
  设计
</a>

        </tab>
                        <tab >
          <a href="../../security0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="安全性"
           data-category="Site-Wide Custom Events"
        data-label="Tab: 安全性"
   >
  安全性
</a>

        </tab>
                        <tab active>
          <a href="../audio0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="开发"
   aria-label="开发, selected"         data-category="Site-Wide Custom Events"
        data-label="Tab: 开发"
   >
  开发
</a>

        </tab>
                        <tab >
          <a href="../tech/dalvik0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="配置"
           data-category="Site-Wide Custom Events"
        data-label="Tab: 配置"
   >
  配置
</a>

        </tab>
                        <tab >
          <a href="../../reference0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="参考"
           data-category="Site-Wide Custom Events"
        data-label="Tab: 参考"
   >
  参考
</a>

        </tab>
            </div>
</devsite-tabs>

                       </div>
          <devsite-search ds-is="search"
            enable-suggestions
                  project-path="">
  <form class="devsite-search-form" action="https://source.android.google.cn/s/results/?hl=zh-cn" method="GET">
    <div class="devsite-search-container">
      <div id="searchbox" class="devsite-searchbox">
                <input placeholder="搜索"
          type="text"
          class="devsite-search-field devsite-search-query"
          name="q"
          value=""
          autocomplete="off"
                    aria-label="搜索框">
        <div class="devsite-search-image material-icons"></div>
      </div>
      <button type="button"
              search-open
              class="devsite-search-button devsite-header-icon-button button-flat material-icons"
              aria-label="Open search box"></button>
    </div>
  </form>
  <button type="button"
          search-close
          class="devsite-search-button devsite-header-icon-button button-flat material-icons"
          aria-label="Close search box"></button>
</devsite-search>

        </div>

                <a class="devsite-header-link devsite-top-button button gc-analytics-event"
           href="http://android-review.googlesource.com/"
           data-category="Site-Wide Custom Events"
           data-label="Site header link">
          转到源代码
        </a>
                      </div>    </div>  </div>
  <div class="devsite-collapsible-section
    ">
    <div class="devsite-header-background">
                        <div class="devsite-product-id-row">
            <div class="devsite-product-description-row">
                              <ul class="devsite-breadcrumb-list">
    <li class="devsite-breadcrumb-item">
                    <a href="../audio0b8e.html?hl=zh-cn"              class="devsite-breadcrumb-link gc-analytics-event"
              data-category="Site-Wide Custom Events"
              data-label="Lower Header"
              data-value="1"
          >
            开发
      
  </a>
        </li>
  </ul>
                                        </div>
                                                                                    </div>
                                      <div class="devsite-doc-set-nav-row">
                              <devsite-tabs ds-is="tabs" class="lower-tabs">
  <div class="devsite-tabs-wrapper">
                  <tab >
          <a href="../audio0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="音频"
           data-category="Site-Wide Custom Events"
        data-label="Tab: 音频"
   >
  音频
</a>

        </tab>
                        <tab >
          <a href="../camera0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="相机"
           data-category="Site-Wide Custom Events"
        data-label="Tab: 相机"
   >
  相机
</a>

        </tab>
                        <tab >
          <a href="../tech/connect0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="连接"
           data-category="Site-Wide Custom Events"
        data-label="Tab: 连接"
   >
  连接
</a>

        </tab>
                        <tab active>
          <a href="../graphics0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="图形"
   aria-label="图形, selected"         data-category="Site-Wide Custom Events"
        data-label="Tab: 图形"
   >
  图形
</a>

        </tab>
                        <tab >
          <a href="../input0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="互动"
           data-category="Site-Wide Custom Events"
        data-label="Tab: 互动"
   >
  互动
</a>

        </tab>
                        <tab >
          <a href="../media0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="媒体"
           data-category="Site-Wide Custom Events"
        data-label="Tab: 媒体"
   >
  媒体
</a>

        </tab>
                        <tab >
          <a href="../storage0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="存储"
           data-category="Site-Wide Custom Events"
        data-label="Tab: 存储"
   >
  存储
</a>

        </tab>
            </div>
</devsite-tabs>

        </div>
          </div>  </div></div>
  

  </devsite-header>      <devsite-book-nav ds-is="book-nav" scrollbars >
                  

<nav class="devsite-book-nav devsite-nav nocontent">
  <div class="devsite-mobile-header">
    <button type="button"
            id="devsite-close-nav"
            class="devsite-header-icon-button button-flat material-icons gc-analytics-event"
            data-category="Site-Wide Custom Events"
            data-label="Close navigation"
            aria-label="Close navigation">
    </button>
  </div>

  <div class="devsite-book-nav-wrapper">
    <div class="devsite-mobile-nav-top">
              <ul class="devsite-nav-list">
                      <li class="devsite-nav-item">
                                <a href="../../setup.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 设置">
      <span class="devsite-nav-text" >设置</span>
        </a>
  
                                        </li>
                      <li class="devsite-nav-item">
                                <a href="../../compatibility.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 设计">
      <span class="devsite-nav-text" >设计</span>
        </a>
  
                                        </li>
                      <li class="devsite-nav-item">
                                <a href="../../security.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 安全性">
      <span class="devsite-nav-text" >安全性</span>
        </a>
  
                                        </li>
                      <li class="devsite-nav-item">
                                <a href="../audio.html"
          class="devsite-nav-title gc-analytics-event
            devsite-nav-active"
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 开发">
      <span class="devsite-nav-text" >开发</span>
        </a>
  
                                            <ul class="devsite-nav-responsive-tabs">
                                                                                                                      <li class="devsite-nav-item">
    <a href="../audio.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 音频">
      <span class="devsite-nav-text" >音频</span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="../camera.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 相机">
      <span class="devsite-nav-text" >相机</span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="../tech/connect.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 连接">
      <span class="devsite-nav-text" >连接</span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="../graphics.html"
     id="devsite-nav-forward"     class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 图形">
      <span class="devsite-nav-text" menu="_book">图形</span>
        <span class="devsite-nav-icon material-icons" data-icon="forward"
          menu="_book">
    </span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="../input.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 互动">
      <span class="devsite-nav-text" >互动</span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="../media.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 媒体">
      <span class="devsite-nav-text" >媒体</span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="../storage.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 存储">
      <span class="devsite-nav-text" >存储</span>
        </a>
  </li>

                                  </ul>
                          </li>
                      <li class="devsite-nav-item">
                                <a href="../tech/dalvik.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 配置">
      <span class="devsite-nav-text" >配置</span>
        </a>
  
                                        </li>
                      <li class="devsite-nav-item">
                                <a href="../../reference.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 参考">
      <span class="devsite-nav-text" >参考</span>
        </a>
  
                                        </li>
                                <li class="devsite-nav-item">
    <a href="http://android-review.googlesource.com/"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 转到源代码">
      <span class="devsite-nav-text" >转到源代码</span>
        </a>
  </li>

                  </ul>
          </div>
          <div class="devsite-mobile-nav-bottom">
                                      <ul class="devsite-nav-list" menu="_book">
                                    <li class="devsite-nav-item"><a href="../graphics.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="概览">概览</span></a></li>
                          <li class="devsite-nav-item           devsite-nav-expandable"><devsite-expandable-nav ds-is="expandable-nav" collapsed>
    <a class="devsite-nav-toggle"></a><div class="devsite-nav-title devsite-nav-title-no-path" tabindex="0"><span class="devsite-nav-text" title="架构">架构</span></div><ul class="devsite-nav-section"><li class="devsite-nav-item"><a href="architecture.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="概览">概览</span></a></li><li class="devsite-nav-item"><a href="arch-bq-gralloc.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="BufferQueue">BufferQueue</span></a></li><li class="devsite-nav-item"><a href="arch-sf-hwc.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="SurfaceFlinger 和 HWC">SurfaceFlinger 和 HWC</span></a></li><li class="devsite-nav-item"><a href="arch-sh.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Surface 和 SurfaceHolder">Surface 和 SurfaceHolder</span></a></li><li class="devsite-nav-item"><a href="arch-egl-opengl.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="OpenGL ES">OpenGL ES</span></a></li><li class="devsite-nav-item"><a href="renderer.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="OpenGLRenderer 配置">OpenGLRenderer 配置</span></a></li><li class="devsite-nav-item"><a href="arch-vulkan.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Vulkan">Vulkan</span></a></li><li class="devsite-nav-item"><a href="arch-sv-glsv.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="SurfaceView">SurfaceView</span></a></li><li class="devsite-nav-item"><a href="arch-st.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="SurfaceTexture">SurfaceTexture</span></a></li><li class="devsite-nav-item"><a href="arch-tv.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="TextureView">TextureView</span></a></li><li class="devsite-nav-item"><a href="arch-gameloops.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="游戏循环">游戏循环</span></a></li></ul></devsite-expandable-nav></li>
                          <li class="devsite-nav-item           devsite-nav-expandable"><devsite-expandable-nav ds-is="expandable-nav" collapsed>
    <a class="devsite-nav-toggle"></a><div class="devsite-nav-title devsite-nav-title-no-path" tabindex="0"><span class="devsite-nav-text" title="实现">实现</span></div><ul class="devsite-nav-section"><li class="devsite-nav-item"><a href="implement.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="概览">概览</span></a></li><li class="devsite-nav-item"><a href="implement-hwc.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="硬件混合渲染器 HAL">硬件混合渲染器 HAL</span></a></li><li class="devsite-nav-item"><a href="implement-vsync.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="VSYNC">VSYNC</span></a></li><li class="devsite-nav-item"><a href="implement-vulkan.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Vulkan">Vulkan</span></a></li><li class="devsite-nav-item"><a href="implement-vdisplays.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="虚拟显示屏">虚拟显示屏</span></a></li></ul></devsite-expandable-nav></li>
                          <li class="devsite-nav-item           devsite-nav-expandable"><devsite-expandable-nav ds-is="expandable-nav" collapsed>
    <a class="devsite-nav-toggle"></a><div class="devsite-nav-title devsite-nav-title-no-path" tabindex="0"><span class="devsite-nav-text" title="OpenGL ES 测试">OpenGL ES 测试</span></div><ul class="devsite-nav-section"><li class="devsite-nav-item"><a href="testing.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="概览">概览</span></a></li><li class="devsite-nav-item"><a href="build-tests.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="编译测试程序">编译测试程序</span></a></li><li class="devsite-nav-item"><a href="port-tests.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="移植测试框架">移植测试框架</span></a></li><li class="devsite-nav-item"><a href="run-tests.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="运行测试">运行测试</span></a></li><li class="devsite-nav-item"><a href="automate-tests.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="自动执行测试">自动执行测试</span></a></li><li class="devsite-nav-item"><a href="test-groups.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="使用特殊测试组">使用特殊测试组</span></a></li><li class="devsite-nav-item"><a href="cts-integration.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="与 Android CTS 集成">与 Android CTS 集成</span></a></li></ul></devsite-expandable-nav></li>
                          <li class="devsite-nav-item"><a href="tracing-win-transitions.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="跟踪窗口转换">跟踪窗口转换</span></a></li>
                      </ul>
                                                                                                                                                                            </div>
      </div>
</nav>
              </devsite-book-nav>
      <div id="gc-wrapper">
        <div class="devsite-main-content"
            has-book-nav            has-toc>
          <devsite-toc ds-is="toc" class="devsite-nav"
            ></devsite-toc>
          <devsite-content ds-is="content">
                          

<article class="devsite-article">
  <article class="devsite-article-inner">    
    <div class="devsite-article-meta">
      <ul class="devsite-breadcrumb-list">
    <li class="devsite-breadcrumb-item">
                    <a href="../../index0b8e.html?hl=zh-cn"              class="devsite-breadcrumb-link gc-analytics-event"
              data-category="Site-Wide Custom Events"
              data-label="Breadcrumbs"
              data-value="1"
          >
            AOSP
      
  </a>
        </li>
    <li class="devsite-breadcrumb-item">
                <div class="devsite-breadcrumb-guillemet material-icons"></div>
                    <a href="../audio0b8e.html?hl=zh-cn"              class="devsite-breadcrumb-link gc-analytics-event"
              data-category="Site-Wide Custom Events"
              data-label="Breadcrumbs"
              data-value="2"
          >
            开发
      
  </a>
        </li>
    <li class="devsite-breadcrumb-item">
                <div class="devsite-breadcrumb-guillemet material-icons"></div>
                    <a href="../graphics0b8e.html?hl=zh-cn"              class="devsite-breadcrumb-link gc-analytics-event"
              data-category="Site-Wide Custom Events"
              data-label="Breadcrumbs"
              data-value="3"
          >
            图形
      
  </a>
        </li>
  </ul>
               <devsite-page-rating position="header" selected-rating="0" hover-rating-star="0">
         </devsite-page-rating>
          </div>

              <h1 class="devsite-page-title">BufferQueue 和 gralloc</h1>
    
    <devsite-toc ds-is="toc" class="devsite-nav" devsite-toc-embedded
                 ></devsite-toc>

    <div class="devsite-article-body clearfix
      ">

              
  <!--
      Copyright 2017 The Android Open Source Project

      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.
  -->

<p>要了解 Android 图形系统，需首先了解后台的 BufferQueue 和 gralloc HAL。</p>

<p>BufferQueue 类是 Android 中所有图形处理操作的核心。它的作用很简单：将生成图形数据缓冲区的一方（生产方）连接到接受数据以进行显示或进一步处理的一方（消耗方）。<em></em><em></em>几乎所有在系统中移动图形数据缓冲区的内容都依赖于 BufferQueue。</p>

<p>gralloc 内存分配器会进行缓冲区分配，并通过供应商特定的 HAL 接口来实现（请参见 <code>hardware/libhardware/include/hardware/gralloc.h</code>）。<code>alloc()</code> 函数获得预期的参数（宽度、高度、像素格式）以及一组用法标记（详见下文）。</p>

<h2 id="BufferQueue">BufferQueue 生产方和消耗方</h2>

<p>基本用法很简单：生产方请求一个可用的缓冲区 (<code>dequeueBuffer()</code>)，并指定一组特性，包括宽度、高度、像素格式和用法标记。生产方填充缓冲区并将其返回到队列 (<code>queueBuffer()</code>)。随后，消耗方获取该缓冲区 (<code>acquireBuffer()</code>) 并使用该缓冲区的内容。当消耗方操作完毕后，将该缓冲区返回到队列 (<code>releaseBuffer()</code>)。</p>

<p><em></em>最新的 Android 设备支持“同步框架”，这使得系统能够在与可以异步处理图形数据的硬件组件结合使用时提高工作效率。例如，生产方可以提交一系列 OpenGL ES 绘制命令，然后在渲染完成之前将输出缓冲区加入队列。该缓冲区伴有一个栅栏，当内容准备就绪时，栅栏会发出信号。当该缓冲区返回到空闲列表时，会伴有第二个栅栏，因此消耗方可以在内容仍在使用期间释放该缓冲区。该方法缩短了缓冲区通过系统时的延迟时间，并提高了吞吐量。</p>

<p>队列的一些特性（例如可以容纳的最大缓冲区数）由生产方和消耗方联合决定。但是，BufferQueue 负责根据需要分配缓冲区。除非特性发生变化，否则将会保留缓冲区；例如，如果生产方请求具有不同大小的缓冲区，则系统会释放旧的缓冲区，并根据需要分配新的缓冲区。</p>

<p>生产方和消耗方可以存在于不同的进程中。目前，消耗方始终创建和拥有数据结构。在旧版本的 Android 中，只有生产方才进行 Binder 处理（即生产方可能在远程进程中，但消耗方必须存在于创建队列的进程中）。Android 4.4 和更高版本已发展为更常规的实现。</p>

<p>BufferQueue 永远不会复制缓冲区内容（移动如此多的数据是非常低效的操作）。相反，缓冲区始终通过句柄进行传递。</p>

<h2 id="gralloc_HAL">gralloc HAL 用法标记</h2>

<p>gralloc 分配器不仅仅是在原生堆上分配内存的另一种方法；在某些情况下，分配的内存可能并非缓存一致，或者可能完全无法从用户空间访问。分配的性质由用法标记确定，这些标记包括以下属性：</p>

<ul>
<li>从软件 (CPU) 访问内存的频率</li>
<li>从硬件 (GPU) 访问内存的频率</li>
<li>是否将内存用作 OpenGL ES (GLES) 纹理</li>
<li>视频编码器是否会使用内存</li>
</ul>

<p>例如，如果您的格式指定 RGBA 8888 像素，并且您指明将从软件访问缓冲区（这意味着您的应用将直接触摸像素），则分配器必须按照 R-G-B-A 的顺序为每个像素创建 4 个字节的缓冲区。相反，如果您指明仅从硬件访问缓冲区且缓冲区作为 GLES 纹理，则分配器可以执行 GLES 驱动程序所需的任何操作 - BGRA 排序、非线性搅和布局、替代颜色格式等。允许硬件使用其首选格式可以提高性能。</p>

<p>某些值在特定平台上无法组合。例如，视频编码器标记可能需要 YUV 像素，因此将无法添加软件访问权并指定 RGBA 8888。</p>

<p>gralloc 分配器返回的句柄可以通过 Binder 在进程之间传递。</p>

<h2 id="tracking">使用 Systrace 跟踪 BufferQueue</h2>

<p>要真正了解图形缓冲区如何移动，请使用 Systrace。系统级图形代码经过很好的检测，很多相关的应用框架代码也是如此。</p>

<p>要完整地说明如何有效地使用 Systrace，则需要很长的篇幅。我们首先介绍如何启用 <code>gfx</code>、<code>view</code> 和 <code>sched</code> 标记。您还将在跟踪记录中看到 BufferQueue。如果您以前使用过 Systrace，则可能已经见到过它们，但不知道它们是什么。例如，如果您在 <a href="https://github.com/google/grafika">Grafika</a> 的“播放视频 (SurfaceView)”正在运行时获取跟踪记录，则标有 SurfaceView 的行会告诉您在任何给定时间排队的缓冲区数量。<em></em></p>

<p>当应用处于活动状态时，该值会递增（触发 MediaCodec 解码器渲染帧），而在 SurfaceFlinger 正在工作和消耗缓冲区时，该值会递减。当以 30fps 的帧率显示视频时，队列的值从 0 变为 1，因为大约 60fps 的显示速度可以轻松跟上来源的帧率。（另请注意，SurfaceFlinger 仅在有工作要执行时才被唤醒，而不是每秒唤醒 60 次。系统会尽力尝试避免工作，而且如果屏幕没有任何更新，将完全停用 VSYNC。）</p>

<p>如果您切换到 Grafika 的“播放视频 (TextureView)”并获取新的跟踪记录，将看到一个标为 com.android.grafika/com.android.grafika.PlayMovieActivity 的行。这是主界面层，其只是另一个 BufferQueue。由于 TextureView 渲染到界面层（而不是单独的层），因此您将在此看到所有视频驱动的更新。</p>

<p>有关 Systrace 工具的更多信息，请参阅 <a href="https://developer.android.google.cn/studio/profile/systrace-commandline.html?hl=zh-cn">Systrace 文档</a>。</p>


          </div>

    
                   <devsite-page-rating position="footer" selected-rating="0" hover-rating-star="0">
         </devsite-page-rating>
                   
          </article>
</article>

<devsite-content-footer ds-is="content-footer" class="nocontent">
  <p>Content and code samples on this page are subject to the licenses described in the <a href="../../license0b8e.html?hl=zh-cn">Content License</a>. Java is a registered trademark of Oracle and/or its affiliates.</p>
</devsite-content-footer>


                      </devsite-content>
        </div>
        <devsite-footer-promos ds-is="footer-promos" class="devsite-footer">
                      
                  </devsite-footer-promos>
        <devsite-footer-linkboxes ds-is="footer-linkboxes" class="devsite-footer">
                      <nav class="devsite-footer-linkboxes nocontent">
  <ul class="devsite-footer-linkboxes-list">
        <li class="devsite-footer-linkbox ">
    <h3 class="devsite-footer-linkbox-heading">构建</h3>      <ul class="devsite-footer-linkbox-list">
                <li class="devsite-footer-linkbox-item">
          <a href="http://android.googlesource.com/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 1)"           >
            Android 代码库
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="../../setup/build/requirements.html"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 2)"           >
            要求
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="../../setup/build/downloading.html"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 3)"           >
            下载
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://developers.google.com/android/blobs-preview/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 4)"           >
            预览二进制文件
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://developers.google.com/android/images/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 5)"           >
            出厂映像
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://developers.google.com/android/drivers/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 6)"           >
            驱动程序二进制文件
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://android.github.io/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 7)"           >
            GitHub
          </a>
        </li>
              </ul>
    </li>
        <li class="devsite-footer-linkbox ">
    <h3 class="devsite-footer-linkbox-heading">关注</h3>      <ul class="devsite-footer-linkbox-list">
                <li class="devsite-footer-linkbox-item">
          <a href="http://twitter.com/Android/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 1)"           >
            在 Twitter 上 @Android
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://twitter.com/AndroidDev/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 2)"           >
            在 Twitter 上 @AndroidDev
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://blog.google/products/android/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 3)"           >
            Android 博客
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://security.googleblog.com/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 4)"           >
            Google 安全博客
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://groups.google.com/forum/?fromgroups#!forum/android-platform/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 5)"           >
            Google 网上论坛上的 Android 平台论坛
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://groups.google.com/forum/?fromgroups#!forum/android-building/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 6)"           >
            Google 网上论坛上的 Android 构建论坛
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://groups.google.com/forum/?fromgroups#!forum/android-porting/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 7)"           >
            Google 网上论坛上的 Android 移植论坛
          </a>
        </li>
              </ul>
    </li>
        <li class="devsite-footer-linkbox ">
    <h3 class="devsite-footer-linkbox-heading">获取帮助</h3>      <ul class="devsite-footer-linkbox-list">
                <li class="devsite-footer-linkbox-item">
          <a href="http://support.google.com/android/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 1)"           >
            Android 帮助中心
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://support.google.com/pixelphone/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 2)"           >
            Pixel 帮助中心
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://support.google.com/nexus/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 3)"           >
            Nexus 帮助中心
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://www.android.com/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 4)"           >
            www.android.com
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://www.android.com/gms/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 5)"           >
            Google Mobile Services
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://stackoverflow.com/questions/tagged/android-source/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 6)"           >
            Stack Overflow
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://issuetracker.google.com/issues?q=status:open%20componentid:190923"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 7)"           >
            问题跟踪器
          </a>
        </li>
              </ul>
    </li>
      </ul>
</nav>
                  </devsite-footer-linkboxes>
        <devsite-footer-utility ds-is="footer-utility" class="devsite-footer">
                      <div class="devsite-footer-utility">
  
  <nav class="devsite-nav">
        <ul class="devsite-footer-utility-list">
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="../../source/index0b8e.html?hl=zh-cn"
           data-category="Site-Wide Custom Events"
           data-label="Footer About Android link">
          关于 Android
        </a>
              </li>
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="../../source/community0b8e.html?hl=zh-cn"
           data-category="Site-Wide Custom Events"
           data-label="Footer Community link">
          社区
        </a>
              </li>
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="../../legal0b8e.html?hl=zh-cn"
           data-category="Site-Wide Custom Events"
           data-label="Footer Legal link">
          法律条款
        </a>
              </li>
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="../../license0b8e.html?hl=zh-cn"
           data-category="Site-Wide Custom Events"
           data-label="Footer License link">
          许可
        </a>
              </li>
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="http://policies.google.cn/privacy?hl=zh-cn"
           data-category="Site-Wide Custom Events"
           data-label="Footer Privacy link">
          隐私权政策
        </a>
              </li>
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="http://issuetracker.google.com/issues/new?component=191476&amp;hl=zh-cn"
           data-category="Site-Wide Custom Events"
           data-label="Footer Site feedback link">
          网站反馈
        </a>
              </li>
          </ul>
    
        <form class="devsite-footer-utility-language">
      <select class="devsite-footer-utility-language-select"
              name="language"
              track-name="click"
              track-type="languageSelector">
                  <option value="en"
                  track-metadata-original-language="zh_cn"
                  track-metadata-selected-language="en"
                  track-name="changed"
                  track-type="languageSelector"
                  >
            English
          </option>
                  <option value="zh_cn"
                  track-metadata-original-language="zh_cn"
                  track-metadata-selected-language="zh_cn"
                  track-name="changed"
                  track-type="languageSelector"
                  selected="selected">
            简体中文
          </option>
              </select>
    </form>
      </nav>
</div>
                  </devsite-footer-utility>
      </div></div>
    <devsite-sitemask ds-is="site-mask"></devsite-sitemask>
    <devsite-snackbar ds-is="snackbar"                       ></devsite-snackbar>    <devsite-tooltip ds-is="tooltip"
                     blocked-link></devsite-tooltip>
    <devsite-analytics ds-is="analytics">
              <script type="application/json" analytics>[{"metrics": {"ratings_value": "metric1", "ratings_count": "metric2"}, "dimensions": {}, "gaid": "UA-45455297-4"}]</script>
<script type="application/json" gtm>[]</script>
          </devsite-analytics>
    <script>
    (function(d,e,v,E,l,o,p,r,s,_,__){d['GoogleDevelopersObject']=[!0,l,o,p,r,s];
    _=e.createElement(v);_.async=1;_.src=E;__=e.getElementsByTagName(v)[0];
    __.parentNode.insertBefore(_,__);})(window, document, 'script',
      'https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/js/app_loader.js',
      'zh_cn',
      'https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/js/devsite_app.js',
      'https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource',
      !1,
      ['/_pwa/androidsource/manifest.json',
       'https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/images/video-placeholder.svg',
       'https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/images/favicon.png','https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/images/lockup.svg','https://fonts.googleapis.com/css?family=Roboto:300,400,400italic,500,500italic,700,700italic|Roboto+Mono:400,500,700|Material+Icons'],
       'https://androidsource-dot-google-developers.gonglchuangl.net/')
   </script>  </body>

<!-- Mirrored from source.android.google.cn/devices/graphics/arch-bq-gralloc.html?hl=zh-cn by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 16 Mar 2019 20:41:15 GMT -->
</html>