<!doctype html>
<html  lang="zh_cn">
  
<!-- Mirrored from source.android.google.cn/devices/audio/avoiding_pi.html?hl=zh-cn by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 16 Mar 2019 21:01:34 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
          
<title>避免优先级倒置 &nbsp;|&nbsp; Android Open Source Project</title>

<meta property="og:title" content="避免优先级倒置 &nbsp;|&nbsp; Android Open Source Project">

  <meta property="og:url" content="avoiding_pi.html">

  <meta property="og:locale" content="zh_cn">


    
    
    
  
        <meta property="og:site_name" content="Android Open Source Project">
    <meta property="og:type" content="website">
    
          <meta name="theme-color" content="#78c257">
    
    <meta charset="utf-8">
    <meta content="IE=Edge" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="../../_pwa/androidsource/manifest.json">
    <link rel="preconnect" href="http://www.gstatic.com/" crossorigin>
    <link rel="preconnect" href="http://fonts.gstatic.com/" crossorigin>
    <link rel="preconnect" href="http://fonts.googleapis.com/" crossorigin>
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:300,400,400italic,500,500italic,700,700italic|Roboto+Mono:400,500,700|Material+Icons">
    <link rel="stylesheet" href="https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/css/app.css">
    <noscript>
      <link rel="stylesheet" href="https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/css/ce_bundle.css">
    </noscript>
    <link rel="shortcut icon" href="https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/images/favicon.png">
    <link rel="apple-touch-icon" href="https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/images/touchicon-180.png"><link rel="canonical" href="avoiding_pi.html"></head>
  <body type="article"
        theme="androidsource-theme"
        class=""
        
        layout="docs"
        pending>
    <devsite-progress type="indeterminate" id="app-progress"></devsite-progress>
    <div class="devsite-wrapper"><devsite-header ds-is="header" keep-tabs-visible>
      








<div class="devsite-header--inner">
  <div class="devsite-top-logo-row-wrapper-wrapper">
    <div class="devsite-top-logo-row-wrapper">
      <div class="devsite-top-logo-row">
        <button type="button" id="devsite-hamburger-menu"
          class="devsite-header-icon-button button-flat material-icons gc-analytics-event"
          data-category="Site-Wide Custom Events"
          data-label="Navigation menu button"
          visually-hidden
          aria-label="Close menu">
        </button>
        <div class="devsite-product-name-wrapper">
  <a href="../../index0b8e.html?hl=zh-cn" class="devsite-site-logo-link gc-analytics-event"
   data-category="Site-Wide Custom Events" data-label="Site logo">
  <img src="https://www.gstatic.cn/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/images/lockup.svg" class="devsite-site-logo" alt="Android Open Source Project">
</a>
            <span class="devsite-product-name">
            <ul class="devsite-breadcrumb-list">
    <li class="devsite-breadcrumb-item">
                              </li>
  </ul>
          </span>
        
</div>        <div class="devsite-top-logo-row-middle">
          <div class="devsite-header-upper-tabs">
                          <devsite-tabs ds-is="tabs" class="upper-tabs">
  <div class="devsite-tabs-wrapper">
                  <tab >
          <a href="../../setup0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="设置"
           data-category="Site-Wide Custom Events"
        data-label="Tab: 设置"
   >
  设置
</a>

        </tab>
                        <tab >
          <a href="../../compatibility0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="设计"
           data-category="Site-Wide Custom Events"
        data-label="Tab: 设计"
   >
  设计
</a>

        </tab>
                        <tab >
          <a href="../../security0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="安全性"
           data-category="Site-Wide Custom Events"
        data-label="Tab: 安全性"
   >
  安全性
</a>

        </tab>
                        <tab active>
          <a href="../audio0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="开发"
   aria-label="开发, selected"         data-category="Site-Wide Custom Events"
        data-label="Tab: 开发"
   >
  开发
</a>

        </tab>
                        <tab >
          <a href="../tech/dalvik0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="配置"
           data-category="Site-Wide Custom Events"
        data-label="Tab: 配置"
   >
  配置
</a>

        </tab>
                        <tab >
          <a href="../../reference0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="参考"
           data-category="Site-Wide Custom Events"
        data-label="Tab: 参考"
   >
  参考
</a>

        </tab>
            </div>
</devsite-tabs>

                       </div>
          <devsite-search ds-is="search"
            enable-suggestions
                  project-path="">
  <form class="devsite-search-form" action="https://source.android.google.cn/s/results/?hl=zh-cn" method="GET">
    <div class="devsite-search-container">
      <div id="searchbox" class="devsite-searchbox">
                <input placeholder="搜索"
          type="text"
          class="devsite-search-field devsite-search-query"
          name="q"
          value=""
          autocomplete="off"
                    aria-label="搜索框">
        <div class="devsite-search-image material-icons"></div>
      </div>
      <button type="button"
              search-open
              class="devsite-search-button devsite-header-icon-button button-flat material-icons"
              aria-label="Open search box"></button>
    </div>
  </form>
  <button type="button"
          search-close
          class="devsite-search-button devsite-header-icon-button button-flat material-icons"
          aria-label="Close search box"></button>
</devsite-search>

        </div>

                <a class="devsite-header-link devsite-top-button button gc-analytics-event"
           href="http://android-review.googlesource.com/"
           data-category="Site-Wide Custom Events"
           data-label="Site header link">
          转到源代码
        </a>
                      </div>    </div>  </div>
  <div class="devsite-collapsible-section
    ">
    <div class="devsite-header-background">
                        <div class="devsite-product-id-row">
            <div class="devsite-product-description-row">
                              <ul class="devsite-breadcrumb-list">
    <li class="devsite-breadcrumb-item">
                    <a href="../audio0b8e.html?hl=zh-cn"              class="devsite-breadcrumb-link gc-analytics-event"
              data-category="Site-Wide Custom Events"
              data-label="Lower Header"
              data-value="1"
          >
            开发
      
  </a>
        </li>
  </ul>
                                        </div>
                                                                                    </div>
                                      <div class="devsite-doc-set-nav-row">
                              <devsite-tabs ds-is="tabs" class="lower-tabs">
  <div class="devsite-tabs-wrapper">
                  <tab active>
          <a href="../audio0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="音频"
   aria-label="音频, selected"         data-category="Site-Wide Custom Events"
        data-label="Tab: 音频"
   >
  音频
</a>

        </tab>
                        <tab >
          <a href="../camera0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="相机"
           data-category="Site-Wide Custom Events"
        data-label="Tab: 相机"
   >
  相机
</a>

        </tab>
                        <tab >
          <a href="../tech/connect0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="连接"
           data-category="Site-Wide Custom Events"
        data-label="Tab: 连接"
   >
  连接
</a>

        </tab>
                        <tab >
          <a href="../graphics0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="图形"
           data-category="Site-Wide Custom Events"
        data-label="Tab: 图形"
   >
  图形
</a>

        </tab>
                        <tab >
          <a href="../input0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="互动"
           data-category="Site-Wide Custom Events"
        data-label="Tab: 互动"
   >
  互动
</a>

        </tab>
                        <tab >
          <a href="../media0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="媒体"
           data-category="Site-Wide Custom Events"
        data-label="Tab: 媒体"
   >
  媒体
</a>

        </tab>
                        <tab >
          <a href="../storage0b8e.html?hl=zh-cn"
   class="gc-analytics-event"
   title="存储"
           data-category="Site-Wide Custom Events"
        data-label="Tab: 存储"
   >
  存储
</a>

        </tab>
            </div>
</devsite-tabs>

        </div>
          </div>  </div></div>
  

  </devsite-header>      <devsite-book-nav ds-is="book-nav" scrollbars >
                  

<nav class="devsite-book-nav devsite-nav nocontent">
  <div class="devsite-mobile-header">
    <button type="button"
            id="devsite-close-nav"
            class="devsite-header-icon-button button-flat material-icons gc-analytics-event"
            data-category="Site-Wide Custom Events"
            data-label="Close navigation"
            aria-label="Close navigation">
    </button>
  </div>

  <div class="devsite-book-nav-wrapper">
    <div class="devsite-mobile-nav-top">
              <ul class="devsite-nav-list">
                      <li class="devsite-nav-item">
                                <a href="../../setup.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 设置">
      <span class="devsite-nav-text" >设置</span>
        </a>
  
                                        </li>
                      <li class="devsite-nav-item">
                                <a href="../../compatibility.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 设计">
      <span class="devsite-nav-text" >设计</span>
        </a>
  
                                        </li>
                      <li class="devsite-nav-item">
                                <a href="../../security.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 安全性">
      <span class="devsite-nav-text" >安全性</span>
        </a>
  
                                        </li>
                      <li class="devsite-nav-item">
                                <a href="../audio.html"
          class="devsite-nav-title gc-analytics-event
            devsite-nav-active"
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 开发">
      <span class="devsite-nav-text" >开发</span>
        </a>
  
                                            <ul class="devsite-nav-responsive-tabs">
                                                                                                                      <li class="devsite-nav-item">
    <a href="../audio.html"
     id="devsite-nav-forward"     class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 音频">
      <span class="devsite-nav-text" menu="_book">音频</span>
        <span class="devsite-nav-icon material-icons" data-icon="forward"
          menu="_book">
    </span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="../camera.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 相机">
      <span class="devsite-nav-text" >相机</span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="../tech/connect.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 连接">
      <span class="devsite-nav-text" >连接</span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="../graphics.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 图形">
      <span class="devsite-nav-text" >图形</span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="../input.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 互动">
      <span class="devsite-nav-text" >互动</span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="../media.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 媒体">
      <span class="devsite-nav-text" >媒体</span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="../storage.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 存储">
      <span class="devsite-nav-text" >存储</span>
        </a>
  </li>

                                  </ul>
                          </li>
                      <li class="devsite-nav-item">
                                <a href="../tech/dalvik.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 配置">
      <span class="devsite-nav-text" >配置</span>
        </a>
  
                                        </li>
                      <li class="devsite-nav-item">
                                <a href="../../reference.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 参考">
      <span class="devsite-nav-text" >参考</span>
        </a>
  
                                        </li>
                                <li class="devsite-nav-item">
    <a href="http://android-review.googlesource.com/"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: 转到源代码">
      <span class="devsite-nav-text" >转到源代码</span>
        </a>
  </li>

                  </ul>
          </div>
          <div class="devsite-mobile-nav-bottom">
                                      <ul class="devsite-nav-list" menu="_book">
                                    <li class="devsite-nav-item"><a href="../audio.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="概览">概览</span></a></li>
                          <li class="devsite-nav-item"><a href="terminology.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="术语">术语</span></a></li>
                          <li class="devsite-nav-item           devsite-nav-expandable"><devsite-expandable-nav ds-is="expandable-nav" collapsed>
    <a class="devsite-nav-toggle"></a><div class="devsite-nav-title devsite-nav-title-no-path" tabindex="0"><span class="devsite-nav-text" title="实现">实现</span></div><ul class="devsite-nav-section"><li class="devsite-nav-item"><a href="implement.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="概览">概览</span></a></li><li class="devsite-nav-item"><a href="implement-policy.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="策略配置">策略配置</span></a></li><li class="devsite-nav-item"><a href="implement-shared-library.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="共享库">共享库</span></a></li><li class="devsite-nav-item"><a href="implement-pre-processing.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="预处理效果">预处理效果</span></a></li></ul></devsite-expandable-nav></li>
                          <li class="devsite-nav-item"><a href="data_formats.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="数据格式">数据格式</span></a></li>
                          <li class="devsite-nav-item"><a href="attributes.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="属性">属性</span></a></li>
                          <li class="devsite-nav-item"><a href="highres-effects.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="高分辨率效果">高分辨率效果</span></a></li>
                          <li class="devsite-nav-item"><a href="aaudio.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="AAudio 和 MMAP">AAudio 和 MMAP</span></a></li>
                          <li class="devsite-nav-item"><a href="warmup.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="预热">预热</span></a></li>
                          <li class="devsite-nav-item           devsite-nav-expandable"><devsite-expandable-nav ds-is="expandable-nav" collapsed>
    <a class="devsite-nav-toggle"></a><div class="devsite-nav-title devsite-nav-title-no-path" tabindex="0"><span class="devsite-nav-text" title="延迟">延迟</span></div><ul class="devsite-nav-section"><li class="devsite-nav-item"><a href="latency/latency.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="概览">概览</span></a></li><li class="devsite-nav-item"><a href="latency/contrib.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="影响因素">影响因素</span></a></li><li class="devsite-nav-item"><a href="latency/design.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="设计">设计</span></a></li><li class="devsite-nav-item"><a href="latency/measure.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="衡量">衡量</span></a></li><li class="devsite-nav-item"><a href="latency/testing_circuit.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="灯光测试电路">灯光测试电路</span></a></li><li class="devsite-nav-item"><a href="latency/loopback.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="音频环回适配器">音频环回适配器</span></a></li><li class="devsite-nav-item"><a href="latency/measurements.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="测量结果">测量结果</span></a></li><li class="devsite-nav-item"><a href="latency/app.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="应用">应用</span></a></li></ul></devsite-expandable-nav></li>
                          <li class="devsite-nav-item"><a href="avoiding_pi.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="优先级倒置">优先级倒置</span></a></li>
                          <li class="devsite-nav-item"><a href="src.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="采样率转换">采样率转换</span></a></li>
                          <li class="devsite-nav-item"><a href="debugging.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="调试">调试</span></a></li>
                          <li class="devsite-nav-item           devsite-nav-expandable"><devsite-expandable-nav ds-is="expandable-nav" collapsed>
    <a class="devsite-nav-toggle"></a><div class="devsite-nav-title devsite-nav-title-no-path" tabindex="0"><span class="devsite-nav-text" title="MIDI">MIDI</span></div><ul class="devsite-nav-section"><li class="devsite-nav-item"><a href="midi.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="概览">概览</span></a></li><li class="devsite-nav-item"><a href="midi_arch.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="MIDI 架构">MIDI 架构</span></a></li><li class="devsite-nav-item"><a href="midi_test.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="MIDI 测试程序">MIDI 测试程序</span></a></li></ul></devsite-expandable-nav></li>
                          <li class="devsite-nav-item"><a href="usb.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="USB 数字音频">USB 数字音频</span></a></li>
                          <li class="devsite-nav-item"><a href="tv.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="电视音频">电视音频</span></a></li>
                      </ul>
                                                                                                                                                                            </div>
      </div>
</nav>
              </devsite-book-nav>
      <div id="gc-wrapper">
        <div class="devsite-main-content"
            has-book-nav            has-toc>
          <devsite-toc ds-is="toc" class="devsite-nav"
            ></devsite-toc>
          <devsite-content ds-is="content">
                          

<article class="devsite-article">
  <article class="devsite-article-inner">    
    <div class="devsite-article-meta">
      <ul class="devsite-breadcrumb-list">
    <li class="devsite-breadcrumb-item">
                    <a href="../../index0b8e.html?hl=zh-cn"              class="devsite-breadcrumb-link gc-analytics-event"
              data-category="Site-Wide Custom Events"
              data-label="Breadcrumbs"
              data-value="1"
          >
            AOSP
      
  </a>
        </li>
    <li class="devsite-breadcrumb-item">
                <div class="devsite-breadcrumb-guillemet material-icons"></div>
                    <a href="../audio0b8e.html?hl=zh-cn"              class="devsite-breadcrumb-link gc-analytics-event"
              data-category="Site-Wide Custom Events"
              data-label="Breadcrumbs"
              data-value="2"
          >
            开发
      
  </a>
        </li>
    <li class="devsite-breadcrumb-item">
                <div class="devsite-breadcrumb-guillemet material-icons"></div>
                    <a href="../audio0b8e.html?hl=zh-cn"              class="devsite-breadcrumb-link gc-analytics-event"
              data-category="Site-Wide Custom Events"
              data-label="Breadcrumbs"
              data-value="3"
          >
            音频
      
  </a>
        </li>
  </ul>
               <devsite-page-rating position="header" selected-rating="0" hover-rating-star="0">
         </devsite-page-rating>
          </div>

              <h1 class="devsite-page-title">避免优先级倒置</h1>
    
    <devsite-toc ds-is="toc" class="devsite-nav" devsite-toc-embedded
                 ></devsite-toc>

    <div class="devsite-article-body clearfix
      ">

              
  <!--
      Copyright 2017 The Android Open Source Project

      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.
  -->

<p>
本文介绍了 Android 的音频系统如何尝试避免优先级倒置，还重点介绍了您可以使用的技术。
</p>

<p>
对于高性能音频应用的开发者、原始设备制造商 (OEM) 和要实现音频 HAL 的 SoC 提供商而言，这些技术可能很有用。请注意，实现这些技术不能保证一定不会出现错误或其他故障，尤其在音频环境之外使用时。使用不同的技术，获得的结果可能也会不同，您需要自己进行评估和测试。
</p>

<h2 id="background">背景</h2>

<p>
Android AudioFlinger 音频服务器和 AudioTrack/AudioRecord 客户端实现正在进行架构调整，以缩短延迟时间。这项工作从 Android 4.1 开始，在 4.2、4.3、4.4 和 5.0 中得到了进一步改进。
</p>

<p>
为了缩短延迟时间，需要对整个系统进行大量更改。其中一项重要更改是采用预测性更高的调度策略将 CPU 资源分配给对时间要求严格的线程。可靠的调度可减小音频缓冲区的大小和数目，同时仍可避免欠载和溢出。
</p>

<h2 id="priorityInversion">优先级倒置</h2>

<p>
<a href="http://en.wikipedia.org/wiki/Priority_inversion">优先级倒置</a>是实时系统的一种典型故障模式，在这种模式下，优先级较高的任务会因等待优先级较低的任务释放<a href="http://en.wikipedia.org/wiki/Mutual_exclusion">互斥</a>（保护的共享状态）等资源而无限时受阻。
</p>

<p>
在音频系统中，如果使用环形缓冲区或其在响应命令时延迟，优先级倒置通常表现为音频<a href="http://en.wikipedia.org/wiki/Glitch">错误</a>（咔嗒声、爆裂声、音频丢失）和<a href="http://en.wikipedia.org/wiki/Max_Headroom_(character)">音频重复</a>。
</p>

<p>
优先级倒置的常见解决方法是增加音频缓冲区大小。不过，这种方法会增加延迟时间，仅仅将问题隐藏，而非解决问题。最好的方法是了解并防止优先级倒置，如下所示。
</p>

<p>
在 Android 音频实现中，优先级倒置最有可能发生在以下位置。因此，您应该重点关注这些位置：
</p>

<ul>

<li>
AudioFlinger 中的常规混合器线程和快速混合器线程之间
</li>

<li>
快速 AudioTrack 的应用回调线程和快速混合器线程之间（它们的优先级都较高，但略有不同）
</li>

<li>
快速 AudioRecord 的应用回调线程和快速捕获线程之间（与上一种情况类似）
</li>

<li>
在音频硬件抽象层 (HAL) 实现（例如用于电话或回声消除的实现）中
</li>

<li>
在内核的音频驱动程序中
</li>

<li>
AudioTrack 或 AudioRecord 回调线程和其他应用线程（这不在我们的控制范围内）之间
</li>

</ul>

<h2 id="commonSolutions">常用解决方法</h2>

<p>
一般采用的解决方法包括：
</p>

<ul>

<li>
停用中断
</li>

<li>
优先级继承互斥
</li>

</ul>

<p>
停用中断在 Linux 用户空间中不可行，且不适用于对称多处理器 (SMP)。
</p>

<p>
优先级继承 <a href="http://en.wikipedia.org/wiki/Futex">futex</a>（快速用户空间互斥）在 Linux 内核中可用，但目前并未由 Android C 运行时库 <a href="http://en.wikipedia.org/wiki/Bionic_(software)">Bionic</a> 采用。由于它们的负载相对较重，且依赖于可信客户端，因此不用于音频系统中。
</p>

<h2 id="androidTechniques">Android 使用的技术</h2>

<p>
实验从“尝试锁定”(try lock) 和超时锁定开始。它们是互斥锁定操作的非阻塞和有界阻塞变体。尝试锁定和超时锁定的效果相当不错，但容易受到几个罕见故障模式的影响：如果客户端繁忙，则不能保证服务器一定能够访问共享状态；如果一长系列不相关的锁定都已超时，则累积的超时时间可能会过长。
</p>

<p>
我们还使用<a href="http://en.wikipedia.org/wiki/Linearizability">原子操作</a>，例如：
</p>

<ul>
<li>递增</li>
<li>按位“或”</li>
<li>按位“和”</li>
</ul>

<p>
所有这些操作均返回之前的值，并包含必要的 SMP 屏障。缺点在于它们可能需要无限次重试。在实践中，我们发现重试并不是问题。
</p>

<p class="note"><strong>注意</strong>：原子操作及其与内存屏障的互动遭到非常严重的误解和误用。我们在此处提供这些方法，是为了提供完整的信息；不过，建议您同时阅读 <a href="https://developer.android.google.cn/training/articles/smp.html?hl=zh-cn">SMP Primer for Android</a> 这篇文章，以了解更多信息。
</p>

<p>
我们仍然保有和使用上述大多数工具，并在最近添加了以下技术：
</p>

<ul>

<li>
针对数据使用非阻塞单读取器单写入器 <a href="http://en.wikipedia.org/wiki/Circular_buffer">FIFO 队列</a>。
</li>

<li>
在高优先级和低优先级模块之间尝试“复制”状态而非“共享”状态。<i></i><i></i>
</li>

<li>
如果确实需要共享状态，请将状态的大小上限设为一个<a href="http://en.wikipedia.org/wiki/Word_(computer_architecture)">字</a>，在不重试的情况下，可以在单个总线操作中通过原子方式访问该状态。
</li>

<li>
对于复杂的多字状态，请使用状态队列。状态队列基本上只是用于状态（而非数据）的非阻塞单读取器单写入器 FIFO 队列，写入器将相邻推送收成单个推送这一情况除外。
</li>

<li>
注意<a href="http://en.wikipedia.org/wiki/Memory_barrier">内存屏障</a>，以保证 SMP 的准确性。
</li>

<li>
<a href="http://en.wikipedia.org/wiki/Trust,_but_verify">信任，但要验证</a>。在进程之间共享“状态”时，请勿假定状态的格式正确无误。<i></i>例如，检查索引是否在范围内。在同一个进程中的线程之间，以及在相互信任的进程（通常具有相同的 UID）之间，不需要进行验证。此外，也无需验证共享的“数据”，例如出现非继发性损坏的 PCM 音频。<i></i>
</li>

</ul>

<h2 id="nonBlockingAlgorithms">非阻塞算法</h2>

<p>
<a href="http://en.wikipedia.org/wiki/Non-blocking_algorithm">非阻塞算法</a>是我们最近一直在研究的一项内容。不过，除了单读取器单写入器 FIFO 队列之外，我们发现此类算法复杂且容易出错。
</p>

<p>
从 Android 4.2 开始，您可以在以下位置找到我们的非阻塞单读取器/写入器类：
</p>

<ul>

<li>
frameworks/av/include/media/nbaio/
</li>

<li>
frameworks/av/media/libnbaio/
</li>

<li>
frameworks/av/services/audioflinger/StateQueue*
</li>

</ul>

<p>
它们是专为 AudioFlinger 设计的，并不通用。非阻塞算法因其难以调试而臭名昭著。您可以将此代码视为一种模型。不过请注意，非阻塞算法可能会出现错误，且不能保证这些类一定适合用于其他用途。
</p>

<p>
对于开发者来说，应该更新部分示例 OpenSL ES 应用代码，以使用非阻塞算法或参照非 Android 开放源代码库。
</p>

<p>
我们发布了一个示例非阻塞 FIFO 实现，该实现专为应用代码设计。请在平台源目录 <code>frameworks/av/audio_utils</code> 中查看以下文件：
</p>
<ul>
  <li><a href="https://android.googlesource.com/platform/system/media/+/master/audio_utils/include/audio_utils/fifo.h">include/audio_utils/fifo.h</a></li>
  <li><a href="https://android.googlesource.com/platform/system/media/+/master/audio_utils/fifo.c">fifo.c</a></li>
  <li><a href="https://android.googlesource.com/platform/system/media/+/master/audio_utils/include/audio_utils/roundup.h">include/audio_utils/roundup.h</a></li>
  <li><a href="https://android.googlesource.com/platform/system/media/+/master/audio_utils/roundup.c">roundup.c</a></li>
</ul>

<h2 id="tools">工具</h2>

<p>
据我们所知，目前没有用于找出优先级倒置（尤其是在优先级倒置发生之前）的自动工具。一些研究型静态代码分析工具如果能够访问整个代码库，就能找出优先级倒置。当然，如果涉及到任意用户代码（这里指应用）或用户代码是一个大型代码库（如 Linux 内核和设备驱动程序），则进行静态分析可能会不切实际。最重要的是，请务必认真阅读代码，并充分理解整个系统和各种交互操作。<a href="http://developer.android.google.cn/tools/help/systrace.html?hl=zh-cn">systrace</a> 和 <code>ps -t -p</code> 等工具有助于在优先级倒置发生后及时发现，但并不会提前告知您。
</p>

<h2 id="aFinalWord">总结</h2>

<p>
经过上述讨论后，请不要害怕互斥。一般情况下，互斥会是您的得力助手，例如，在时间不紧急的一般使用情形中正确使用和实现互斥时。但在高优先级任务和低优先级任务之间以及在时间敏感型系统中，互斥更有可能会导致出现问题。
</p>


          </div>

    
                   <devsite-page-rating position="footer" selected-rating="0" hover-rating-star="0">
         </devsite-page-rating>
                   
          </article>
</article>

<devsite-content-footer ds-is="content-footer" class="nocontent">
  <p>Content and code samples on this page are subject to the licenses described in the <a href="../../license0b8e.html?hl=zh-cn">Content License</a>. Java is a registered trademark of Oracle and/or its affiliates.</p>
</devsite-content-footer>


                      </devsite-content>
        </div>
        <devsite-footer-promos ds-is="footer-promos" class="devsite-footer">
                      
                  </devsite-footer-promos>
        <devsite-footer-linkboxes ds-is="footer-linkboxes" class="devsite-footer">
                      <nav class="devsite-footer-linkboxes nocontent">
  <ul class="devsite-footer-linkboxes-list">
        <li class="devsite-footer-linkbox ">
    <h3 class="devsite-footer-linkbox-heading">构建</h3>      <ul class="devsite-footer-linkbox-list">
                <li class="devsite-footer-linkbox-item">
          <a href="http://android.googlesource.com/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 1)"           >
            Android 代码库
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="../../setup/build/requirements.html"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 2)"           >
            要求
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="../../setup/build/downloading.html"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 3)"           >
            下载
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://developers.google.com/android/blobs-preview/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 4)"           >
            预览二进制文件
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://developers.google.com/android/images/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 5)"           >
            出厂映像
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://developers.google.com/android/drivers/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 6)"           >
            驱动程序二进制文件
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://android.github.io/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 7)"           >
            GitHub
          </a>
        </li>
              </ul>
    </li>
        <li class="devsite-footer-linkbox ">
    <h3 class="devsite-footer-linkbox-heading">关注</h3>      <ul class="devsite-footer-linkbox-list">
                <li class="devsite-footer-linkbox-item">
          <a href="http://twitter.com/Android/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 1)"           >
            在 Twitter 上 @Android
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://twitter.com/AndroidDev/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 2)"           >
            在 Twitter 上 @AndroidDev
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://blog.google/products/android/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 3)"           >
            Android 博客
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://security.googleblog.com/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 4)"           >
            Google 安全博客
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://groups.google.com/forum/?fromgroups#!forum/android-platform/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 5)"           >
            Google 网上论坛上的 Android 平台论坛
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://groups.google.com/forum/?fromgroups#!forum/android-building/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 6)"           >
            Google 网上论坛上的 Android 构建论坛
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://groups.google.com/forum/?fromgroups#!forum/android-porting/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 7)"           >
            Google 网上论坛上的 Android 移植论坛
          </a>
        </li>
              </ul>
    </li>
        <li class="devsite-footer-linkbox ">
    <h3 class="devsite-footer-linkbox-heading">获取帮助</h3>      <ul class="devsite-footer-linkbox-list">
                <li class="devsite-footer-linkbox-item">
          <a href="http://support.google.com/android/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 1)"           >
            Android 帮助中心
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://support.google.com/pixelphone/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 2)"           >
            Pixel 帮助中心
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://support.google.com/nexus/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 3)"           >
            Nexus 帮助中心
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://www.android.com/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 4)"           >
            www.android.com
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://www.android.com/gms/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 5)"           >
            Google Mobile Services
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://stackoverflow.com/questions/tagged/android-source/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 6)"           >
            Stack Overflow
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://issuetracker.google.com/issues?q=status:open%20componentid:190923"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 7)"           >
            问题跟踪器
          </a>
        </li>
              </ul>
    </li>
      </ul>
</nav>
                  </devsite-footer-linkboxes>
        <devsite-footer-utility ds-is="footer-utility" class="devsite-footer">
                      <div class="devsite-footer-utility">
  
  <nav class="devsite-nav">
        <ul class="devsite-footer-utility-list">
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="../../source/index0b8e.html?hl=zh-cn"
           data-category="Site-Wide Custom Events"
           data-label="Footer About Android link">
          关于 Android
        </a>
              </li>
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="../../source/community0b8e.html?hl=zh-cn"
           data-category="Site-Wide Custom Events"
           data-label="Footer Community link">
          社区
        </a>
              </li>
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="../../legal0b8e.html?hl=zh-cn"
           data-category="Site-Wide Custom Events"
           data-label="Footer Legal link">
          法律条款
        </a>
              </li>
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="../../license0b8e.html?hl=zh-cn"
           data-category="Site-Wide Custom Events"
           data-label="Footer License link">
          许可
        </a>
              </li>
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="http://policies.google.cn/privacy?hl=zh-cn"
           data-category="Site-Wide Custom Events"
           data-label="Footer Privacy link">
          隐私权政策
        </a>
              </li>
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="http://issuetracker.google.com/issues/new?component=191476&amp;hl=zh-cn"
           data-category="Site-Wide Custom Events"
           data-label="Footer Site feedback link">
          网站反馈
        </a>
              </li>
          </ul>
    
        <form class="devsite-footer-utility-language">
      <select class="devsite-footer-utility-language-select"
              name="language"
              track-name="click"
              track-type="languageSelector">
                  <option value="en"
                  track-metadata-original-language="zh_cn"
                  track-metadata-selected-language="en"
                  track-name="changed"
                  track-type="languageSelector"
                  >
            English
          </option>
                  <option value="zh_cn"
                  track-metadata-original-language="zh_cn"
                  track-metadata-selected-language="zh_cn"
                  track-name="changed"
                  track-type="languageSelector"
                  selected="selected">
            简体中文
          </option>
              </select>
    </form>
      </nav>
</div>
                  </devsite-footer-utility>
      </div></div>
    <devsite-sitemask ds-is="site-mask"></devsite-sitemask>
    <devsite-snackbar ds-is="snackbar"                       ></devsite-snackbar>    <devsite-tooltip ds-is="tooltip"
                     blocked-link></devsite-tooltip>
    <devsite-analytics ds-is="analytics">
              <script type="application/json" analytics>[{"metrics": {"ratings_value": "metric1", "ratings_count": "metric2"}, "dimensions": {}, "gaid": "UA-45455297-4"}]</script>
<script type="application/json" gtm>[]</script>
          </devsite-analytics>
    <script>
    (function(d,e,v,E,l,o,p,r,s,_,__){d['GoogleDevelopersObject']=[!0,l,o,p,r,s];
    _=e.createElement(v);_.async=1;_.src=E;__=e.getElementsByTagName(v)[0];
    __.parentNode.insertBefore(_,__);})(window, document, 'script',
      'https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/js/app_loader.js',
      'zh_cn',
      'https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/js/devsite_app.js',
      'https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource',
      !1,
      ['/_pwa/androidsource/manifest.json',
       'https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/images/video-placeholder.svg',
       'https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/images/favicon.png','https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/images/lockup.svg','https://fonts.googleapis.com/css?family=Roboto:300,400,400italic,500,500italic,700,700italic|Roboto+Mono:400,500,700|Material+Icons'],
       'https://androidsource-dot-google-developers.gonglchuangl.net/')
   </script>  </body>

<!-- Mirrored from source.android.google.cn/devices/audio/avoiding_pi.html?hl=zh-cn by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 16 Mar 2019 21:01:34 GMT -->
</html>