<!doctype html>
<html  lang="en">
  
<!-- Mirrored from source.android.google.cn/devices/audio/debugging.html by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 16 Mar 2019 14:31:45 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
          
<title>Audio Debugging &nbsp;|&nbsp; Android Open Source Project</title>

<meta property="og:title" content="Audio Debugging &nbsp;|&nbsp; Android Open Source Project">

  <meta property="og:url" content="debugging.html">

  <meta property="og:locale" content="en">


    
    
    
  
        <meta property="og:site_name" content="Android Open Source Project">
    <meta property="og:type" content="website">
    
          <meta name="theme-color" content="#78c257">
    
    <meta charset="utf-8">
    <meta content="IE=Edge" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="../../_pwa/androidsource/manifest.json">
    <link rel="preconnect" href="http://www.gstatic.com/" crossorigin>
    <link rel="preconnect" href="http://fonts.gstatic.com/" crossorigin>
    <link rel="preconnect" href="http://fonts.googleapis.com/" crossorigin>
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:300,400,400italic,500,500italic,700,700italic|Roboto+Mono:400,500,700|Material+Icons">
    <link rel="stylesheet" href="https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/css/app.css">
    <noscript>
      <link rel="stylesheet" href="https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/css/ce_bundle.css">
    </noscript>
    <link rel="shortcut icon" href="https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/images/favicon.png">
    <link rel="apple-touch-icon" href="https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/images/touchicon-180.png"><link rel="canonical" href="debugging.html"></head>
  <body type="article"
        theme="androidsource-theme"
        class=""
        
        layout="docs"
        pending>
    <devsite-progress type="indeterminate" id="app-progress"></devsite-progress>
    <div class="devsite-wrapper"><devsite-header ds-is="header" keep-tabs-visible>
      








<div class="devsite-header--inner">
  <div class="devsite-top-logo-row-wrapper-wrapper">
    <div class="devsite-top-logo-row-wrapper">
      <div class="devsite-top-logo-row">
        <button type="button" id="devsite-hamburger-menu"
          class="devsite-header-icon-button button-flat material-icons gc-analytics-event"
          data-category="Site-Wide Custom Events"
          data-label="Navigation menu button"
          visually-hidden
          aria-label="Close menu">
        </button>
        <div class="devsite-product-name-wrapper">
  <a href="../../index.html" class="devsite-site-logo-link gc-analytics-event"
   data-category="Site-Wide Custom Events" data-label="Site logo">
  <img src="https://www.gstatic.cn/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/images/lockup.svg" class="devsite-site-logo" alt="Android Open Source Project">
</a>
            <span class="devsite-product-name">
            <ul class="devsite-breadcrumb-list">
    <li class="devsite-breadcrumb-item">
                              </li>
  </ul>
          </span>
        
</div>        <div class="devsite-top-logo-row-middle">
          <div class="devsite-header-upper-tabs">
                          <devsite-tabs ds-is="tabs" class="upper-tabs">
  <div class="devsite-tabs-wrapper">
                  <tab >
          <a href="../../setup.html"
   class="gc-analytics-event"
   title="Set up"
           data-category="Site-Wide Custom Events"
        data-label="Tab: Set up"
   >
  Set up
</a>

        </tab>
                        <tab >
          <a href="../../compatibility.html"
   class="gc-analytics-event"
   title="Design"
           data-category="Site-Wide Custom Events"
        data-label="Tab: Design"
   >
  Design
</a>

        </tab>
                        <tab >
          <a href="../../security.html"
   class="gc-analytics-event"
   title="Secure"
           data-category="Site-Wide Custom Events"
        data-label="Tab: Secure"
   >
  Secure
</a>

        </tab>
                        <tab active>
          <a href="../audio.html"
   class="gc-analytics-event"
   title="Develop"
   aria-label="Develop, selected"         data-category="Site-Wide Custom Events"
        data-label="Tab: Develop"
   >
  Develop
</a>

        </tab>
                        <tab >
          <a href="../tech/dalvik.html"
   class="gc-analytics-event"
   title="Configure"
           data-category="Site-Wide Custom Events"
        data-label="Tab: Configure"
   >
  Configure
</a>

        </tab>
                        <tab >
          <a href="../../reference.html"
   class="gc-analytics-event"
   title="Reference"
           data-category="Site-Wide Custom Events"
        data-label="Tab: Reference"
   >
  Reference
</a>

        </tab>
            </div>
</devsite-tabs>

                       </div>
          <devsite-search ds-is="search"
            enable-suggestions
                  project-path="">
  <form class="devsite-search-form" action="https://source.android.google.cn/s/results/" method="GET">
    <div class="devsite-search-container">
      <div id="searchbox" class="devsite-searchbox">
                <input placeholder="Search"
          type="text"
          class="devsite-search-field devsite-search-query"
          name="q"
          value=""
          autocomplete="off"
                    aria-label="Search box">
        <div class="devsite-search-image material-icons"></div>
      </div>
      <button type="button"
              search-open
              class="devsite-search-button devsite-header-icon-button button-flat material-icons"
              aria-label="Open search box"></button>
    </div>
  </form>
  <button type="button"
          search-close
          class="devsite-search-button devsite-header-icon-button button-flat material-icons"
          aria-label="Close search box"></button>
</devsite-search>

        </div>

                <a class="devsite-header-link devsite-top-button button gc-analytics-event"
           href="http://android-review.googlesource.com/"
           data-category="Site-Wide Custom Events"
           data-label="Site header link">
          Go to code
        </a>
                      </div>    </div>  </div>
  <div class="devsite-collapsible-section
    ">
    <div class="devsite-header-background">
                        <div class="devsite-product-id-row">
            <div class="devsite-product-description-row">
                              <ul class="devsite-breadcrumb-list">
    <li class="devsite-breadcrumb-item">
                    <a href="../audio.html"              class="devsite-breadcrumb-link gc-analytics-event"
              data-category="Site-Wide Custom Events"
              data-label="Lower Header"
              data-value="1"
          >
            Develop
      
  </a>
        </li>
  </ul>
                                        </div>
                                                                                    </div>
                                      <div class="devsite-doc-set-nav-row">
                              <devsite-tabs ds-is="tabs" class="lower-tabs">
  <div class="devsite-tabs-wrapper">
                  <tab active>
          <a href="../audio.html"
   class="gc-analytics-event"
   title="Audio"
   aria-label="Audio, selected"         data-category="Site-Wide Custom Events"
        data-label="Tab: Audio"
   >
  Audio
</a>

        </tab>
                        <tab >
          <a href="../camera.html"
   class="gc-analytics-event"
   title="Camera"
           data-category="Site-Wide Custom Events"
        data-label="Tab: Camera"
   >
  Camera
</a>

        </tab>
                        <tab >
          <a href="../tech/connect.html"
   class="gc-analytics-event"
   title="Connectivity"
           data-category="Site-Wide Custom Events"
        data-label="Tab: Connectivity"
   >
  Connectivity
</a>

        </tab>
                        <tab >
          <a href="../graphics.html"
   class="gc-analytics-event"
   title="Graphics"
           data-category="Site-Wide Custom Events"
        data-label="Tab: Graphics"
   >
  Graphics
</a>

        </tab>
                        <tab >
          <a href="../input.html"
   class="gc-analytics-event"
   title="Interaction"
           data-category="Site-Wide Custom Events"
        data-label="Tab: Interaction"
   >
  Interaction
</a>

        </tab>
                        <tab >
          <a href="../media.html"
   class="gc-analytics-event"
   title="Media"
           data-category="Site-Wide Custom Events"
        data-label="Tab: Media"
   >
  Media
</a>

        </tab>
                        <tab >
          <a href="../storage.html"
   class="gc-analytics-event"
   title="Storage"
           data-category="Site-Wide Custom Events"
        data-label="Tab: Storage"
   >
  Storage
</a>

        </tab>
            </div>
</devsite-tabs>

        </div>
          </div>  </div></div>
  

  </devsite-header>      <devsite-book-nav ds-is="book-nav" scrollbars >
                  

<nav class="devsite-book-nav devsite-nav nocontent">
  <div class="devsite-mobile-header">
    <button type="button"
            id="devsite-close-nav"
            class="devsite-header-icon-button button-flat material-icons gc-analytics-event"
            data-category="Site-Wide Custom Events"
            data-label="Close navigation"
            aria-label="Close navigation">
    </button>
  </div>

  <div class="devsite-book-nav-wrapper">
    <div class="devsite-mobile-nav-top">
              <ul class="devsite-nav-list">
                      <li class="devsite-nav-item">
                                <a href="../../setup.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Set up">
      <span class="devsite-nav-text" >Set up</span>
        </a>
  
                                        </li>
                      <li class="devsite-nav-item">
                                <a href="../../compatibility.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Design">
      <span class="devsite-nav-text" >Design</span>
        </a>
  
                                        </li>
                      <li class="devsite-nav-item">
                                <a href="../../security.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Secure">
      <span class="devsite-nav-text" >Secure</span>
        </a>
  
                                        </li>
                      <li class="devsite-nav-item">
                                <a href="../audio.html"
          class="devsite-nav-title gc-analytics-event
            devsite-nav-active"
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Develop">
      <span class="devsite-nav-text" >Develop</span>
        </a>
  
                                            <ul class="devsite-nav-responsive-tabs">
                                                                                                                      <li class="devsite-nav-item">
    <a href="../audio.html"
     id="devsite-nav-forward"     class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Audio">
      <span class="devsite-nav-text" menu="_book">Audio</span>
        <span class="devsite-nav-icon material-icons" data-icon="forward"
          menu="_book">
    </span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="../camera.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Camera">
      <span class="devsite-nav-text" >Camera</span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="../tech/connect.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Connectivity">
      <span class="devsite-nav-text" >Connectivity</span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="../graphics.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Graphics">
      <span class="devsite-nav-text" >Graphics</span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="../input.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Interaction">
      <span class="devsite-nav-text" >Interaction</span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="../media.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Media">
      <span class="devsite-nav-text" >Media</span>
        </a>
  </li>

                                                                                                                      <li class="devsite-nav-item">
    <a href="../storage.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Storage">
      <span class="devsite-nav-text" >Storage</span>
        </a>
  </li>

                                  </ul>
                          </li>
                      <li class="devsite-nav-item">
                                <a href="../tech/dalvik.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Configure">
      <span class="devsite-nav-text" >Configure</span>
        </a>
  
                                        </li>
                      <li class="devsite-nav-item">
                                <a href="../../reference.html"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Reference">
      <span class="devsite-nav-text" >Reference</span>
        </a>
  
                                        </li>
                                <li class="devsite-nav-item">
    <a href="http://android-review.googlesource.com/"
          class="devsite-nav-title gc-analytics-event
            "
     data-category="Site-Wide Custom Events"
     data-label="Responsive Tab: Go to code">
      <span class="devsite-nav-text" >Go to code</span>
        </a>
  </li>

                  </ul>
          </div>
          <div class="devsite-mobile-nav-bottom">
                                      <ul class="devsite-nav-list" menu="_book">
                                    <li class="devsite-nav-item"><a href="../audio.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Overview">Overview</span></a></li>
                          <li class="devsite-nav-item"><a href="terminology.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Terminology">Terminology</span></a></li>
                          <li class="devsite-nav-item           devsite-nav-expandable"><devsite-expandable-nav ds-is="expandable-nav" collapsed>
    <a class="devsite-nav-toggle"></a><div class="devsite-nav-title devsite-nav-title-no-path" tabindex="0"><span class="devsite-nav-text" title="Implementation">Implementation</span></div><ul class="devsite-nav-section"><li class="devsite-nav-item"><a href="implement.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Overview">Overview</span></a></li><li class="devsite-nav-item"><a href="implement-policy.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Policy Configuration">Policy Configuration</span></a></li><li class="devsite-nav-item"><a href="implement-shared-library.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Shared Library">Shared Library</span></a></li><li class="devsite-nav-item"><a href="implement-pre-processing.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Pre-processing Effects">Pre-processing Effects</span></a></li></ul></devsite-expandable-nav></li>
                          <li class="devsite-nav-item"><a href="data_formats.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Data Formats">Data Formats</span></a></li>
                          <li class="devsite-nav-item"><a href="attributes.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Attributes">Attributes</span></a></li>
                          <li class="devsite-nav-item"><a href="highres-effects.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="High-Resolution Effects">High-Resolution Effects</span></a></li>
                          <li class="devsite-nav-item"><a href="aaudio.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="AAudio and MMAP">AAudio and MMAP</span></a></li>
                          <li class="devsite-nav-item"><a href="warmup.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Warmup">Warmup</span></a></li>
                          <li class="devsite-nav-item           devsite-nav-expandable"><devsite-expandable-nav ds-is="expandable-nav" collapsed>
    <a class="devsite-nav-toggle"></a><div class="devsite-nav-title devsite-nav-title-no-path" tabindex="0"><span class="devsite-nav-text" title="Latency">Latency</span></div><ul class="devsite-nav-section"><li class="devsite-nav-item"><a href="latency/latency.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Overview">Overview</span></a></li><li class="devsite-nav-item"><a href="latency/contrib.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Contributors">Contributors</span></a></li><li class="devsite-nav-item"><a href="latency/design.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Design">Design</span></a></li><li class="devsite-nav-item"><a href="latency/measure.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Measure">Measure</span></a></li><li class="devsite-nav-item"><a href="latency/testing_circuit.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Light Testing Circuit">Light Testing Circuit</span></a></li><li class="devsite-nav-item"><a href="latency/loopback.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Audio Loopback Dongle">Audio Loopback Dongle</span></a></li><li class="devsite-nav-item"><a href="latency/measurements.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Measurements">Measurements</span></a></li><li class="devsite-nav-item"><a href="latency/app.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Applications">Applications</span></a></li></ul></devsite-expandable-nav></li>
                          <li class="devsite-nav-item"><a href="avoiding_pi.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Priority Inversion">Priority Inversion</span></a></li>
                          <li class="devsite-nav-item"><a href="src.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Sample Rate Conversion">Sample Rate Conversion</span></a></li>
                          <li class="devsite-nav-item"><a href="debugging.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Debugging">Debugging</span></a></li>
                          <li class="devsite-nav-item           devsite-nav-expandable"><devsite-expandable-nav ds-is="expandable-nav" collapsed>
    <a class="devsite-nav-toggle"></a><div class="devsite-nav-title devsite-nav-title-no-path" tabindex="0"><span class="devsite-nav-text" title="MIDI">MIDI</span></div><ul class="devsite-nav-section"><li class="devsite-nav-item"><a href="midi.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="Overview">Overview</span></a></li><li class="devsite-nav-item"><a href="midi_arch.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="MIDI Architecture">MIDI Architecture</span></a></li><li class="devsite-nav-item"><a href="midi_test.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="MIDI Test Procedure">MIDI Test Procedure</span></a></li></ul></devsite-expandable-nav></li>
                          <li class="devsite-nav-item"><a href="usb.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="USB Digital Audio">USB Digital Audio</span></a></li>
                          <li class="devsite-nav-item"><a href="tv.html"
     class="devsite-nav-title"
   ><span class="devsite-nav-text" title="TV Audio">TV Audio</span></a></li>
                      </ul>
                                                                                                                                                                            </div>
      </div>
</nav>
              </devsite-book-nav>
      <div id="gc-wrapper">
        <div class="devsite-main-content"
            has-book-nav            has-toc>
          <devsite-toc ds-is="toc" class="devsite-nav"
            ></devsite-toc>
          <devsite-content ds-is="content">
                          

<article class="devsite-article">
  <article class="devsite-article-inner">    
    <div class="devsite-article-meta">
      <ul class="devsite-breadcrumb-list">
    <li class="devsite-breadcrumb-item">
                    <a href="../../index.html"              class="devsite-breadcrumb-link gc-analytics-event"
              data-category="Site-Wide Custom Events"
              data-label="Breadcrumbs"
              data-value="1"
          >
            AOSP
      
  </a>
        </li>
    <li class="devsite-breadcrumb-item">
                <div class="devsite-breadcrumb-guillemet material-icons"></div>
                    <a href="../audio.html"              class="devsite-breadcrumb-link gc-analytics-event"
              data-category="Site-Wide Custom Events"
              data-label="Breadcrumbs"
              data-value="2"
          >
            Develop
      
  </a>
        </li>
    <li class="devsite-breadcrumb-item">
                <div class="devsite-breadcrumb-guillemet material-icons"></div>
                    <a href="../audio.html"              class="devsite-breadcrumb-link gc-analytics-event"
              data-category="Site-Wide Custom Events"
              data-label="Breadcrumbs"
              data-value="3"
          >
            Audio
      
  </a>
        </li>
  </ul>
               <devsite-page-rating position="header" selected-rating="0" hover-rating-star="0">
         </devsite-page-rating>
          </div>

              <h1 class="devsite-page-title">Audio Debugging</h1>
    
    <devsite-toc ds-is="toc" class="devsite-nav" devsite-toc-embedded
                 ></devsite-toc>

    <div class="devsite-article-body clearfix
      ">

              
  <!--
      Copyright 2017 The Android Open Source Project

      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.
  -->



<p>
This article describes some tips and tricks for debugging Android audio.
</p>

<h2 id="teeSink">Tee Sink</h2>

<p>
The "tee sink" is
an AudioFlinger debugging feature, available in custom builds only,
for retaining a short fragment of recent audio for later analysis.
This permits comparison between what was actually played or recorded
vs. what was expected.
</p>

<p>
For privacy the tee sink is disabled by default, at both compile-time and
run-time.  To use the tee sink, you will need to enable it by re-compiling,
and also by setting a property.  Be sure to disable this feature after you are
done debugging; the tee sink should not be left enabled in production builds.
</p>

<p>
  The instructions in this section are for Android 7.x and higher. For Android
  5.x and 6.x, replace <code>/data/misc/audioserver</code> with 
  <code>/data/misc/media</code>. Additionally, you must use a userdebug or
  eng build. If you use a userdebug build, then disable verity with:
</p>

<pre class="devsite-terminal devsite-click-to-copy">
adb root &amp;&amp; adb disable-verity &amp;&amp; adb reboot
</pre>

<h3 id="compile">Compile-time setup</h3>

<ol>
  <li><code class="devsite-terminal">cd frameworks/av/services/audioflinger</code></li>
<li>Edit <code>Configuration.h</code>.</li>
<li>Uncomment <code>#define TEE_SINK</code>.</li>
<li>Re-build <code>libaudioflinger.so</code>.</li>
<li><code class="devsite-terminal">adb root</code></li>
<li><code class="devsite-terminal">adb remount</code></li>
<li>Push or sync the new <code>libaudioflinger.so</code> to the device's <code>/system/lib</code>.</li>
</ol>

<h3 id="runtime">Run-time setup</h3>

<ol>
<li><code class="devsite-terminal">adb shell getprop | grep ro.debuggable</code>
<br />Confirm that the output is: <code>[ro.debuggable]: [1]</code>
</li>
<li><code class="devsite-terminal">adb shell</code></li>
<li><code class="devsite-terminal">ls -ld /data/misc/audioserver</code>
<br />
<p>
Confirm that the output is:
</p>
<pre>
drwx------ media media ... media
</pre>
<p>
If the directory does not exist, create it as follows:
</p>
<pre class="devsite-click-to-copy">
<code class="devsite-terminal">mkdir /data/misc/audioserver</code>
<code class="devsite-terminal">chown media:media /data/misc/audioserver</code>
</pre>
</li>
<li><code class="devsite-terminal">echo af.tee=# &gt; /data/local.prop</code>
<br />Where the <code>af.tee</code> value is a number described below.
</li>
<li><code class="devsite-terminal">chmod 644 /data/local.prop</code></li>
<li><code class="devsite-terminal">reboot</code></li>
</ol>

<h4>Values for <code>af.tee</code> property</h4>

<p>
The value of <code>af.tee</code> is a number between 0 and 7, expressing
the sum of several bits, one per feature.
See the code at <code>AudioFlinger::AudioFlinger()</code> in <code>AudioFlinger.cpp</code>
for an explanation of each bit, but briefly:
</p>
<ul>
<li>1 = input</li>
<li>2 = FastMixer output</li>
<li>4 = per-track AudioRecord and AudioTrack</li>
</ul>

<p>
There is no bit for deep buffer or normal mixer yet,
but you can get similar results using "4."
</p>

<h3 id="test">Test and acquire data</h3>

<ol>
<li>Run your audio test.</li>
<li><code class="devsite-terminal">adb shell dumpsys media.audio_flinger</code></li>
<li>Look for a line in <code>dumpsys</code> output such as this:<br />
<code>tee copied to /data/misc/audioserver/20131010101147_2.wav</code>
<br />This is a PCM .wav file.
</li>
<li>Then <code>adb pull</code> any <code>/data/misc/audioserver/*.wav</code> files of interest;
  note that track-specific dump filenames do not appear in the
  <code>dumpsys</code> output,
but are still saved to <code>/data/misc/audioserver</code> upon track closure.
</li>
<li>Review the dump files for privacy concerns before sharing with others.</li>
</ol>

<h4>Suggestions</h4>

<p>Try these ideas for more useful results:</p>

<ul>
<li>Disable touch sounds and key clicks to reduce interruptions in test output.</li>
<li>Maximize all volumes.</li>
<li>Disable apps that make sound or record from microphone,
if they are not of interest to your test.
</li>
<li>Track-specific dumps are only saved when the track is closed;
you may need to force close an app in order to dump its track-specific data
</li>
<li>Do the <code>dumpsys</code> immediately after test;
there is a limited amount of recording space available.</li>
<li>To make sure you don't lose your dump files,
upload them to your host periodically.
Only a limited number of dump files are preserved;
older dumps are removed after that limit is reached.</li>
</ul>

<h3 id="restore">Restore</h3>

<p>
As noted above, the tee sink feature should not be left enabled.
Restore your build and device as follows:
</p>
<ol>
<li>Revert the source code changes to <code>Configuration.h</code>.</li>
<li>Re-build <code>libaudioflinger.so</code>.</li>
<li>Push or sync the restored <code>libaudioflinger.so</code>
to the device's <code>/system/lib</code>.
</li>
<li><code class="devsite-terminal">adb shell</code></li>
<li><code class="devsite-terminal">rm /data/local.prop</code></li>
<li><code class="devsite-terminal">rm /data/misc/audioserver/*.wav</code></li>
<li><code class="devsite-terminal">reboot</code></li>
</ol>

<h2 id="mediaLog">media.log</h2>

<h3 id="alogx">ALOGx macros</h3>

<p>
The standard Java language logging API in Android SDK is
<a href="http://developer.android.google.cn/reference/android/util/Log.html">android.util.Log</a>.
</p>

<p>
The corresponding C language API in Android NDK is
<code>__android_log_print</code>
declared in <code>&lt;android/log.h&gt;</code>.
</p>

<p>
Within the native portion of Android framework, we
prefer macros named <code>ALOGE</code>, <code>ALOGW</code>,
<code>ALOGI</code>, <code>ALOGV</code>, etc.  They are declared in
<code>&lt;utils/Log.h&gt;</code>, and for the purposes of this article
we'll collectively refer to them as <code>ALOGx</code>.
</p>

<p>
All of these APIs are easy-to-use and well-understood, so they are pervasive
throughout the Android platform.  In particular the <code>mediaserver</code>
process, which includes the AudioFlinger sound server, uses
<code>ALOGx</code> extensively.
</p>

<p>
Nevertheless, there are some limitations to <code>ALOGx</code> and friends:
</p>

<ul>
<li>
They are susceptible to "log spam": the log buffer is a shared resource
so it can easily overflow due to unrelated log entries, resulting in
missed information.  The <code>ALOGV</code> variant is disabled at
compile-time by default.  But of course even it can result in log spam
if it is enabled.
</li>
<li>
The underlying kernel system calls could block, possibly resulting in
priority inversion and consequently measurement disturbances and
inaccuracies.  This is of
special concern to time-critical threads such as <code>FastMixer</code> and <code>FastCapture</code>.
</li>
<li>
If a particular log is disabled to reduce log spam,
then any information that would have been captured by that log is lost.
It is not possible to enable a specific log retroactively,
<i>after</i> it becomes clear that the log would have been interesting.
</li>
</ul>

<h3 id="nblog">NBLOG, media.log, and MediaLogService</h3>

<p>
The <code>NBLOG</code> APIs and associated <code>media.log</code>
process and <code>MediaLogService</code>
service together form a newer logging system for media, and are specifically
designed to address the issues above.  We will loosely use the term
"media.log" to refer to all three, but strictly speaking <code>NBLOG</code> is the
C++ logging API, <code>media.log</code> is a Linux process name, and <code>MediaLogService</code>
is an Android binder service for examining the logs.
</p>

<p>
A <code>media.log</code> "timeline" is a series
of log entries whose relative ordering is preserved.
By convention, each thread should use it's own timeline.
</p>

<h3 id="benefits">Benefits</h3>

<p>
The benefits of the <code>media.log</code> system are that it:
</p>
<ul>
<li>Doesn't spam the main log unless and until it is needed.</li>
<li>Can be examined even when <code>mediaserver</code> crashes or hangs.</li>
<li>Is non-blocking per timeline.</li>
<li>Offers less disturbance to performance.
(Of course no form of logging is completely non-intrusive.)
</li>
</ul>

<h3 id="architecture">Architecture</h3>

<p>
The diagram below shows the relationship of the <code>mediaserver</code> process
and the <code>init</code> process, before <code>media.log</code> is introduced:
</p>
<img src="images/medialog_before.png" alt="Architecture before media.log" id="figure1" />
<p class="img-caption">
  <strong>Figure 1.</strong> Architecture before media.log
</p>

<p>
Notable points:
</p>
<ul>
<li><code>init</code> forks and execs <code>mediaserver</code>.</li>
<li><code>init</code> detects the death of <code>mediaserver</code>, and re-forks as necessary.</li>
<li><code>ALOGx</code> logging is not shown.</li>
</ul>

<p>
The diagram below shows the new relationship of the components,
after <code>media.log</code> is added to the architecture:
</p>
<img src="images/medialog_after.png" alt="Architecture after media.log" id="figure2" />
<p class="img-caption">
  <strong>Figure 2.</strong> Architecture after media.log
</p>

<p>
Important changes:
</p>

<ul>

<li>
Clients use <code>NBLOG</code> API to construct log entries and append them to
a circular buffer in shared memory.
</li>

<li>
<code>MediaLogService</code> can dump the contents of the circular buffer at any time.
</li>

<li>
The circular buffer is designed in such a way that any corruption of the
shared memory will not crash <code>MediaLogService</code>, and it will still be able
to dump as much of the buffer that is not affected by the corruption.
</li>

<li>
The circular buffer is non-blocking and lock-free for both writing
new entries and reading existing entries.
</li>

<li>
No kernel system calls are required to write to or read from the circular buffer
(other than optional timestamps).
</li>

</ul>

<h4>Where to use</h4>

<p>
As of Android 4.4, there are only a few log points in AudioFlinger
that use the <code>media.log</code> system.  Though the new APIs are not as
easy to use as <code>ALOGx</code>, they are not extremely difficult either.
We encourage you to learn the new logging system for those
occasions when it is indispensable.
In particular, it is recommended for AudioFlinger threads that must
run frequently, periodically, and without blocking such as the
<code>FastMixer</code> and <code>FastCapture</code> threads.
</p>

<h3 id="how">How to use</h3>

<h4>Add logs</h4>

<p>
First, you need to add logs to your code.
</p>

<p>
In <code>FastMixer</code> and <code>FastCapture</code> threads, use code such as this:
</p>
<pre class="devsite-click-to-copy">
logWriter-&gt;log("string");
logWriter-&gt;logf("format", parameters);
logWriter-&gt;logTimestamp();
</pre>
<p>
As this <code>NBLog</code> timeline is used only by the <code>FastMixer</code> and
<code>FastCapture</code> threads,
there is no need for mutual exclusion.
</p>

<p>
In other AudioFlinger threads, use <code>mNBLogWriter</code>:
</p>
<pre class="devsite-click-to-copy">
mNBLogWriter-&gt;log("string");
mNBLogWriter-&gt;logf("format", parameters);
mNBLogWriter-&gt;logTimestamp();
</pre>
<p>
For threads other than <code>FastMixer</code> and <code>FastCapture</code>,
the thread's <code>NBLog</code> timeline can be used by both the thread itself, and
by binder operations.  <code>NBLog::Writer</code> does not provide any
implicit mutual exclusion per timeline, so be sure that all logs occur
within a context where the thread's mutex <code>mLock</code> is held.
</p>

<p>
After you have added the logs, re-build AudioFlinger.
</p>

<p class="caution"><strong>Caution:</strong>
A separate <code>NBLog::Writer</code> timeline is required per thread,
to ensure thread safety, since timelines omit mutexes by design.  If you
want more than one thread to use the same timeline, you can protect with an
existing mutex (as described above for <code>mLock</code>).  Or you can
use the <code>NBLog::LockedWriter</code> wrapper instead of <code>NBLog::Writer</code>.
However, this negates a prime benefit of this API: its non-blocking
behavior.
</p>

<p>
The full <code>NBLog</code> API is at <code>frameworks/av/include/media/nbaio/NBLog.h</code>.
</p>

<h4>Enable media.log</h4>

<p>
<code>media.log</code> is disabled by default. It is active only when property
<code>ro.test_harness</code> is <code>1</code>.  You can enable it by:
</p>

<pre class="devsite-click-to-copy">
<code class="devsite-terminal">adb root</code>
<code class="devsite-terminal">adb shell</code>
<code class="devsite-terminal">echo ro.test_harness=1 > /data/local.prop</code>
<code class="devsite-terminal">chmod 644 /data/local.prop</code>
<code class="devsite-terminal">reboot</code>
</pre>

<p>
The connection is lost during reboot, so:
</p>
<pre class="devsite-terminal devsite-click-to-copy">
adb shell
</pre>

The command <code>ps media</code> will now show two processes:
<ul>
<li>media.log</li>
<li>mediaserver</li>
</ul>
<p>
Note the process ID of <code>mediaserver</code> for later.
</p>

<h4>Displaying the timelines</h4>

<p>
You can manually request a log dump at any time.
This command shows logs from all the active and recent timelines, and then clears them:
</p>
<pre class="devsite-terminal devsite-click-to-copy">
dumpsys media.log
</pre>

<p>
Note that by design timelines are independent,
and there is no facility for merging timelines.
</p>

<h4>Recovering logs after mediaserver death</h4>

<p>
Now try killing <code>mediaserver</code> process: <code>kill -9 #</code>, where # is
the process ID you noted earlier.  You should see a dump from <code>media.log</code>
in the main <code>logcat</code>, showing all the logs leading up to the crash.
</p>

<pre class="devsite-terminal devsite-click-to-copy">
dumpsys media.log
</pre>

  
          </div>

    
                   <devsite-page-rating position="footer" selected-rating="0" hover-rating-star="0">
         </devsite-page-rating>
                   
          </article>
</article>

<devsite-content-footer ds-is="content-footer" class="nocontent">
  <p>Content and code samples on this page are subject to the licenses described in the <a href="../../license.html">Content License</a>. Java is a registered trademark of Oracle and/or its affiliates.</p>
</devsite-content-footer>


                      </devsite-content>
        </div>
        <devsite-footer-promos ds-is="footer-promos" class="devsite-footer">
                      
                  </devsite-footer-promos>
        <devsite-footer-linkboxes ds-is="footer-linkboxes" class="devsite-footer">
                      <nav class="devsite-footer-linkboxes nocontent">
  <ul class="devsite-footer-linkboxes-list">
        <li class="devsite-footer-linkbox ">
    <h3 class="devsite-footer-linkbox-heading">Build</h3>      <ul class="devsite-footer-linkbox-list">
                <li class="devsite-footer-linkbox-item">
          <a href="http://android.googlesource.com/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 1)"           >
            Android repository
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="../../setup/build/requirements.html"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 2)"           >
            Requirements
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="../../setup/build/downloading.html"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 3)"           >
            Downloading
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://developers.google.com/android/blobs-preview/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 4)"           >
            Preview binaries
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://developers.google.com/android/images/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 5)"           >
            Factory images
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://developers.google.com/android/drivers/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 6)"           >
            Driver binaries
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://android.github.io/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 7)"           >
            GitHub
          </a>
        </li>
              </ul>
    </li>
        <li class="devsite-footer-linkbox ">
    <h3 class="devsite-footer-linkbox-heading">Connect</h3>      <ul class="devsite-footer-linkbox-list">
                <li class="devsite-footer-linkbox-item">
          <a href="http://twitter.com/Android/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 1)"           >
            @Android on Twitter
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://twitter.com/AndroidDev/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 2)"           >
            @AndroidDev on Twitter
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://blog.google/products/android/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 3)"           >
            Android Blog
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://security.googleblog.com/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 4)"           >
            Google Security Blog
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://groups.google.com/forum/?fromgroups#!forum/android-platform/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 5)"           >
            Platform on Google Groups
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://groups.google.com/forum/?fromgroups#!forum/android-building/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 6)"           >
            Building on Google Groups
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://groups.google.com/forum/?fromgroups#!forum/android-porting/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 7)"           >
            Porting on Google Groups
          </a>
        </li>
              </ul>
    </li>
        <li class="devsite-footer-linkbox ">
    <h3 class="devsite-footer-linkbox-heading">Get help</h3>      <ul class="devsite-footer-linkbox-list">
                <li class="devsite-footer-linkbox-item">
          <a href="http://support.google.com/android/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 1)"           >
            Android Help Center
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://support.google.com/pixelphone/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 2)"           >
            Pixel Help Center
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://support.google.com/nexus/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 3)"           >
            Nexus Help Center
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://www.android.com/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 4)"           >
            www.android.com
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://www.android.com/gms/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 5)"           >
            Google Mobile Services
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://stackoverflow.com/questions/tagged/android-source/"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 6)"           >
            Stack Overflow
          </a>
        </li>
                <li class="devsite-footer-linkbox-item">
          <a href="http://issuetracker.google.com/issues?q=status:open%20componentid:190923"
             class="devsite-footer-linkbox-link
                    gc-analytics-event"
             data-category="Site-Wide Custom Events"
                        data-label="Footer Link (index 7)"           >
            Issue Tracker
          </a>
        </li>
              </ul>
    </li>
      </ul>
</nav>
                  </devsite-footer-linkboxes>
        <devsite-footer-utility ds-is="footer-utility" class="devsite-footer">
                      <div class="devsite-footer-utility">
  
  <nav class="devsite-nav">
        <ul class="devsite-footer-utility-list">
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="../../source/index.html"
           data-category="Site-Wide Custom Events"
           data-label="Footer About Android link">
          About Android
        </a>
              </li>
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="../../setup/community.html"
           data-category="Site-Wide Custom Events"
           data-label="Footer Community link">
          Community
        </a>
              </li>
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="../../legal.html"
           data-category="Site-Wide Custom Events"
           data-label="Footer Legal link">
          Legal
        </a>
              </li>
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="../../license.html"
           data-category="Site-Wide Custom Events"
           data-label="Footer License link">
          License
        </a>
              </li>
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="http://policies.google.cn/privacy"
           data-category="Site-Wide Custom Events"
           data-label="Footer Privacy link">
          Privacy
        </a>
              </li>
            <li class="devsite-footer-utility-item
                 ">
                        <a class="devsite-footer-utility-link
                  gc-analytics-event"
           href="http://issuetracker.google.com/issues/new?component=191476"
           data-category="Site-Wide Custom Events"
           data-label="Footer Site feedback link">
          Site feedback
        </a>
              </li>
          </ul>
    
        <form class="devsite-footer-utility-language">
      <select class="devsite-footer-utility-language-select"
              name="language"
              track-name="click"
              track-type="languageSelector">
                  <option value="en"
                  track-metadata-original-language="en"
                  track-metadata-selected-language="en"
                  track-name="changed"
                  track-type="languageSelector"
                  selected="selected">
            English
          </option>
                  <option value="zh_cn"
                  track-metadata-original-language="en"
                  track-metadata-selected-language="zh_cn"
                  track-name="changed"
                  track-type="languageSelector"
                  >
            简体中文
          </option>
              </select>
    </form>
      </nav>
</div>
                  </devsite-footer-utility>
      </div></div>
    <devsite-sitemask ds-is="site-mask"></devsite-sitemask>
    <devsite-snackbar ds-is="snackbar"                       ></devsite-snackbar>    <devsite-tooltip ds-is="tooltip"
                     blocked-link></devsite-tooltip>
    <devsite-analytics ds-is="analytics">
              <script type="application/json" analytics>[{"metrics": {"ratings_value": "metric1", "ratings_count": "metric2"}, "dimensions": {}, "gaid": "UA-45455297-4"}]</script>
<script type="application/json" gtm>[]</script>
          </devsite-analytics>
    <script>
    (function(d,e,v,E,l,o,p,r,s,_,__){d['GoogleDevelopersObject']=[!0,l,o,p,r,s];
    _=e.createElement(v);_.async=1;_.src=E;__=e.getElementsByTagName(v)[0];
    __.parentNode.insertBefore(_,__);})(window, document, 'script',
      'https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/js/app_loader.js',
      'en',
      'https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/js/devsite_app.js',
      'https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource',
      !1,
      ['/_pwa/androidsource/manifest.json',
       'https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/images/video-placeholder.svg',
       'https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/images/favicon.png','https://www.gstatic.com/devrel-devsite/v804714fbf31610f6bd494c83c2b0ed270c7475db2947bab1f550f430dad1ed36/androidsource/images/lockup.svg','https://fonts.googleapis.com/css?family=Roboto:300,400,400italic,500,500italic,700,700italic|Roboto+Mono:400,500,700|Material+Icons'],
       'https://androidsource-dot-google-developers.gonglchuangl.net/')
   </script>  </body>

<!-- Mirrored from source.android.google.cn/devices/audio/debugging.html by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 16 Mar 2019 14:31:45 GMT -->
</html>